<!doctype html>
<html lang="en">
<head>
  <title>Oriøn Assistant</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=0">
  <style>
    @font-face { font-family: Name; src: url('Data/Fonts/Name.ttf'); }
    @font-face { font-family: Main; src: url('Data/Fonts/Main.ttf'); }
    @font-face { font-family: Special; src: url('Data/Fonts/Special.ttf'); }
  
    html {
      height: 100%;
      width: 100%;
      background: #000;
      scroll-behavior: smooth;
      color: var(--textPrimary);
      font-family: Main;
  
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    
    body {
      height: 100%; 
      width: 100%; 
      margin: 0; 
      padding: 0;
      overflow: hidden;

      /*THEME*/
      --menu: transparent;
      --background: transparent;
      --scrollbar: transparent;
      --selection: transparent;
      /*TEXT*/
      --textAppName: transparent;
      --textPrimary: transparent;
      --textSecondary: transparent;
      /*SHADOWS*/
      --shadow: rgba(0, 0, 0, 0.16) 0px 1px 4px;
      --shadowBig: rgba(0, 0, 0, 0.16) 0px 10px 36px 0px, rgba(126, 126, 126, 0.2) 0px 0px 0px 1px;
      /*STORE*/
      --searching: #C7C9CA;
      --positive: #00d12d;
      --negative: #C70039;
      /*TITLE BAR BUTTONS*/
      --topText: transparent;
      --topHover: transparent;
      --topExitHover: transparent;
      /*MODULE*/
      --module: transparent;
      --moduleImageFilter: brightness(100%); /*https://angel-rs.github.io/css-color-filter-generator/*/
      --moduleCornerRadius: 0px;
      /*BUTTON*/
      --button: transparent;
      --buttonHover: transparent;
      --buttonBorder: transparent;
      --buttonCornerRadius: 0px;
      /*RADIO*/
      --radio: transparent;
      /*SWITCH*/
      --switchUnchecked: transparent;
      --switchChecked: transparent;
    }

    img {
      -webkit-user-drag: none;
    }

    ::selection {
      background: var(--selection);
    }
    
    /*CONTAINERS*/
    .hc {
      display: flex;
      flex-direction: row;
    }

    .vc {
      display: flex;
      flex-direction: column;
    }
    
    /*SCROLLBAR*/
    ::-webkit-scrollbar {
      width: 14px;
      height: 14px;
    }	

    ::-webkit-scrollbar-thumb {
      background: var(--scrollbar);
      border: solid 4px transparent;
      border-radius: 7px;
      background-clip: content-box;
    }

    ::-webkit-scrollbar-thumb:hover {
      border: solid 3px transparent;
    }

    .invisible-scrollbar {
      overflow-x: hidden;
      overflow-y: scroll;
    }

    .invisible-scrollbar::-webkit-scrollbar {
      width: 0;
      height: 0;
    }
  
    /*MINI MAXI CLOSE BUTTONS*/
    .button-top {
      width: 30px; 
      height: 20px; 
      transition: all .2s, width 0s;
      overflow: hidden;
      line-height: 20px;
      font-size: 12px; 
      text-align: center;
      font-family: Arial, Helvetica, sans-serif;
      color: var(--topText);
      background: transparent;
    }
  
    .button-top:hover {
      background: var(--topHover);
    }

    .button-exit:hover {
      background: var(--topExitHover);
    }
  
    /*UP ANIMATION BUTTON*/
    .button-elevated {
      transition: transform .2s;
    }
  
    .button-elevated:hover {
      transform: translateY(-3px);
    }

    /*MODULE*/
    .module {
      width: 60px;
      height: 60px;
      position: relative;
      color: var(--textPrimary);
    }
    
    .module div:nth-of-type(2) {
      width: inherit;
      height: inherit;
      transition: all .2s;
      background: transparent;
      border-radius: var(--moduleCornerRadius);
    }

    .module div:nth-of-type(2) img {
      width: 26px;
      height: 26px;
      margin: 17px;
      filter: var(--moduleImageFilter);
      pointer-events: none;
      object-fit: contain;
    }

    .module div:nth-of-type(1) {
      width: min-content;
      height: fit-content;
      margin-top: 5px;
      position: absolute;
      padding: 5px;
      opacity: 0;
      z-index: 999;
      pointer-events: none;
      font-size: 14px;
      color: inherit;
      background: var(--module);
      border-radius: var(--moduleCornerRadius);
      box-shadow: var(--shadow);
      transition: all 0s;
      transition-delay: 0s;
    }

    .module input {
      width: 60px;
      height: 60px;
      margin: 0;
      position: absolute;
      opacity: 0;
    }

    .module input:checked ~ div:nth-of-type(2) {
      background: var(--module);
      box-shadow: var(--shadow);
    }

    .module input:hover ~ div:nth-of-type(2) {
      background: var(--module);
      box-shadow: var(--shadow);
    }

    .module input:hover ~ div:nth-of-type(1) {
      opacity: 1;
      transition: all .2s;
      transition-delay: 1s;
    }

    /*BUTTON*/
    .button {
      transition: all .2s;
      overflow: hidden;
      color: var(--textPrimary);
      fill: var(--textPrimary);
      background: var(--button);
      outline: var(--buttonBorder);
      outline-offset: -1px;
      border-radius: var(--buttonCornerRadius);
      box-shadow: var(--shadow);
    }
  
    .button:hover {
      background: var(--buttonHover);
    }

    /*BUTTON TEXT*/
    .buttonText {
      font-size: 15px;
      line-height: 40px;
      text-align: center;
      white-space: nowrap;
      text-overflow: ellipsis;
      font-family: Main;
      color: var(--textPrimary);
    }

    .buttonEmoteText {
      font-size: 20px;
      line-height: 40px;
      text-align: center;
      white-space: nowrap;
      text-overflow: ellipsis;
      font-family: Arial, Monospaced;
      color: var(--textPrimary);
      text-shadow: rgba(0, 0, 0, 0.16) 0px 1px 4px;
    }

    .buttonSVG {
      width: 26px;
      height: 26px; 
      margin: 7px;
    }
    
    /*INPUT TEXT*/
    .input {
      height: 40px;
      padding-top: 0;
      padding-bottom: 0;
      padding-left: 10px;
      padding-right: 10px;
      font-size: 15px;
      line-height: 40px;
      font-family: Main;
      color: inherit;
      background: transparent;
      border: 0;
    }
  
    .input::placeholder {
      color: var(--textSecondary);
    }
  
    .input:focus {
      outline: none;
    }

    /*RADIO*/
    .radio {
      width: 30px;
      height: 30px;
      margin-top: 5px;
      margin-bottom: 5px;
      position: relative;
      border-radius: 15px;
    }

    .radio input {
      width: inherit;
      height: inherit;
      margin: 0;
      position: absolute;
      opacity: 0;
    }

    .radio div {
      width: 10px;
      height: 10px;
      margin: 10px;
      transition: all .2s;
      background: var(--radio);
      pointer-events: none;
      border-radius: 5px;
      opacity: 0;
    }

    .radio input:checked ~ div {
      opacity: 1;
    }

    /*SWITCH*/
    .switch {
      width: 50px;
      height: 30px;
      margin-top: 5px;
      margin-bottom: 5px;
      position: relative;
      border-radius: 15px;
    }

    .switch input {
      width: inherit;
      height: inherit;
      margin: 0;
      position: absolute;
      opacity: 0;
    }

    .switch div {
      width: 10px;
      height: 10px;
      margin: 10px;
      transition: all .2s;
      background: var(--switchUnchecked); 
      pointer-events: none;
      border-radius: 5px;
    }

    .switch input:checked ~ div {
      transform: translate3d(200%, 0, 0);
      background: var(--switchChecked);
    }

    /*SWITCH EMOTE*/
    .switch-custom {
      width: 80px;
      height: 40px;
      transition: all .2s;
      position: relative;
      display: flex;
    }

    .switch-custom input {
      width: inherit;
      height: inherit;
      position: absolute;
      opacity: 0;
    }

    .switch-custom div:nth-of-type(1) {
      height: calc(100% - 10px);
      width: calc(50% - 10px);
      margin: 5px;
      position: relative;
      transition: all .2s;
      background: var(--switchUnchecked);
      border-radius: inherit;
    }

    .switch-custom input:checked ~ div:nth-of-type(1) {
      transform: translateX(calc(100% + 10px));
    }

    .switch-custom div {
      height: inherit;
      width: 50%;
      position: absolute;
      pointer-events: none;
    }

    .switch-custom div:nth-of-type(3) {
      height: inherit;
      width: 50%;
      pointer-events: none;
      transform: translateX(100%);
    }
  </style>
</head>

<div id="themeDiv" style="display: none;"></div>

<body class="vc">
  <div style="width: 100%; height: 100%; background: var(--menu);">
    <div class="hc" style="width: 100%; height: 20px;">
      <div id="menuButton" class="button-top">☰</div>
      <div id="nameDisplay" style="width: 100%; height: 20px; top: 0; left: 0; position: absolute; text-align: center; font-family: Name; color: var(--textAppName); pointer-events: none;">Oriøn Assistant</div>
      <div style="flex-grow: 1; height: 15px; margin: 5px 0 0 5px; -webkit-app-region: drag;"></div>
      <div class="hc">
        <div id="mini" class="button-top">‒</div>
        <div id="maxi" class="button-top">☐</div>
        <div id="exit" class="button-top button-exit">✕</div>
      </div>
    </div>
    
    <div class="hc" style="width: 100%; height: calc(100% - 20px); position: relative;">
      <div id="wall" style="width: 100%; height: 100%; position: absolute; display: none; z-index: 99999;"></div>
  
      <div id="menu" class="vc" style="width: 0; padding-bottom: 15px; align-items: center; position: relative; overflow-x: hidden;">
        <div class="vc invisible-scrollbar" style="width: 100%; flex-grow: 1; align-items: center;">
          <img id="logo" class="button-elevated" style="width: 70px; min-height: 60px; max-height: 60px; margin-top: 3px; object-fit: contain;" src="Data/Images/logo.png"/>
          <div id="moduleButtons" class="vc" style="width: 100%; padding: 10px 0; align-items: center; gap: 10px;">

          </div>
        </div>
        <div style="width: 100%; min-height: 10px; margin-top: -10px; z-index: 999; background: linear-gradient(transparent, var(--menu)); pointer-events: none;"></div>
        <div id="settings" class="module">
          <input id="check-settings" type="radio" name="module">
          <div>Settings</div>
          <div>
            <img src="./Modules/Settings/icon.png"></img>
          </div>
        </div>
      </div>
  
      <div id="windowBackground" class="vc" style="flex-grow: 1; height: 100%; background: var(--background); border-top-left-radius: 15px; overflow-y: auto;">
        <div id="window" class="vc" style="flex-grow: 1; overflow-anchor: none;"></div>
        <div id="start" style="display: none;"></div>
      </div>
    </div>
  
    <div id="noti" class="button vc" style="width: 230px; padding: 15px; bottom: 20px; right: 20px; position: fixed; pointer-events: none; opacity: 0;">
      <div id="notiTitle" style="width: 200px; margin-bottom: 15px; font-size: 16px; line-height: normal; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical;">Title:</div>
      <div id="notiText" style="width: 180px; margin-left: 20px; font-size: 15px; line-height: normal; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical;">Text</div>
    </div>
  </div>
</body>

<script>
  const { ipcRenderer, shell } = require('electron')
  const { app, Menu, MenuItem } = require('@electron/remote')
  window.$ = window.jQuery = require('jquery')
  const fs = require('fs')

  //DATA
  let dataLoaded = false
  let win = null
  let data = {} //root, data, zip, modules (folder paths)
  let json = null
  let loading = false
  let currentModule = ''
  let moduleTmp = {}
  //NOTIS
  let notisShowing = false
  let notisTitle = []
  let notisContent = []
  let notisTitleOld = []
  let notisContentOld = []

  startAssistant()
  setbuttons()

  function startAssistant() {
    win = require('@electron/remote').getCurrentWindow()

    ipcRenderer.on('theme', (event) => {
      $("#themeDiv").load('Data\\theme.html', function(){
        win.setOpacity(1)
      })
    })

    ipcRenderer.on('data', (event, argData) => {
      if (dataLoaded) return
      else dataLoaded = true
      data = argData

      //ADD MODULES
      addModules(true)
      updateModules(true)

      //SHOW MENU
      refreshData()
      if (json.showMenu == undefined) {
        json.showMenu == true
        setData('showMenu', true)
      }
      if (json.showMenu) {
        document.getElementById('menuButton').style.width = '0'
        document.getElementById('menu').style.minWidth = '90px'
        document.getElementById('windowBackground').style.borderTopLeftRadius = '15px'
      } else {
        document.getElementById('menuButton').style.width = '30px'
        document.getElementById('menu').style.minWidth = '0'
        document.getElementById('windowBackground').style.borderTopLeftRadius = '0'
      }
    })

    ipcRenderer.on('loadModule', (event, path, specialData) => {
      if (currentModule != '')
        loadModule(path, specialData)
      else {
        moduleTmp.path = path
        moduleTmp.specialData = specialData
      }
    })

    ipcRenderer.on('noti', (event, title, text) => {
      createNoti(title, text)
    })

    ipcRenderer.on('pause', (event) => {
      document.getElementById('wall').style.display = 'block'
    })

    ipcRenderer.on('resume', (event) => {
      document.getElementById('wall').style.display = 'none'
    })
  }

  function setbuttons() {
    $(window).unbind()
    $('*').unbind()

    //MENU
    addButtonListener('logo', function() {
      $('#menuButton').animate({width: '30px'}, 300)
      $('#menu').animate({minWidth: '0'}, 300)
      $('#windowBackground').animate({borderTopLeftRadius: '0'}, 300)

      setData('showMenu', false)
    })

    addButtonListener('menuButton', function() {
      $('#menuButton').animate({width: '0'}, 300)
      $('#menu').animate({minWidth: '90px'}, 300)
      $('#windowBackground').animate({borderTopLeftRadius: '15px'}, 300)

      setData('showMenu', true)
    })

    //MINI
    addButtonListener('mini', function() {
      win.minimize()
    })

    //MAXI
    addButtonListener('maxi', function() {
      if (!win.isMaximized()) {
        win.maximize()
      } else {
        win.unmaximize()
      }
    })

    //EXIT
    addButtonListener('exit', function() {
      win.close()
    })

    //SETTINGS
    addButtonListener('settings', function() {
      loadModule(data.modules+'Settings')
    })
  }

  //MODULE FUNCTIONS
  function addModules(loadStart) {
    //MODULES
    if (!fs.existsSync(data.modules)) return
    document.getElementById('moduleButtons').innerHTML = ''
    let modulestmp = fs.readdirSync(data.modules)
    //REMOVE SETTINGS
    if (modulestmp.includes('Settings'))
      modulestmp.splice(modulestmp.indexOf('Settings'), 1)
    //PRIORITY MODULES
    let modules = []
    if (modulestmp.includes('Store')) {
      modules.push('Store')
      modulestmp.splice(modulestmp.indexOf('Store'), 1)
    } if (modulestmp.includes('Library')) {
      modules.push('Library')
      modulestmp.splice(modulestmp.indexOf('Library'), 1)
    } if (modulestmp.includes('Themes')) {
      modules.push('Themes')
      modulestmp.splice(modulestmp.indexOf('Themes'), 1)
    }
    for(i in modulestmp) 
      modules.push(modulestmp[i])
    //ADD MODULES
    for(i in modules) {
      //DATA
      let name = modules[i]
      let path = data.modules+name
      if (fs.existsSync(path+'/hidden')) continue
      let id = 'module-'+name.replaceAll(' ', '-')
      let image = 'Data/Images/module.png'
      if (fs.existsSync(path+'/icon.png')) image = 'Modules/'+name+'/icon.png'
      let html = `<div id="${id}" class="module">
                    <input id="check-${id}" type="radio" name="module">
                    <div id="name-${id}">${name}</div>
                    <div>
                      <img src="${image}"></img>
                      <div id="path-${id}" style="display: none;">${path}</div>
                    </div>
                  </div>`
      //ADD MODULE
      document.getElementById('moduleButtons').insertAdjacentHTML('beforeend', html)
      //LOAD MODULE START.HTML
      if (loadStart) {
        let startHTML = path+'\\start.html'
        if (fs.existsSync(startHTML)) {
          $("#start").load(startHTML.replaceAll(' ', '%20'), function () {})
        }
      }
    }
  }

  function updateModules(justStarted) {
    if (moduleTmp.path != undefined) justStarted = false
    else if (justStarted == undefined) justStarted = true
    //GET MODULES
    let children = document.getElementById('moduleButtons').childNodes
    children.forEach(function(item){
      const id = item.id
      //UPDATE MODULE
      let path = document.getElementById('path-'+id).innerHTML
      addCheckboxListener('check-'+id, function() {
        loadModule(path)
      }, null)
      //IF JUST STARTED & IS LIBRARY OPEN
      if (justStarted && path.endsWith('Modules\\Library') && currentModule == '' && children.length > 0) {
        document.getElementById('check-'+id).click()
        justStarted = false
      }
    })
    //IF JUST STARTED & LIBRARY DIDN'T OPEN THE FIRST MODULE
    if (justStarted)
      document.getElementById('check-'+document.getElementById('moduleButtons').firstChild.id).click()
    //LOAD TMP MODULE
    if (moduleTmp.path != undefined) {
      loadModule(moduleTmp.path, moduleTmp.specialData)
      moduleTmp = {}
    }
  }

  function loadModule(path, specialData) {
    if (loading) return
    //CHECK IF MODULE EXISTS
    if (!path.endsWith('\\')) path = path+'\\'
    let html = path+'main.html'
    if (!fs.existsSync(html)) {
      createNoti("Message:", "Module Does not Exist")
      return
    }
    if (currentModule == path) return
    else currentModule = path
    //DISABLE MODULES
    let children = document.getElementById('moduleButtons').childNodes
    children.forEach(function(item){
      let id = item.id
      document.getElementById('check-'+id).disabled = true
    })
    document.getElementById('check-settings').disabled = true
    //LOADING STATE
    loading = true
    //CHECK RADIO BUTTON
    let name = path.substring(0, path.length-1)
    name = name.substring(name.lastIndexOf('\\')+1, name.length)
    if (name == 'Settings') 
      document.getElementById('check-settings').checked = true
    else {
      children.forEach(function(item){
        let id = item.id
        if (document.getElementById('name-'+id) != null)
          if (document.getElementById('name-'+id).innerHTML == name)
            document.getElementById('check-'+id).checked = true
      })
    }
    //LOAD
    setbuttons()
    ipcRenderer.removeAllListeners()
    $("#window").fadeOut(200, function() {
      document.getElementById('windowBackground').scrollTop = 0
      document.getElementById('windowBackground').style.overflowY = 'auto'
      $("#window").load(html.replaceAll(' ', '%20'), function () {
        $("#window").fadeIn(200)
        ipcRenderer.send('loaded', path)
        ipcRenderer.send('specialData', specialData)
        updateModules(true)
        startAssistant()
        setTimeout(function() {
          loading = false
          //ENABLE MODULES
          children.forEach(function(item){
            let id = item.id
            document.getElementById('check-'+id).disabled = false
          })
          document.getElementById('check-settings').disabled = false
        }, 200);
      })
    })
  }

  //DATA FUNCTIONS
  function refreshData() {
  let jsonPath = data.data+'settings.json'
  if (fs.existsSync(jsonPath)) 
    json = JSON.parse(fs.readFileSync(jsonPath))
  else {
    json = {}
    fs.writeFile(jsonPath, '{}', function(err) {if (err) console.log(err)})
  }
}

  function setData(key, value) {
    refreshData()
    json[key] = value
    fs.writeFileSync(data.data+'settings.json', JSON.stringify(json))
  }

  //NOTI
  function createNoti(title, content) {
    notisTitle.push(title)
    notisContent.push(content)
    notisTitleOld.push(title)
    notisContentOld.push(content)
    if (!notisShowing) notiAdmin()
  }

  function notiAdmin() {
    n1()

    function n1() { 
      if (notisTitle.length > 0) {
        notisShowing = true
        n2()
      } else notisShowing = false
    }

    function n2() { 
      let title = notisTitle[0]
      let content = notisContent[0]
      notisTitle.shift()
      notisContent.shift()

      document.getElementById('notiTitle').innerHTML = title
      document.getElementById('notiText').innerHTML = content
      $( "#noti" ).fadeTo( "fast" , 1, function() {
        setTimeout(function() {
          $( "#noti" ).fadeTo( "fast" , 0)
        }, 1500)
      })
      
      setTimeout(function() {
        n1()
      }, 2500)
    }
  }

  //BUTTON LISTENERS
  function addButtonListener(id, click) {
    $('#'+id).bind('click', function() {
      if (event.which != 1) return
      click()
    })
  }

  function addCustomButtonListener(id, mousedown, mouseup, click) {
    $('#'+id).bind('mousedown', function() {
      if (event.which != 1) return
      mousedown()
    })

    $(window).bind('mouseup', function() {
      if (event.which != 1) return
      mouseup()
    })

    $('#'+id).bind('click', function() {
      if (event.which != 1) return
      click()
    })
  }

  function addRightButtonListener(id, click) {
    $('#'+id).bind('contextmenu', function() {
      if (event.which != 3) return
      click()
    })
  }
  
  function addCheckboxListener(id, checked, unchecked) {
    $('#'+id).bind('change', function() {
      if (this.checked)
        checked()
      else 
        unchecked()
    })
  }
</script>
</html>