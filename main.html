<!doctype html>
<html>
<head>
  <title id="headTitle">Oriøn Assistant</title>
  <!-- Assistant -->
  <link rel="stylesheet" href="orion-assistant.css">
  <script src="orion-assistant.js"></script>
  <!-- Framework -->
  <link rel="stylesheet" href="orion-framework.css">
  <script src="orion-framework.js"></script>
  <!-- Theme -->
  <link rel="stylesheet" href="Data/theme.css">
  <script src="Data/theme.js"></script>
</head>





<body class="vc">
  <div class="topBar">
    <div id="topName" class="topTitle">Oriøn Assistant</div>
    <div class="topDrag"></div>
    <div id="topMini" class="topButton">—</div>
    <div id="topMaxi" class="topButton">☐</div>
    <div id="topExit" class="topButton topButtonExit">✕</div>
  </div>
  
  <div class="hc" style="width: 100%; height: calc(100% - 45px); position: relative; overflow: hidden;">
    <div id="wall" style="width: 100vw; height: 100vh; position: absolute; display: none; z-index: 99999;"></div>

    <div id="userMenuContainer" class="userMenuContainer" style="width: 100%; height: 100%; position: absolute;">
      <div id="userMenu" class="userMenu" onclick="event.stopPropagation()">
        <span id="userUsername">Sign In</span>
        <span id="userLine" style="cursor: auto; height: 5px; background: var(--text2); border-radius: 5px; opacity: .2;"></span>
        <span id="userEdit" style="display: none;">Edit Profile</span>
        <span id="userSettings">Settings</span>
        <span id="userBackup" style="display: none;">Cloud Save</span>
        <span id="userLogout" style="display: none;">Log Out</span>
      </div>
      <svg class="userMenuTriangle" viewBox="0 0 24 24" > 
        <path class="st0" d="M10,7c-4.3,5.7-4,12.3-9,15c-0.5,0.3-1.4,0.7-2.6,0.8c-1.5,1.5-3,2.9-4.6,4.4c12.3,0,24.6,0,36.9-0.1c-2.2-1.4-4.4-2.8-6.7-4.1c-0.2-0.2-0.6-0.5-1-1c-4.5-4.9-5.7-11.4-9-15c-0.4-0.5-1.2-1.2-2.1-1.2C11,5.9,10.3,6.6,10,7z"/>
      </svg>
    </div>

    <div id="menu" class="menu">
      <img id="menuLogo" class="menuLogo" src="Data/Images/logo.png" onclick="toggleLeftMenu()">
      <div id="menuModules" class="menuModules"></div>
      <div id="menuUser" class="menuUser" oncontextmenu="loadModule('Settings')">
        <img id="userPhoto">
        <div id="userStatus"></div>
      </div>
    </div>  
    
    <div id="windowBg" class="win-b">
      <div id="window" class="win-w">
 
      </div>
    </div>
  </div>
</body>





<script>
   /*$    /$$                             
  | $$   | $$                             
  | $$   | $$ /$$$$$$   /$$$$$$   /$$$$$$$
  |  $$ / $$/|____  $$ /$$__  $$ /$$_____/
   \  $$ $$/  /$$$$$$$| $$  \__/|  $$$$$$ 
    \  $$$/  /$$__  $$| $$       \____  $$
     \  $/  |  $$$$$$$| $$       /$$$$$$$/
      \_/    \_______/|__/      |______*/ 

  let main = {}
  let mainLoaded = false
  let loadingModule = false
  
  
   /*$$$$$$$                              /$$     /$$                              
  | $$_____/                             | $$    |__/                              
  | $$    /$$   /$$ /$$$$$$$   /$$$$$$$ /$$$$$$   /$$  /$$$$$$  /$$$$$$$   /$$$$$$$
  | $$$$$| $$  | $$| $$__  $$ /$$_____/|_  $$_/  | $$ /$$__  $$| $$__  $$ /$$_____/
  | $$__/| $$  | $$| $$  \ $$| $$        | $$    | $$| $$  \ $$| $$  \ $$|  $$$$$$ 
  | $$   | $$  | $$| $$  | $$| $$        | $$ /$$| $$| $$  | $$| $$  | $$ \____  $$
  | $$   |  $$$$$$/| $$  | $$|  $$$$$$$  |  $$$$/| $$|  $$$$$$/| $$  | $$ /$$$$$$$/
  |__/    \______/ |__/  |__/ \_______/   \___/  |__/ \______/ |__/  |__/|______*/ 

  //Reset listeners
  function resetListeners() {
    //Remove all
    $(window).off()
    $('#window *').off()
    ipcRenderer.removeAllListeners()

    //Add load listener
    if (!mainLoaded) {
      ipcRenderer.once('load', (event, _orion) => {
        //Mark as loaded
        mainLoaded = true

        //Update data
        orion = _orion

        //Get main key
        main = getKey('main')
        if (typeof main !== 'object') {
          main = { 
            menu: false,
            visible: ['Store', 'Themes']
          }
          setKey('main', main)
        }

        //Menu
        if (!main.menu) {
          document.body.style.setProperty('--menuSize', '100px')
          document.getElementById('menuLogo').src = 'Data/Images/logo.png'
        } else {
          document.body.style.setProperty('--menuSize', 'clamp(150px, 20vw, 250px)')
          document.getElementById('menuLogo').src = 'Data/Images/logoLarge.png'
        }
        
        //Add modules
        updateModules(true)
      })
    }

    //Add tag callbacks
    for (const [key, value] of Object.entries(tagCallbacks)) ipcRenderer.on(key, value)

    //Add assistant listeners
    ipcRenderer.on('loadModule', (event, name, specialData) => {
      if (typeof cModule.name !== 'string') {
        tModule = {
          name: name,
          specialData: specialData
        }
      } else {
        loadModule(name, specialData)
      }
    })

    ipcRenderer.on('noti', (event, title, text) => { createNoti(title, text) })

    ipcRenderer.on('pause', (event) => { document.getElementById('wall').style.display = 'block' })

    ipcRenderer.on('resume', (event) => { document.getElementById('wall').style.display = 'none' })
  }

  //Left menu
  function toggleLeftMenu(open) {
    //Fix args
    if (typeof open !== 'boolean') open = !Boolean(main.menu)
    const isOpen = (document.body.style.getPropertyValue('--menuSize') != '100px')

    //Prepare
    document.getElementById('menu').style.transition = 'width .3s'
    document.getElementById('windowBg').style.transition = 'width .3s'
    let modules = document.getElementById('menuModules').childNodes
    
    //Toggle left pane
    if (!open && isOpen) {
      main.menu = false
      document.body.style.setProperty('--menuSize', '100px')
      modules.forEach(function(item) { document.getElementById(item.id).setAttribute('ball', '') })
      document.getElementById('menuLogo').style.transition = 'opacity .15s, filter .15s'
      document.getElementById('menuLogo').style.filter = 'blur(8px)'
      document.getElementById('menuLogo').style.opacity = 0
      setTimeout(() => { 
        document.getElementById('menuLogo').style.transition = 'opacity .25s'
        document.getElementById('menuLogo').src = 'Data/Images/logo.png'
        document.getElementById('menuLogo').style.opacity = 1
        document.getElementById('menuLogo').style.filter = ''
      }, 200)
    } else if (open && !isOpen) {
      main.menu = true
      document.body.style.setProperty('--menuSize', 'clamp(150px, 20vw, 250px)')
      modules.forEach(function(item) { document.getElementById(item.id).removeAttribute('ball') })
      document.getElementById('menuLogo').style.transition = 'opacity .15s, filter .15s'
      document.getElementById('menuLogo').style.filter = 'blur(8px)'
      document.getElementById('menuLogo').style.opacity = 0
      setTimeout(() => { 
        document.getElementById('menuLogo').style.transition = 'opacity .25s'
        document.getElementById('menuLogo').src = 'Data/Images/logoLarge.png'
        document.getElementById('menuLogo').style.opacity = 1
        document.getElementById('menuLogo').style.filter = ''
      }, 200)
    }
    setKey('main', main)
  }

  //User menu
  function toggleUserMenu() {
    //Get elements
    const menuC = document.getElementById('userMenuContainer')
    const menu = document.getElementById('userMenu')

    //Toggle menu
    if (menuC.style.opacity == '1') {
      menuC.style.opacity = '0'
      menu.style.pointerEvents = 'none'
      window.removeEventListener('click', toggleUserMenu)
      window.removeEventListener('contextmenu', toggleUserMenu)
    } else {
      menuC.style.opacity = '1'
      menu.style.pointerEvents = 'all'
      window.addEventListener('click', toggleUserMenu)
      window.addEventListener('contextmenu', toggleUserMenu)
    }
  }

  //Module functions
  function updateModules(firstLoad) {
    //Fix data
    if (typeof loadStart !== 'boolean') loadStart = false
    if (typeof loadMod !== 'boolean') loadMod = false
    if (!Array.isArray(main.visible)) {
      main.visible = ['Store', 'Themes']
      setKey('main', main)
    }

    //Get module names
    if (!fs.existsSync(orion.modules)) return
    let modulesTmp = fs.readdirSync(orion.modules)

    //Priority modules go first
    moduleNames = [] 
    if (modulesTmp.includes('Library')) {
      moduleNames.push('Library')
      modulesTmp.splice(modulesTmp.indexOf('Library'), 1)
    } if (modulesTmp.includes('Store')) {
      moduleNames.push('Store')
      modulesTmp.splice(modulesTmp.indexOf('Store'), 1)
    } if (modulesTmp.includes('Themes')) {
      moduleNames.push('Themes')
      modulesTmp.splice(modulesTmp.indexOf('Themes'), 1)
    }
    for (i in modulesTmp) moduleNames.push(modulesTmp[i])

    //Create module objects
    modules = []
    moduleNames.forEach(name => {
      //Create module
      let mod = {
        name: name,
        path: orion.modules + name + '\\',
      }

      //Check if it has main.html
      mod.mainPath = mod.path + 'main.html'
      mod.main = fs.existsSync(mod.mainPath)

      //Check if it has start.js
      mod.startPath = mod.path + 'start.js'
      mod.start = fs.existsSync(mod.startPath)

      //Other
      mod.key = name.replaceAll(' ', '-')
      mod.icon = (fs.existsSync(mod.path + 'icon.png') ? 'Modules/' + name + '/icon.png' : 'Data/Images/module.png')
      mod.hidden = !(main.visible.includes(name) || name == 'Library')

      //Add module to list
      modules.push(mod)
    })

    //Load start file
    if (firstLoad) {
      //Temp functions
      function nextStart() {
        i++
        if (i < modules.length) loadStart()
      }

      function loadStart() {
        //Get module
        let mod = modules[i]
        
        //Check for start file
        if (mod.start) {
          //Load start file
          sModule = {
            name: mod.name,
            path: mod.path,
            hidden: mod.hidden
          }
          $.getScript(mod.startPath, nextStart)
        } else {
          //Skip
          nextStart()
        }
      }

      //Start loading
      let i = -1
      nextStart()
    }

    //Add modules
    refreshModules()

    //Load module
    if (firstLoad) {
      if (tModule.name != undefined) {
        //Load tmp module
        loadModule(tModule.name, tModule.specialData)
        tModule = {}
      } else if (modules.length != 0){
        //Load first module
        loadModule(modules[0].name)
      }
    }
  }

  function refreshModules() {
    document.getElementById('menuModules').innerHTML = ''
    modules.forEach(mod => {
      //Add module if it's not settings & it isn't hidden
      if (mod.name != 'Settings' && !mod.hidden) {
        let id = 'module-' + mod.key
        let html = `<o-rbutton id="${id}" icon="${mod.icon}" text="${mod.name}" title="${mod.name}" module ${main.menu ? '' : 'ball'}></o-rbutton>`

        //Add module
        document.getElementById('menuModules').insertAdjacentHTML('beforeend', html)

        //Add listeners
        clickListener(id, () => { loadModule(mod.name) })
        contextListener(id, () => { contextModule(mod.name) })
      }
    })
  }

  function loadModule(name, specialData, force) {
    //Already loading a module
    if (loadingModule) return

    //Get module
    let mod = getModule(name)
    if (mod == undefined) {
      createNoti("Oriøn Assistant", `'${name.substring(name.lastIndexOf('\\') + 1, name.length)}' can't be loaded`)
      return
    }

    //Module already loaded
    if (mod.name == cModule.name && !force) return

    //Update current module
    cModule = {
      path: mod.path,
      name: mod.name,
      hidden: mod.hidden
    }

    //Check current module element
    let modules = document.getElementById('menuModules').childNodes
    modules.forEach(function(item) { document.getElementById(item.id).removeAttribute('checked') })
    if (mod.name != 'Settings') {
      modules.forEach(function(item) { 
        if (mod.name == item.text)
          document.getElementById(item.id).setAttribute('checked', '')
      })
    }

    //Load module
    loadingModule = true
    $('#window').fadeOut(200, function() {
      resetListeners()
      document.getElementById('window').style = ''
      document.getElementById('window').scrollTop = 0
      $('#window').fadeOut(0)
      $('#window').load(mod.mainPath.replaceAll(' ', '%20'), () => {
        sendSpecialData(specialData)
        renameWindow(document.getElementById('headTitle').innerHTML)
        $('#window').fadeIn(200, () => { loadingModule = false })
      })
    })
  }

  function contextModule(name) {
    //Get module
    let mod = getModule(name)
    if (mod == undefined) return

    //Create dialog
    let dialogid = createDialog(fs.readFileSync(orion.modules + 'Settings/mainModule.html').toString(), 'Module menu')

    //Prepare dialog
    document.getElementById('modulesTitle').innerHTML = mod.name
    document.getElementById('modulesIcon').src = mod.icon
    document.getElementById('modulesMove').innerHTML = (mod.hidden ? 'Unhide' : 'Hide')
    if (name == 'Library') {
      document.getElementById('modulesMove').style.display = 'none'
      document.getElementById('modulesRemove').style.display = 'none'
    }

    //Dialog listeners
    clickListener('modulesMove', () => {
      //Hide / Unhide
      mod.hidden = !mod.hidden
      if (mod.hidden) 
        main.visible.splice(main.visible.indexOf(name), 1)
      else 
        main.visible.push(name)
      setKey('main', main)

      //Refresh modules & tray
      refreshModules()
      if (cModule.name == 'Settings') modulesList()
      ipcRenderer.send('refreshTray')

      //Close dialog
      closeDialog(dialogid)
    })

    clickListener('modulesRemove', function() {
      document.getElementById('removeTitle').innerHTML = `Remove '${mod.name}'?`
      document.getElementById('modulesWindow').style.display = 'none'
      document.getElementById('removeWindow').style.display = 'flex'
    })

    clickListener('removeRemove', function() {
      //Delete files
      fs.rmSync(mod.path, { recursive: true })

      //Refresh modules & tray
      refreshModules()
      if (cModule.name == 'Settings') modulesList()
      ipcRenderer.send('refreshTray')

      //Close dialog
      closeDialog(dialogid)

      //Recomend restart
      if (typeof mod.startFile == 'string') settingsModsLog = 'Restart is recomended to apply changes'
      document.getElementById('modulesLog').innerHTML = settingsModsLog
    })

    clickListener('removeCancel', function() {
      document.getElementById('modulesWindow').style.display = 'flex'
      document.getElementById('removeWindow').style.display = 'none'
    })

    clickListener('modulesLoad', function() {
      loadModule(mod.name)
      closeDialog(dialogid)
    })
  }

  function getModule(name) {
    for (let i = 0; i < modules.length; i++) {
      if (modules[i].name == name) 
        return modules[i]
    }
  }


   /*$       /$$             /$$                                                      
  | $$      |__/            | $$                                                      
  | $$       /$$  /$$$$$$$ /$$$$$$    /$$$$$$  /$$$$$$$   /$$$$$$   /$$$$$$   /$$$$$$$
  | $$      | $$ /$$_____/|_  $$_/   /$$__  $$| $$__  $$ /$$__  $$ /$$__  $$ /$$_____/
  | $$      | $$|  $$$$$$   | $$    | $$$$$$$$| $$  \ $$| $$$$$$$$| $$  \__/|  $$$$$$ 
  | $$      | $$ \____  $$  | $$ /$$| $$_____/| $$  | $$| $$_____/| $$       \____  $$
  | $$$$$$$$| $$ /$$$$$$$/  |  $$$$/|  $$$$$$$| $$  | $$|  $$$$$$$| $$       /$$$$$$$/
  |________/|__/|_______/    \___/   \_______/|__/  |__/ \_______/|__/      |______*/ 
  
  //Top buttons
  clickListener('topMini', function() {
    win.minimize()
  })

  clickListener('topMaxi', function() {
    if (!win.isMaximized())
      win.maximize()
    else
      win.unmaximize()
  })

  clickListener('topExit', function() {
    win.close()
  })
  

    /*$$$$$                  /$$          
   /$$__  $$                | $$          
  | $$  \__/  /$$$$$$   /$$$$$$$  /$$$$$$ 
  | $$       /$$__  $$ /$$__  $$ /$$__  $$
  | $$      | $$  \ $$| $$  | $$| $$$$$$$$
  | $$    $$| $$  | $$| $$  | $$| $$_____/
  |  $$$$$$/|  $$$$$$/|  $$$$$$$|  $$$$$$$
   \______/  \______/  \_______/ \______*/

  //Reset listeners
  resetListeners()
</script>




<!-- Firebase related code -->
<script type="module">
  import { initializeApp, getApp } from "https://www.gstatic.com/firebasejs/9.8.2/firebase-app.js"
  import { getAuth, updateProfile, updatePassword, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.8.2/firebase-auth.js"
  import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.8.2/firebase-storage.js"
  
  initializeApp({
    apiKey: "AIzaSyB3CLiTYV6ZJY6_TPpvfqPQhd-xmfA0cu8",
    authDomain: "orionassistantpc.firebaseapp.com",
    projectId: "orionassistantpc",
    storageBucket: "orionassistantpc.appspot.com",
    messagingSenderId: "87577099805",
    appId: "1:87577099805:web:be32e75e01246a286190f4",
    measurementId: "G-1J36W704VN"
  })

  let user
  let userFolder
  const storage = getStorage(getApp(), 'gs://orionassistantpc.appspot.com')
  
  login()
  function login() {
    //WAIT FOR DATA TO LOAD
    if (orion.data == undefined) {
      setTimeout(login, 250)
      return
    }

    //CREATE KEYS IF MISSING
    if (!main.email || !main.pass) {
      main.email = ''
      main.pass = ''
      setKey('main', main)
    }

    //LOG IN
    if (main.email != '' && main.pass != '') {
      let decPass = atob(main.pass)
      signInWithEmailAndPassword(getAuth(), main.email, decPass).then((userCredential) => {
        console.log(`Logged in as '${userCredential.user.displayName}'`)
        addUserMenuL()
      }).catch((error) => {
        userError(error.code)
        addUserMenuL()
      })
    } else addUserMenuL()

    //USER MENU LISTENER
    function addUserMenuL() {
      document.getElementById('menuUser').style.opacity = '1'
      checkUser()
      clickListener('menuUser', function() {
        toggleUserMenu()
        event.stopPropagation()
      })
    }
  }

  function checkUser() {
    user = getAuth().currentUser
    if (user) {
      userFolder = `/${user.uid}/`
      //IMAGE
      let image = user.photoURL
      if (typeof image != 'string') image = 'Data/Images/user.png'
      document.getElementById('userPhoto').src = image
      //NAME
      let name = user.displayName
      if (typeof name != 'string') name = 'User'
      document.getElementById('userUsername').innerText = name
      //OTHER
      document.getElementById('userStatus').style.background = 'var(--success)'
      document.getElementById('userEdit').style.display = 'block'
      document.getElementById('userBackup').style.display = 'block'
      document.getElementById('userLogout').style.display = 'block'
    } else {
      userFolder = undefined
      document.getElementById('userPhoto').src = 'Data/Images/user.png'
      document.getElementById('userUsername').innerText = 'Log In'
      document.getElementById('userStatus').style.background = 'var(--danger)'
      document.getElementById('userEdit').style.display = 'none'
      document.getElementById('userBackup').style.display = 'none'
      document.getElementById('userLogout').style.display = 'none'
    }
  }

  let userEasteregg = 0
  clickListener('userUsername', function() {
    if (user) {
      userEasteregg++
      if (userEasteregg > 6) {
        userEasteregg = 0
        createOrionWindow(orion.modules+'Settings/easterSnake.html', undefined, { width: 500, height: 545, isResizable: false })
        toggleUserMenu()
      }
      return
    }
    toggleUserMenu()
    //LOG IN
    const dialogid = createDialog(fs.readFileSync(orion.modules+'Settings/userLogin.html').toString(), 'Log in')

    //PREPARE DIALOG
    const loading = document.getElementById('loginLoading')

    clickListener('loginLogin', function() {
      const email = document.getElementById('loginEmail').value
      const pass = document.getElementById('loginPass').value
      loading.style.opacity = '1'
      signInWithEmailAndPassword(getAuth(), email, pass).then((userCredential) => {
        //ALL GOOD
        main.email = email
        main.pass = btoa(pass)
        setKey('main', main)
        checkUser()
        closeDialog(dialogid)
        createNoti('Settings', 'Logged in successfully')
      }).catch((error) => {
        //LOG IN ERROR
        userError(error.code)
        console.log(error);
        loading.style.opacity = '0'
      })
    })

    clickListener('loginCreate', function() {
      const email = document.getElementById('loginEmail').value
      const pass = document.getElementById('loginPass').value
      loading.style.opacity = '1'
      createUserWithEmailAndPassword(getAuth(), email, pass).then((userCredential) => {
        //ALL GOOD
        main.email = email
        main.pass = pass
        setKey('main', main)
        updateProfile(user, {
          displayName: 'User',
          photoURL: 'Data/Images/user.png'
        }).then(() => {
          //ALL GOOD
          checkUser()
          closeDialog(dialogid)
          createNoti('Settings', 'User created successfully')
        }).catch((error) => {
          //UPDATE USER ERROR
          userError(error.code)
          loading.style.opacity = '0'
        })
      }).catch((error) => {
        //CREATE USER ERROR
        userError(error.code)
        loading.style.opacity = '0'
      })
    })
  
    clickListener('loginPassShow', function() {
      event.stopPropagation()
      const input = document.getElementById('loginPass')
      if (input.type == 'password') {
        input.type = 'text'
        this.innerHTML = `<path d="M21.2714 9.17834C20.9814 8.71834 20.6714 8.28834 20.3514 7.88834C19.9814 7.41834 19.2814 7.37834 18.8614 7.79834L15.8614 10.7983C16.0814 11.4583 16.1214 12.2183 15.9214 13.0083C15.5714 14.4183 14.4314 15.5583 13.0214 15.9083C12.2314 16.1083 11.4714 16.0683 10.8114 15.8483C10.8114 15.8483 9.38141 17.2783 8.35141 18.3083C7.85141 18.8083 8.01141 19.6883 8.68141 19.9483C9.75141 20.3583 10.8614 20.5683 12.0014 20.5683C13.7814 20.5683 15.5114 20.0483 17.0914 19.0783C18.7014 18.0783 20.1514 16.6083 21.3214 14.7383C22.2714 13.2283 22.2214 10.6883 21.2714 9.17834Z"/>
                          <path d="M14.0206 9.98062L9.98062 14.0206C9.47062 13.5006 9.14062 12.7806 9.14062 12.0006C9.14062 10.4306 10.4206 9.14062 12.0006 9.14062C12.7806 9.14062 13.5006 9.47062 14.0206 9.98062Z"/>
                          <path d="M18.25 5.74969L14.86 9.13969C14.13 8.39969 13.12 7.95969 12 7.95969C9.76 7.95969 7.96 9.76969 7.96 11.9997C7.96 13.1197 8.41 14.1297 9.14 14.8597L5.76 18.2497H5.75C4.64 17.3497 3.62 16.1997 2.75 14.8397C1.75 13.2697 1.75 10.7197 2.75 9.14969C3.91 7.32969 5.33 5.89969 6.91 4.91969C8.49 3.95969 10.22 3.42969 12 3.42969C14.23 3.42969 16.39 4.24969 18.25 5.74969Z"/>
                          <path d="M14.8581 11.9981C14.8581 13.5681 13.5781 14.8581 11.9981 14.8581C11.9381 14.8581 11.8881 14.8581 11.8281 14.8381L14.8381 11.8281C14.8581 11.8881 14.8581 11.9381 14.8581 11.9981Z"/>
                          <path d="M21.7689 2.22891C21.4689 1.92891 20.9789 1.92891 20.6789 2.22891L2.22891 20.6889C1.92891 20.9889 1.92891 21.4789 2.22891 21.7789C2.37891 21.9189 2.56891 21.9989 2.76891 21.9989C2.96891 21.9989 3.15891 21.9189 3.30891 21.7689L21.7689 3.30891C22.0789 3.00891 22.0789 2.52891 21.7689 2.22891Z"/>`
      } else {
        input.type = 'password'
        this.innerHTML = `<path d="M21.25 9.14969C18.94 5.51969 15.56 3.42969 12 3.42969C10.22 3.42969 8.49 3.94969 6.91 4.91969C5.33 5.89969 3.91 7.32969 2.75 9.14969C1.75 10.7197 1.75 13.2697 2.75 14.8397C5.06 18.4797 8.44 20.5597 12 20.5597C13.78 20.5597 15.51 20.0397 17.09 19.0697C18.67 18.0897 20.09 16.6597 21.25 14.8397C22.25 13.2797 22.25 10.7197 21.25 9.14969ZM12 16.0397C9.76 16.0397 7.96 14.2297 7.96 11.9997C7.96 9.76969 9.76 7.95969 12 7.95969C14.24 7.95969 16.04 9.76969 16.04 11.9997C16.04 14.2297 14.24 16.0397 12 16.0397Z"/>
                          <path d="M11.9984 9.14062C10.4284 9.14062 9.14844 10.4206 9.14844 12.0006C9.14844 13.5706 10.4284 14.8506 11.9984 14.8506C13.5684 14.8506 14.8584 13.5706 14.8584 12.0006C14.8584 10.4306 13.5684 9.14062 11.9984 9.14062Z"/>`
      }
    })
  })

  clickListener('userEdit', function() {
    if (!user) return
    toggleUserMenu()
    //EDIT PROFILE
    const dialogid = createDialog(fs.readFileSync(orion.modules+'Settings/userEdit.html').toString(), 'Edit profile')

    //PREPARE DIALOG
    const oldName = user.displayName
    if (typeof oldName == 'string') document.getElementById('editName').value = oldName
    document.getElementById('editPfp').src = document.getElementById('userPhoto').src

    clickListener('editSave', function() {
      let nameUpdated = false
      let imageUpdated = false
      let passUpdated = false
      const loading = document.getElementById('editLoading')

      //UPDATE NAME
      const name = document.getElementById('editName').value.trim()
      if (name != '' && name != oldName) {
        loading.style.opacity = '1'
        updateProfile(user, {
          displayName: name
        }).then(() => {
          //ALL GOOD
          nameUpdated = true
          checkClose()
        }).catch((error) => {
          //UPDATE NAME ERROR
          userError(error.code)
          loading.style.opacity = '0'
        })
      } else nameUpdated = true

      //UPDATE IMAGE
      const image = document.getElementById('editImage').value.trim()
      if (image != '' && image != user.photoURL) {
        loading.style.opacity = '1'
        //UPLOAD IMAGE
        if (image.toLowerCase().startsWith('data:image/png;base64,')) { 
          //BASE64 IMAGE
          const imageRef = ref(storage, `/${user.uid}/user.png`)
          const base64 = image.substring(image.indexOf(',')+1)
          uploadString(imageRef, base64, 'base64').then((snapshot) => {
            getDownloadURL(imageRef).then((url) => {
              updateProfile(user, {
                photoURL: url
              }).then(() => {
                //ALL GOOD
                imageUpdated = true
                checkClose()
              }).catch((error) => {
                //UPDATE IMAGE ERROR
                userError(error.code)
                loading.style.opacity = '0'
              })
            }).catch((error) => {
              //GET IMAGE URL ERROR
              userError(error.code)
              loading.style.opacity = '0'
            })
          })
        } else { 
          //NON BASE64 IMAGE
          updateProfile(user, {
            photoURL: image
          }).then(() => {
            //ALL GOOD
            imageUpdated = true
            checkClose()
          }).catch((error) => {
            //UPDATE IMAGE ERROR
            userError(error.code)
            loading.style.opacity = '0'
          })
        }
      } else imageUpdated = true

      //UPDATE PASS
      const pass = document.getElementById('editPass').value.trim()
      if (pass != '') {
        loading.style.opacity = '1'
        updatePassword(user, pass).then(() => {
          //ALL GOOD
          passUpdated = true
          checkClose()
        }).catch((error) => {
          //UPDATE NAME ERROR
          userError(error.code)
          loading.style.opacity = '0'
        })
      } else passUpdated = true

      //CHECK TO CLOSE
      checkClose()
      function checkClose() {
        if (nameUpdated && imageUpdated && passUpdated) {
          checkUser()
          closeDialog(dialogid)
          createNoti('Settings', 'Saved successfully')
        }
      }
    })
  
    clickListener('editImageFolder', function() {
      event.stopPropagation()
      ipcRenderer.send('getFile', 'requestedUserImage', 'Choose an Image')
    })

    ipcRenderer.removeAllListeners('requestedUserImage')
    ipcRenderer.on('requestedUserImage', (event, path) => {
      if (path == '') return
      ipcRenderer.send('getBase64', 'requestedUserBase64', path, path)
    })

    ipcRenderer.removeAllListeners('requestedUserBase64')
    ipcRenderer.on('requestedUserBase64', async function(event, base64, tag) {
      if (base64 == '') {
        document.getElementById('editImage').value = tag
        document.getElementById('editPfp').src = tag
      } else {
        const result = await resizeBase64Image(base64)
        document.getElementById('editImage').value = result
        document.getElementById('editPfp').src = result
      }
    }) 
    
    function refreshPFP() {
      const image = document.getElementById('editImage').value
      if (image != '')
        document.getElementById('editPfp').src = image
      else if (user.photoURL != null) 
        document.getElementById('editPfp').src = user.photoURL
      else 
        document.getElementById('editPfp').src = 'Data/Images/user.png'
    }

    clickListener('editPfp', refreshPFP)

    clickListener('editPassShow', function() {
      event.stopPropagation()
      const input = document.getElementById('editPass')
      if (input.type == 'password') {
        input.type = 'text'
        this.innerHTML = `<path d="M21.2714 9.17834C20.9814 8.71834 20.6714 8.28834 20.3514 7.88834C19.9814 7.41834 19.2814 7.37834 18.8614 7.79834L15.8614 10.7983C16.0814 11.4583 16.1214 12.2183 15.9214 13.0083C15.5714 14.4183 14.4314 15.5583 13.0214 15.9083C12.2314 16.1083 11.4714 16.0683 10.8114 15.8483C10.8114 15.8483 9.38141 17.2783 8.35141 18.3083C7.85141 18.8083 8.01141 19.6883 8.68141 19.9483C9.75141 20.3583 10.8614 20.5683 12.0014 20.5683C13.7814 20.5683 15.5114 20.0483 17.0914 19.0783C18.7014 18.0783 20.1514 16.6083 21.3214 14.7383C22.2714 13.2283 22.2214 10.6883 21.2714 9.17834Z"/>
                          <path d="M14.0206 9.98062L9.98062 14.0206C9.47062 13.5006 9.14062 12.7806 9.14062 12.0006C9.14062 10.4306 10.4206 9.14062 12.0006 9.14062C12.7806 9.14062 13.5006 9.47062 14.0206 9.98062Z"/>
                          <path d="M18.25 5.74969L14.86 9.13969C14.13 8.39969 13.12 7.95969 12 7.95969C9.76 7.95969 7.96 9.76969 7.96 11.9997C7.96 13.1197 8.41 14.1297 9.14 14.8597L5.76 18.2497H5.75C4.64 17.3497 3.62 16.1997 2.75 14.8397C1.75 13.2697 1.75 10.7197 2.75 9.14969C3.91 7.32969 5.33 5.89969 6.91 4.91969C8.49 3.95969 10.22 3.42969 12 3.42969C14.23 3.42969 16.39 4.24969 18.25 5.74969Z"/>
                          <path d="M14.8581 11.9981C14.8581 13.5681 13.5781 14.8581 11.9981 14.8581C11.9381 14.8581 11.8881 14.8581 11.8281 14.8381L14.8381 11.8281C14.8581 11.8881 14.8581 11.9381 14.8581 11.9981Z"/>
                          <path d="M21.7689 2.22891C21.4689 1.92891 20.9789 1.92891 20.6789 2.22891L2.22891 20.6889C1.92891 20.9889 1.92891 21.4789 2.22891 21.7789C2.37891 21.9189 2.56891 21.9989 2.76891 21.9989C2.96891 21.9989 3.15891 21.9189 3.30891 21.7689L21.7689 3.30891C22.0789 3.00891 22.0789 2.52891 21.7689 2.22891Z"/>`
      } else {
        input.type = 'password'
        this.innerHTML = `<path d="M21.25 9.14969C18.94 5.51969 15.56 3.42969 12 3.42969C10.22 3.42969 8.49 3.94969 6.91 4.91969C5.33 5.89969 3.91 7.32969 2.75 9.14969C1.75 10.7197 1.75 13.2697 2.75 14.8397C5.06 18.4797 8.44 20.5597 12 20.5597C13.78 20.5597 15.51 20.0397 17.09 19.0697C18.67 18.0897 20.09 16.6597 21.25 14.8397C22.25 13.2797 22.25 10.7197 21.25 9.14969ZM12 16.0397C9.76 16.0397 7.96 14.2297 7.96 11.9997C7.96 9.76969 9.76 7.95969 12 7.95969C14.24 7.95969 16.04 9.76969 16.04 11.9997C16.04 14.2297 14.24 16.0397 12 16.0397Z"/>
                          <path d="M11.9984 9.14062C10.4284 9.14062 9.14844 10.4206 9.14844 12.0006C9.14844 13.5706 10.4284 14.8506 11.9984 14.8506C13.5684 14.8506 14.8584 13.5706 14.8584 12.0006C14.8584 10.4306 13.5684 9.14062 11.9984 9.14062Z"/>`
      }
    })
  })

  clickListener('userSettings', function() {
    toggleUserMenu() 
    loadModule('Settings')
  })

  clickListener('userBackup', function() {
    if (!user) return
    toggleUserMenu()

    //RESET PASSWORD
    const dialogid = createDialog(fs.readFileSync(orion.modules+'Settings/userBackup.html').toString(), 'Cloud save')

    //PREPARE DIALOG
    let filesNames = []
    let filesMax = 0
    let filesDone = 0

    const loading = document.getElementById('bkpLoading')
    loading.style.opacity = '1'

    //GET FILES (CLOUD PATHS NEED '/' INSTEAD OF '\\')
    let files = [
      {
        name: 'Settings',
        local: orion.data + 'settings.json',
        cloud: 'settings.json'
      },
      {
        name: 'Library',
        local: orion.modules + 'Library/library.xml',
        cloud: 'Library/library.xml'
      }
    ]

    //CHECK FILES
    for (i in files) {
      //DATA
      let file = files[i]
      if (typeof file !== 'object') continue
      let id = `bkp${i}-${Date.now()}`
      let name = file.name
      if (typeof name !== 'string') continue
      if (filesNames.includes(name)) continue
      let local = file.local
      if (typeof local !== 'string') continue
      if (!fs.existsSync(local)) continue
      let cloud = file.cloud
      if (typeof cloud !== 'string') continue
      let bufLocal = Buffer.from(fs.readFileSync(local).toString())
      let bufCloud
      filesNames.push(name)
      filesMax++
      //ADD HTML
      document.getElementById('bkpList').insertAdjacentHTML('beforeend', `
        <div id="${id}" class="hc" style="gap: 10px; align-items: center;">
          <o-rbutton id="backup-${id}" style="pointer-events: none; opacity: .5;" title="Backup" small ball>
            <svg viewBox="0 0 24 24">
              <path d="M20.5 10.19H17.61C15.24 10.19 13.31 8.26 13.31 5.89V3C13.31 2.45 12.86 2 12.31 2H8.07C4.99 2 2.5 4 2.5 7.57V16.43C2.5 20 4.99 22 8.07 22H15.93C19.01 22 21.5 20 21.5 16.43V11.19C21.5 10.64 21.05 10.19 20.5 10.19ZM11.53 13.53C11.38 13.68 11.19 13.75 11 13.75C10.81 13.75 10.62 13.68 10.47 13.53L9.75 12.81V17C9.75 17.41 9.41 17.75 9 17.75C8.59 17.75 8.25 17.41 8.25 17V12.81L7.53 13.53C7.24 13.82 6.76 13.82 6.47 13.53C6.18 13.24 6.18 12.76 6.47 12.47L8.47 10.47C8.54 10.41 8.61 10.36 8.69 10.32C8.71 10.31 8.74 10.3 8.76 10.29C8.82 10.27 8.88 10.26 8.95 10.25C8.98 10.25 9 10.25 9.03 10.25C9.11 10.25 9.19 10.27 9.27 10.3C9.28 10.3 9.28 10.3 9.29 10.3C9.37 10.33 9.45 10.39 9.51 10.45C9.52 10.46 9.53 10.46 9.53 10.47L11.53 12.47C11.82 12.76 11.82 13.24 11.53 13.53Z"/>
              <path d="M17.4297 8.81048C18.3797 8.82048 19.6997 8.82048 20.8297 8.82048C21.3997 8.82048 21.6997 8.15048 21.2997 7.75048C19.8597 6.30048 17.2797 3.69048 15.7997 2.21048C15.3897 1.80048 14.6797 2.08048 14.6797 2.65048V6.14048C14.6797 7.60048 15.9197 8.81048 17.4297 8.81048Z"/>
            </svg>
          </o-rbutton>
          <o-rbutton id="restore-${id}" style="pointer-events: none; opacity: .5;" title="Restore" small ball>
            <svg viewBox="0 0 24 24">
              <path d="M20.5 10.19H17.61C15.24 10.19 13.31 8.26 13.31 5.89V3C13.31 2.45 12.86 2 12.31 2H8.07C4.99 2 2.5 4 2.5 7.57V16.43C2.5 20 4.99 22 8.07 22H15.93C19.01 22 21.5 20 21.5 16.43V11.19C21.5 10.64 21.05 10.19 20.5 10.19ZM12.28 15.78L10.28 17.78C10.21 17.85 10.12 17.91 10.03 17.94C9.94 17.98 9.85 18 9.75 18C9.65 18 9.56 17.98 9.47 17.94C9.39 17.91 9.31 17.85 9.25 17.79C9.24 17.78 9.23 17.78 9.23 17.77L7.23 15.77C6.94 15.48 6.94 15 7.23 14.71C7.52 14.42 8 14.42 8.29 14.71L9 15.44V11.25C9 10.84 9.34 10.5 9.75 10.5C10.16 10.5 10.5 10.84 10.5 11.25V15.44L11.22 14.72C11.51 14.43 11.99 14.43 12.28 14.72C12.57 15.01 12.57 15.49 12.28 15.78Z"/>
              <path d="M17.4297 8.81048C18.3797 8.82048 19.6997 8.82048 20.8297 8.82048C21.3997 8.82048 21.6997 8.15048 21.2997 7.75048C19.8597 6.30048 17.2797 3.69048 15.7997 2.21048C15.3897 1.80048 14.6797 2.08048 14.6797 2.65048V6.14048C14.6797 7.60048 15.9197 8.81048 17.4297 8.81048Z"/>
            </svg>
          </o-rbutton>
          <span id="text-${id}" style="margin-left: 10px;">Looking for a '${name}' backup...</span>
        </div>`)
      //GET ELEMENTS
      const text = document.getElementById('text-'+id)
      const back = document.getElementById('backup-'+id)
      const rest = document.getElementById('restore-'+id)
      //CHECK CLOUD
      const reff = ref(storage, userFolder+file.cloud)
      getDownloadURL(reff).then((url) => {
        filesDone++
        if (filesDone == filesMax) loading.style.opacity = '0'
        //HAS BACKUP
        const req = new XMLHttpRequest()
        req.responseType = 'blob'
        req.onload = (event) => {
          req.response.text().then((cfile) => {
            bufCloud = Buffer.from(cfile)
            if (bufLocal.equals(bufCloud))
              addListeners('identical')
            else
              addListeners('different')
          })
        }
        req.onerror = (event) => { addListeners('missing') }
        req.open('GET', url)
        req.send()
      }).catch((error) => {
        filesDone++
        if (filesDone == filesMax) loading.style.opacity = '0'
        //MISSING BACKUP
        addListeners('missing')
      })

      function addListeners(state) {
        //CHANGE TEXT & BUTTONS
        switch (state) {
          case 'identical':
            text.innerText = `Identical '${name}' backup found`
            break
          case 'different':
            text.innerText = `Different '${name}' backup found`
            back.style.pointerEvents = ''
            back.style.opacity = ''
            rest.style.pointerEvents = ''
            rest.style.opacity = ''
            break
          case 'missing':
            text.innerText = `No '${name}' backup found`
            back.style.pointerEvents = ''
            back.style.opacity = ''
            break
        }
        //ADD LISTENERS
        clickListener('backup-'+id, function() {
          if (state == 'identical') return
          //LOADING
          document.getElementById('bkpWindow').style.pointerEvents = 'none'
          loading.style.opacity = '1'
          //SAVE
          uploadString(reff, bufLocal.toString()).then((snapshot) => {
            //STOP LOADING
            document.getElementById('bkpWindow').style.pointerEvents = ''
            loading.style.opacity = '0'
            //UPDATE BUTTON
            text.innerText = `Identical '${name}' backup found`
            back.style.pointerEvents = 'none'
            back.style.opacity = '.5'
            rest.style.pointerEvents = 'none'
            rest.style.opacity = '.5'
          })
        })
        clickListener('restore-'+id, function() {
          if (state == 'missing') return

          //Start loading
          document.getElementById('bkpWindow').style.pointerEvents = 'none'
          loading.style.opacity = '1'

          //Save
          fs.writeFileSync(local, bufCloud.toString())

          //Module
          if (name == 'Settings') {
            //Settigns module
            refreshData()
            main = getKey('main')
            updateModules()
            toggleLeftMenu(json.main.menu)
            if (json.window) {
              let w = json.window
              if (w.width && w.height) {
                win.setSize(w.width, w.height)
                win.center()
              }
              if (w.isMaximized) win.maximize()
              else win.unmaximize()
            }
          } else if (local.startsWith(cModule.path.substring(0, cModule.path.length - 1))) {
            //Loaded module -> Reload
            loadModule(cModule.name, undefined, true)
          }
            
          //Stop loading
          document.getElementById('bkpWindow').style.pointerEvents = ''
          loading.style.opacity = '0'

          //Update button
          text.innerText = `Identical '${name}' backup found`
          back.style.pointerEvents = 'none'
          back.style.opacity = '.5'
          rest.style.pointerEvents = 'none'
          rest.style.opacity = '.5'
        })
      }
    }
  })

  clickListener('userLogout', function() {
    if (!user) return
    toggleUserMenu()
    //LOG OUT
    getAuth().signOut().then(function() {
      //ALL GOOD
      main.email = ''
      main.pass = ''
      setKey('main', main)
      checkUser()
    }, function(error) {
      //LOG OUT ERROR
      userError(error.code)
    })
  })

  function userError(error) {
    if (typeof error !== 'string') return
    if (error.includes('/')) 
      error = error.substring(error.indexOf('/')+1)
    error = error.replaceAll('-', ' ')
    createNoti('Error', titleCase(error))
  }

  function titleCase(str) {
    var splitStr = str.toLowerCase().split(' ')
    for (var i = 0; i < splitStr.length; i++) {
      splitStr[i] = splitStr[i].charAt(0).toUpperCase() + splitStr[i].substring(1)
    }
    return splitStr.join(' ')
  }
</script>
</html>