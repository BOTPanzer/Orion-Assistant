<!doctype html>
<html>
<head>
  <title id="headTitle">Oriøn Assistant</title>
  <!-- ASSISTANT -->
  <link rel="stylesheet" href="orion-assistant.css">
  <script src="orion-assistant.js"></script>
  <!-- FRAMEWORK -->
  <link rel="stylesheet" href="orion-framework.css">
  <script src="orion-framework.js"></script>
  <!-- THEME -->
  <link rel="stylesheet" href="Data/theme.css">
  <script src="Data/theme.js"></script>
</head>





<body class="vc">
  <div class="topBar">
    <div id="topName" class="topTitle">Oriøn Assistant</div>
    <div class="topDrag"></div>
    <div id="topMini" class="topButton">—</div>
    <div id="topMaxi" class="topButton">☐</div>
    <div id="topExit" class="topButton topButtonExit">✕</div>
  </div>
  
  <div class="hc" style="width: 100%; height: calc(100% - 45px); position: relative; overflow: hidden;">
    <div id="wall" style="width: 100vw; height: 100vh; position: absolute; display: none; z-index: 99999;"></div>

    <div id="userMenuContainer" class="userMenuContainer" style="width: 100%; height: 100%; position: absolute;">
      <div id="userMenu" class="userMenu" onclick="event.stopPropagation()">
        <span id="userUsername">Sign In</span>
        <span id="userLine" style="cursor: auto; height: 5px; background: var(--text2); border-radius: 5px; opacity: .2;"></span>
        <span id="userEdit" style="display: none;">Edit Profile</span>
        <span id="userSettings">Settings</span>
        <span id="userBackup" style="display: none;">Cloud Save</span>
        <span id="userLogout" style="display: none;">Log Out</span>
      </div>
      <svg class="userMenuTriangle" viewBox="0 0 24 24" > 
        <path d="M10,7c-3,3.7-4.6,10.3-9,15c-0.4,0.5-0.8,0.8-1,1c0,0.3,0,0.7,0,1c8,0,16,0,24,0c0-0.3,0-0.7,0-1c-0.2-0.2-0.6-0.5-1-1c-4.5-4.9-5.7-11.4-9-15c-0.4-0.5-1.2-1.2-2.1-1.2C11,5.9,10.3,6.6,10,7z"/>
      </svg>
    </div>

    <div id="menu" class="menu">
      <img id="menuLogo" class="menuLogo" src="Data/Images/logo.png"/>
      <div id="menuModules" class="menuModules"></div>
      <div id="menuUser" class="menuUser">
        <img id="userPhoto">
        <div id="userStatus"></div>
      </div>
    </div>  
    
    <div id="windowBg" class="win-b">
      <div id="window" class="win-w">
 
      </div>
    </div>
  </div>
</body>





<script>
  // /$$    /$$  /$$$$$$  /$$$$$$$  /$$$$$$  /$$$$$$  /$$$$$$$  /$$       /$$$$$$$$  /$$$$$$ 
  //| $$   | $$ /$$__  $$| $$__  $$|_  $$_/ /$$__  $$| $$__  $$| $$      | $$_____/ /$$__  $$
  //| $$   | $$| $$  \ $$| $$  \ $$  | $$  | $$  \ $$| $$  \ $$| $$      | $$      | $$  \__/
  //|  $$ / $$/| $$$$$$$$| $$$$$$$/  | $$  | $$$$$$$$| $$$$$$$ | $$      | $$$$$   |  $$$$$$ 
  // \  $$ $$/ | $$__  $$| $$__  $$  | $$  | $$__  $$| $$__  $$| $$      | $$__/    \____  $$
  //  \  $$$/  | $$  | $$| $$  \ $$  | $$  | $$  | $$| $$  \ $$| $$      | $$       /$$  \ $$
  //   \  $/   | $$  | $$| $$  | $$ /$$$$$$| $$  | $$| $$$$$$$/| $$$$$$$$| $$$$$$$$|  $$$$$$/
  //    \_/    |__/  |__/|__/  |__/|______/|__/  |__/|_______/ |________/|________/ \______/

  let dataLoaded = false
  let main = {}

  let loadingModules = false
  let currentModule = ''
  let lastStartModule = ''
  let tmpModule = {}


  //  /$$$$$$   /$$$$$$  /$$$$$$$  /$$$$$$$$
  // /$$__  $$ /$$__  $$| $$__  $$| $$_____/
  //| $$  \__/| $$  \ $$| $$  \ $$| $$      
  //| $$      | $$  | $$| $$  | $$| $$$$$   
  //| $$      | $$  | $$| $$  | $$| $$__/   
  //| $$    $$| $$  | $$| $$  | $$| $$      
  //|  $$$$$$/|  $$$$$$/| $$$$$$$/| $$$$$$$$
  // \______/  \______/ |_______/ |________/

  resetListeners()


  // /$$       /$$$$$$  /$$$$$$  /$$$$$$$$ /$$$$$$$$ /$$   /$$ /$$$$$$$$ /$$$$$$$   /$$$$$$ 
  //| $$      |_  $$_/ /$$__  $$|__  $$__/| $$_____/| $$$ | $$| $$_____/| $$__  $$ /$$__  $$
  //| $$        | $$  | $$  \__/   | $$   | $$      | $$$$| $$| $$      | $$  \ $$| $$  \__/
  //| $$        | $$  |  $$$$$$    | $$   | $$$$$   | $$ $$ $$| $$$$$   | $$$$$$$/|  $$$$$$ 
  //| $$        | $$   \____  $$   | $$   | $$__/   | $$  $$$$| $$__/   | $$__  $$ \____  $$
  //| $$        | $$   /$$  \ $$   | $$   | $$      | $$\  $$$| $$      | $$  \ $$ /$$  \ $$
  //| $$$$$$$$ /$$$$$$|  $$$$$$/   | $$   | $$$$$$$$| $$ \  $$| $$$$$$$$| $$  | $$|  $$$$$$/
  //|________/|______/ \______/    |__/   |________/|__/  \__/|________/|__/  |__/ \______/
  
  //DATA
  ipcRenderer.once('data', (event, argData) => {
    data = argData
    main = getKey('main')

    if (main == undefined) {
      main = { menu: false }
      setKey('main', main)
    }

    //MENU
    if (main.menu)
      document.body.style.setProperty('--menuSize', 'clamp(150px, 20%, 250px)')
    else 
      document.body.style.setProperty('--menuSize', '100px')

    //ADD MODULES
    addModules(true, true)
  })

  //MENU
  clickListener('menuLogo', function() {
    document.getElementById('menu').style.transition = 'width .3s'
    document.getElementById('windowBg').style.transition = 'width .3s'
    let modules = document.getElementById('menuModules').childNodes
    if (main.menu) {
      main.menu = false
      document.body.style.setProperty('--menuSize', '100px')
      modules.forEach(function(item) { document.getElementById(item.id).setAttribute('ball', '') })
    } else {
      main.menu = true
      document.body.style.setProperty('--menuSize', 'clamp(150px, 20%, 250px)')
      modules.forEach(function(item) { document.getElementById(item.id).removeAttribute('ball') })
    }
    setKey('main', main)
  })

  //TOP BUTTONS
  clickListener('topMini', function() {
    win.minimize()
  })

  clickListener('topMaxi', function() {
    if (!win.isMaximized())
      win.maximize()
    else
      win.unmaximize()
  })

  clickListener('topExit', function() {
    win.close()
  })
  
  //CONTEXT MENU
  window.oncontextmenu = function(event) {
    //CONTEXT MENU
    event.preventDefault()
    let target = event.target
    //GET SELECTION
    let selection = ''
    if (window.getSelection)
      selection = window.getSelection()
    else if (document.getSelection)
      selection = document.getSelection()
    else if (document.selection)
      selection = document.selection.createRange().text
    let selectionStr = selection.toString()
    //ADD BUTTONS
    let buttons = []
    switch (target.tagName) {
      case 'O-INPUT':
      case 'INPUT':
        if (['', 'text', 'search', 'email', 'url', 'tel'].indexOf(target.type) == -1) return
        if (selectionStr != '') {
          buttons.push({
            id: 'cut',
            label: 'Cut',
            click: function() { document.execCommand('cut') },
            frontElement: `<svg class="button-svg" viewBox="0 0 24 24" style="margin: 0 10px 0 0;">
                            <path d="M16.19 2H7.81C4.17 2 2 4.17 2 7.81V16.18C2 19.83 4.17 22 7.81 22H16.18C19.82 22 21.99 19.83 21.99 16.19V7.81C22 4.17 19.83 2 16.19 2ZM17.76 14.68C18.09 14.93 18.16 15.4 17.91 15.73C17.76 15.93 17.54 16.03 17.31 16.03C17.15 16.03 17 15.98 16.86 15.88L12.91 12.93L10.5 14.73C10.51 14.83 10.53 14.93 10.53 15.03C10.53 16.3 9.5 17.33 8.23 17.33C6.96 17.33 5.93 16.3 5.93 15.03C5.93 13.76 6.96 12.73 8.23 12.73C8.85 12.73 9.4 12.98 9.81 13.37L11.65 11.99L9.82 10.62C9.41 11.02 8.84 11.27 8.22 11.27C6.95 11.27 5.92 10.24 5.92 8.97C5.92 7.7 6.95 6.67 8.22 6.67C9.49 6.67 10.52 7.7 10.52 8.97C10.52 9.07 10.5 9.16 10.49 9.25L12.89 11.05L16.84 8.1C17.17 7.85 17.64 7.92 17.89 8.25C18.14 8.58 18.07 9.05 17.74 9.3L14.14 11.99L17.76 14.68Z"/>
                          </svg>`
          })
          buttons.push({
            id: 'copy',
            label: 'Copy',
            click: function() { document.execCommand('copy') },
            frontElement: `<svg class="button-svg" viewBox="0 0 24 24" style="margin: 0 10px 0 0;">
                            <path d="M16 12.9V17.1C16 20.6 14.6 22 11.1 22H6.9C3.4 22 2 20.6 2 17.1V12.9C2 9.4 3.4 8 6.9 8H11.1C14.6 8 16 9.4 16 12.9Z"/>
                            <path d="M17.0998 2H12.8998C9.81668 2 8.37074 3.09409 8.06951 5.73901C8.00649 6.29235 8.46476 6.75 9.02167 6.75H11.0998C15.2998 6.75 17.2498 8.7 17.2498 12.9V14.9781C17.2498 15.535 17.7074 15.9933 18.2608 15.9303C20.9057 15.629 21.9998 14.1831 21.9998 11.1V6.9C21.9998 3.4 20.5998 2 17.0998 2Z"/>
                          </svg>`
          })
        }
        buttons.push({
          id: 'paste',
          label: 'Paste',
          click: function() { document.execCommand('paste') },
          frontElement: `<svg class="button-svg" viewBox="0 0 24 24" style="margin: 0 10px 0 0;">
                          <path d="M14.3498 2H9.64977C8.60977 2 7.75977 2.84 7.75977 3.88V4.82C7.75977 5.86 8.59977 6.7 9.63977 6.7H14.3498C15.3898 6.7 16.2298 5.86 16.2298 4.82V3.88C16.2398 2.84 15.3898 2 14.3498 2Z"/>
                          <path d="M17.2391 4.81949C17.2391 6.40949 15.9391 7.70949 14.3491 7.70949H9.64906C8.05906 7.70949 6.75906 6.40949 6.75906 4.81949C6.75906 4.25949 6.15906 3.90949 5.65906 4.16949C4.24906 4.91949 3.28906 6.40949 3.28906 8.11949V17.5295C3.28906 19.9895 5.29906 21.9995 7.75906 21.9995H16.2391C18.6991 21.9995 20.7091 19.9895 20.7091 17.5295V8.11949C20.7091 6.40949 19.7491 4.91949 18.3391 4.16949C17.8391 3.90949 17.2391 4.25949 17.2391 4.81949ZM12.3791 16.9495H7.99906C7.58906 16.9495 7.24906 16.6095 7.24906 16.1995C7.24906 15.7895 7.58906 15.4495 7.99906 15.4495H12.3791C12.7891 15.4495 13.1291 15.7895 13.1291 16.1995C13.1291 16.6095 12.7891 16.9495 12.3791 16.9495ZM14.9991 12.9495H7.99906C7.58906 12.9495 7.24906 12.6095 7.24906 12.1995C7.24906 11.7895 7.58906 11.4495 7.99906 11.4495H14.9991C15.4091 11.4495 15.7491 11.7895 15.7491 12.1995C15.7491 12.6095 15.4091 12.9495 14.9991 12.9495Z"/>
                        </svg>`
        })
        break
      default:
        //IS THE SELECTED ELEMENT
        try {
          if (target != selection.baseNode.parentNode) return
          if (selectionStr != '')
            buttons.push({
              id: 'copy',
              label: 'Copy',
              click: function() { document.execCommand('copy') },
              frontElement: `<svg class="button-svg" viewBox="0 0 24 24" style="margin: 0 10px 0 0;">
                              <path d="M16 12.9V17.1C16 20.6 14.6 22 11.1 22H6.9C3.4 22 2 20.6 2 17.1V12.9C2 9.4 3.4 8 6.9 8H11.1C14.6 8 16 9.4 16 12.9Z"/>
                              <path d="M17.0998 2H12.8998C9.81668 2 8.37074 3.09409 8.06951 5.73901C8.00649 6.29235 8.46476 6.75 9.02167 6.75H11.0998C15.2998 6.75 17.2498 8.7 17.2498 12.9V14.9781C17.2498 15.535 17.7074 15.9933 18.2608 15.9303C20.9057 15.629 21.9998 14.1831 21.9998 11.1V6.9C21.9998 3.4 20.5998 2 17.0998 2Z"/>
                            </svg>`
            })
          else
            return
        } catch (e) { return }
        break
    }
    createCTXMenu(event, buttons)
  }

  
  // /$$$$$$$$ /$$   /$$ /$$   /$$  /$$$$$$  /$$$$$$$$ /$$$$$$  /$$$$$$  /$$   /$$  /$$$$$$ 
  //| $$_____/| $$  | $$| $$$ | $$ /$$__  $$|__  $$__/|_  $$_/ /$$__  $$| $$$ | $$ /$$__  $$
  //| $$      | $$  | $$| $$$$| $$| $$  \__/   | $$     | $$  | $$  \ $$| $$$$| $$| $$  \__/
  //| $$$$$   | $$  | $$| $$ $$ $$| $$         | $$     | $$  | $$  | $$| $$ $$ $$|  $$$$$$ 
  //| $$__/   | $$  | $$| $$  $$$$| $$         | $$     | $$  | $$  | $$| $$  $$$$ \____  $$
  //| $$      | $$  | $$| $$\  $$$| $$    $$   | $$     | $$  | $$  | $$| $$\  $$$ /$$  \ $$
  //| $$      |  $$$$$$/| $$ \  $$|  $$$$$$/   | $$    /$$$$$$|  $$$$$$/| $$ \  $$|  $$$$$$/
  //|__/       \______/ |__/  \__/ \______/    |__/   |______/ \______/ |__/  \__/ \______/

  function resetListeners() {
    ipcRenderer.removeAllListeners()
    $('#window *').off()
    $(window).off()

    ipcRenderer.on('loadModule', (event, path, specialData) => {
      if (currentModule != '')
        loadModule(path, specialData)
      else {
        tmpModule.path = path
        tmpModule.specialData = specialData
      }
    })

    ipcRenderer.on('noti', (event, title, text) => {
      createNoti(title, text)
    })

    ipcRenderer.on('pause', (event) => {
      document.getElementById('wall').style.display = 'block'
    })

    ipcRenderer.on('resume', (event) => {
      document.getElementById('wall').style.display = 'none'
    })
  }

  //USER
  function toggleUserMenu() {
    const menuC = document.getElementById('userMenuContainer')
    const menu = document.getElementById('userMenu')
    if (menuC.style.opacity == '1') {
      menuC.style.opacity = '0'
      menu.style.pointerEvents = 'none'
      window.removeEventListener('click', toggleUserMenu)
    } else {
      menuC.style.opacity = '1'
      menu.style.pointerEvents = 'all'
      window.addEventListener('click', toggleUserMenu)
    }
  }

  //MODULE FUNCTIONS
  function addModules(loadStart, loadMod) {
    if (loadMod == undefined) loadMod = true
    if (tmpModule.path != undefined) loadMod = false
    //MODULES
    if (!fs.existsSync(data.modules)) return
    document.getElementById('menuModules').innerHTML = ''
    let modulestmp = fs.readdirSync(data.modules)
    //PRIORITY MODULES
    let modules = []
    if (modulestmp.includes('Store')) {
      modules.push('Store')
      modulestmp.splice(modulestmp.indexOf('Store'), 1)
    } if (modulestmp.includes('Library')) {
      modules.push('Library')
      modulestmp.splice(modulestmp.indexOf('Library'), 1)
    } if (modulestmp.includes('Themes')) {
      modules.push('Themes')
      modulestmp.splice(modulestmp.indexOf('Themes'), 1)
    }
    for(i in modulestmp) 
      modules.push(modulestmp[i])
    //LOAD START.HTML
    if (loadStart) {
      let i = modules.length
      loadStartNext()
      function loadStartNext() {
        i--
        if (i >= 0) loadStart()
      }
      function loadStart() {
        //DATA
        let path = data.modules+modules[i]+'\\'
        let startFile = path+'start.js'
        //LOAD
        if (fs.existsSync(startFile)) {
          lastStartModule = path
          $.getScript(startFile, function() { loadStartNext() })
        } else loadStartNext()
      }
    }
    //ADD MODULES
    for(i in modules) {
      //DATA
      let name = modules[i]
      let path = data.modules+name
      //ADD MODULE IF NOT HIDDEN & MAIN.HTML EXISTS & IS NOT SETTINGS
      if (!fs.existsSync(path+'/hidden') && fs.existsSync(path+'\\main.html') && name != 'Settings') {
        let id = 'module-'+name.replaceAll(' ', '-')
        let image = 'Data/Images/module.png'
        if (fs.existsSync(path+'/icon.png')) image = 'Modules/'+name+'/icon.png'
        let html
        if (main.menu)
          html = `<o-rbutton id="${id}" icon="${image}" text="${name}" module></o-rbutton>`
        else
          html = `<o-rbutton id="${id}" icon="${image}" text="${name}" module ball></o-rbutton>`
        //ADD MODULE
        document.getElementById('menuModules').insertAdjacentHTML('beforeend', html)
        //ADD LISTENERS
        clickListener(id, function() {
          loadModule(path)
        })
        //IF JUST STARTED & IS LIBRARY THEN OPEN
        if (loadMod && path.endsWith('Modules\\Library') && currentModule == '' && modules.length > 0) {
          document.getElementById(id).click()
          loadMod = false
        }
      }
    }
    //IF JUST STARTED & LIBRARY DIDN'T OPEN THE FIRST MODULE
    if (loadMod)
      document.getElementById(document.getElementById('menuModules').firstChild.id).click()
    //LOAD TMP MODULE
    if (tmpModule.path != undefined) {
      loadModule(tmpModule.path, tmpModule.specialData)
      tmpModule = {}
    }
  }

  function loadModule(path, specialData) {
    if (loadingModules) return
    if (!fs.existsSync(path)) path = data.modules+path
    if (!path.endsWith('\\')) path = path+'\\'
    //CHECK IF MODULE EXISTS
    let html = path+'main.html'
    if (!fs.existsSync(html)) {
      createNoti("Oriøn Assistant", "Module Does not Exist")
      return
    }
    if (currentModule == path) return
    else currentModule = path
    //LOADING STATE
    loadingModules = true
    //CHANGE TITLE & CHECK MODULE
    let name = path.substring(0, path.length-1)
    name = name.substring(name.lastIndexOf('\\')+1, name.length)
    //CHECK CURRENT MODULE
    let modules = document.getElementById('menuModules').childNodes
    modules.forEach(function(item) { document.getElementById(item.id).removeAttribute('checked') })
    if (name != 'Settings') 
      modules.forEach(function(item) { 
        if (item.text == name)
          document.getElementById(item.id).setAttribute('checked', '')
      })
    //LOAD
    $("#window").fadeOut(200, function() {
      resetListeners()
      document.getElementById('window').style = ''
      document.getElementById('window').scrollTop = 0
      $("#window").fadeOut(0)
      $("#window").load(html.replaceAll(' ', '%20'), function () {
        renameWindow(document.getElementById('headTitle').innerHTML)
        ipcRenderer.send('specialData', specialData)
        $("#window").fadeIn(200, function() {
          loadingModules = false
        })
      })
    })
  }
</script>





<script type="module">
  import { initializeApp, getApp } from "https://www.gstatic.com/firebasejs/9.8.2/firebase-app.js"
  import { getAuth, updateProfile, updatePassword, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.8.2/firebase-auth.js"
  import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.8.2/firebase-storage.js"
  
  initializeApp({
    apiKey: "AIzaSyB3CLiTYV6ZJY6_TPpvfqPQhd-xmfA0cu8",
    authDomain: "orionassistantpc.firebaseapp.com",
    projectId: "orionassistantpc",
    storageBucket: "orionassistantpc.appspot.com",
    messagingSenderId: "87577099805",
    appId: "1:87577099805:web:be32e75e01246a286190f4",
    measurementId: "G-1J36W704VN"
  })

  let user
  let userFolder
  const storage = getStorage(getApp(), 'gs://orionassistantpc.appspot.com')
  
  login()
  function login() {
    //WAIT FOR DATA TO LOAD
    if (data.data == undefined) {
      setTimeout(login, 250)
      return
    }

    //CREATE KEYS IF MISSING
    if (!main.email || !main.pass) {
      main.email = ''
      main.pass = ''
      setKey('main', main)
    }

    //LOG IN
    if (main.email != '' && main.pass != '') {
      let decPass = atob(main.pass)
      signInWithEmailAndPassword(getAuth(), main.email, decPass).then((userCredential) => {
        console.log(`Logged in as '${userCredential.user.displayName}'`)
        addUserMenuL()
      }).catch((error) => {
        userError(error.code)
        addUserMenuL()
      })
    } else addUserMenuL()

    //USER MENU LISTENER
    function addUserMenuL() {
      document.getElementById('menuUser').style.opacity = '1'
      checkUser()
      clickListener('menuUser', function() {
        toggleUserMenu()
        event.stopPropagation()
      })
    }
  }

  function checkUser() {
    user = getAuth().currentUser
    if (user) {
      userFolder = `/${user.uid}/`
      //IMAGE
      let image = user.photoURL
      if (typeof image != 'string') image = 'Data/Images/avatar.png'
      document.getElementById('userPhoto').src = image
      //NAME
      let name = user.displayName
      if (typeof name != 'string') name = 'User'
      document.getElementById('userUsername').innerText = name
      //OTHER
      document.getElementById('userStatus').style.background = 'var(--success)'
      document.getElementById('userEdit').style.display = 'block'
      document.getElementById('userBackup').style.display = 'block'
      document.getElementById('userLogout').style.display = 'block'
    } else {
      userFolder = undefined
      document.getElementById('userPhoto').src = 'Data/Images/avatar.png'
      document.getElementById('userUsername').innerText = 'Log In'
      document.getElementById('userStatus').style.background = 'var(--danger)'
      document.getElementById('userEdit').style.display = 'none'
      document.getElementById('userBackup').style.display = 'none'
      document.getElementById('userLogout').style.display = 'none'
    }
  }

  let userEasteregg = 0
  clickListener('userUsername', function() {
    if (user) {
      userEasteregg++
      if (userEasteregg > 6) {
        userEasteregg = 0
        ipcRenderer.send('newOrionWindow', data.modules+'Settings/easterSnake.html', false, 500, 545)
        toggleUserMenu()
      }
      return
    }
    toggleUserMenu()
    //LOG IN
    const dialogid = createDialog(fs.readFileSync(data.modules+'Settings/userLogin.html').toString(), 'Log In')

    //PREPARE DIALOG
    const loading = document.getElementById('loginLoading')

    clickListener('loginLogin', function() {
      const email = document.getElementById('loginEmail').value
      const pass = document.getElementById('loginPass').value
      loading.style.opacity = '1'
      signInWithEmailAndPassword(getAuth(), email, pass).then((userCredential) => {
        //ALL GOOD
        main.email = email
        main.pass = btoa(pass)
        setKey('main', main)
        checkUser()
        closeDialog(dialogid)
        createNoti('Settings', 'Logged In Successfully')
      }).catch((error) => {
        //LOG IN ERROR
        userError(error.code)
        console.log(error);
        loading.style.opacity = '0'
      })
    })

    clickListener('loginCreate', function() {
      const email = document.getElementById('loginEmail').value
      const pass = document.getElementById('loginPass').value
      loading.style.opacity = '1'
      createUserWithEmailAndPassword(getAuth(), email, pass).then((userCredential) => {
        //ALL GOOD
        main.email = email
        main.pass = pass
        setKey('main', main)
        updateProfile(user, {
          displayName: 'User',
          photoURL: 'Data/Images/avatar.png'
        }).then(() => {
          //ALL GOOD
          checkUser()
          closeDialog(dialogid)
          createNoti('Settings', 'User Created Successfully')
        }).catch((error) => {
          //UPDATE USER ERROR
          userError(error.code)
          loading.style.opacity = '0'
        })
      }).catch((error) => {
        //CREATE USER ERROR
        userError(error.code)
        loading.style.opacity = '0'
      })
    })
  
    clickListener('loginPassShow', function() {
      event.stopPropagation()
      const input = document.getElementById('loginPass')
      if (input.type == 'password') {
        input.type = 'text'
        this.innerHTML = `<path d="M21.2714 9.17834C20.9814 8.71834 20.6714 8.28834 20.3514 7.88834C19.9814 7.41834 19.2814 7.37834 18.8614 7.79834L15.8614 10.7983C16.0814 11.4583 16.1214 12.2183 15.9214 13.0083C15.5714 14.4183 14.4314 15.5583 13.0214 15.9083C12.2314 16.1083 11.4714 16.0683 10.8114 15.8483C10.8114 15.8483 9.38141 17.2783 8.35141 18.3083C7.85141 18.8083 8.01141 19.6883 8.68141 19.9483C9.75141 20.3583 10.8614 20.5683 12.0014 20.5683C13.7814 20.5683 15.5114 20.0483 17.0914 19.0783C18.7014 18.0783 20.1514 16.6083 21.3214 14.7383C22.2714 13.2283 22.2214 10.6883 21.2714 9.17834Z"/>
                          <path d="M14.0206 9.98062L9.98062 14.0206C9.47062 13.5006 9.14062 12.7806 9.14062 12.0006C9.14062 10.4306 10.4206 9.14062 12.0006 9.14062C12.7806 9.14062 13.5006 9.47062 14.0206 9.98062Z"/>
                          <path d="M18.25 5.74969L14.86 9.13969C14.13 8.39969 13.12 7.95969 12 7.95969C9.76 7.95969 7.96 9.76969 7.96 11.9997C7.96 13.1197 8.41 14.1297 9.14 14.8597L5.76 18.2497H5.75C4.64 17.3497 3.62 16.1997 2.75 14.8397C1.75 13.2697 1.75 10.7197 2.75 9.14969C3.91 7.32969 5.33 5.89969 6.91 4.91969C8.49 3.95969 10.22 3.42969 12 3.42969C14.23 3.42969 16.39 4.24969 18.25 5.74969Z"/>
                          <path d="M14.8581 11.9981C14.8581 13.5681 13.5781 14.8581 11.9981 14.8581C11.9381 14.8581 11.8881 14.8581 11.8281 14.8381L14.8381 11.8281C14.8581 11.8881 14.8581 11.9381 14.8581 11.9981Z"/>
                          <path d="M21.7689 2.22891C21.4689 1.92891 20.9789 1.92891 20.6789 2.22891L2.22891 20.6889C1.92891 20.9889 1.92891 21.4789 2.22891 21.7789C2.37891 21.9189 2.56891 21.9989 2.76891 21.9989C2.96891 21.9989 3.15891 21.9189 3.30891 21.7689L21.7689 3.30891C22.0789 3.00891 22.0789 2.52891 21.7689 2.22891Z"/>`
      } else {
        input.type = 'password'
        this.innerHTML = `<path d="M21.25 9.14969C18.94 5.51969 15.56 3.42969 12 3.42969C10.22 3.42969 8.49 3.94969 6.91 4.91969C5.33 5.89969 3.91 7.32969 2.75 9.14969C1.75 10.7197 1.75 13.2697 2.75 14.8397C5.06 18.4797 8.44 20.5597 12 20.5597C13.78 20.5597 15.51 20.0397 17.09 19.0697C18.67 18.0897 20.09 16.6597 21.25 14.8397C22.25 13.2797 22.25 10.7197 21.25 9.14969ZM12 16.0397C9.76 16.0397 7.96 14.2297 7.96 11.9997C7.96 9.76969 9.76 7.95969 12 7.95969C14.24 7.95969 16.04 9.76969 16.04 11.9997C16.04 14.2297 14.24 16.0397 12 16.0397Z"/>
                          <path d="M11.9984 9.14062C10.4284 9.14062 9.14844 10.4206 9.14844 12.0006C9.14844 13.5706 10.4284 14.8506 11.9984 14.8506C13.5684 14.8506 14.8584 13.5706 14.8584 12.0006C14.8584 10.4306 13.5684 9.14062 11.9984 9.14062Z"/>`
      }
    })
  })

  clickListener('userEdit', function() {
    if (!user) return
    toggleUserMenu()
    //EDIT PROFILE
    const dialogid = createDialog(fs.readFileSync(data.modules+'Settings/userEdit.html').toString(), 'Edit Profile')

    //PREPARE DIALOG
    const oldName = user.displayName
    if (typeof oldName == 'string') document.getElementById('editName').value = oldName
    document.getElementById('editPfp').src = document.getElementById('userPhoto').src

    clickListener('editSave', function() {
      let nameUpdated = false
      let imageUpdated = false
      let passUpdated = false
      const loading = document.getElementById('editLoading')

      //UPDATE NAME
      const name = document.getElementById('editName').value.trim()
      if (name != '' && name != oldName) {
        loading.style.opacity = '1'
        updateProfile(user, {
          displayName: name
        }).then(() => {
          //ALL GOOD
          nameUpdated = true
          checkClose()
        }).catch((error) => {
          //UPDATE NAME ERROR
          userError(error.code)
          loading.style.opacity = '0'
        })
      } else nameUpdated = true

      //UPDATE IMAGE
      const image = document.getElementById('editImage').value.trim()
      if (image != '' && image != user.photoURL) {
        loading.style.opacity = '1'
        //UPLOAD IMAGE
        if (image.toLowerCase().startsWith('data:image/png;base64,')) { 
          //BASE64 IMAGE
          const imageRef = ref(storage, `/${user.uid}/avatar.png`)
          const base64 = image.substring(image.indexOf(',')+1)
          uploadString(imageRef, base64, 'base64').then((snapshot) => {
            getDownloadURL(imageRef).then((url) => {
              updateProfile(user, {
                photoURL: url
              }).then(() => {
                //ALL GOOD
                imageUpdated = true
                checkClose()
              }).catch((error) => {
                //UPDATE IMAGE ERROR
                userError(error.code)
                loading.style.opacity = '0'
              })
            }).catch((error) => {
              //GET IMAGE URL ERROR
              userError(error.code)
              loading.style.opacity = '0'
            })
          })
        } else { 
          //NON BASE64 IMAGE
          updateProfile(user, {
            photoURL: image
          }).then(() => {
            //ALL GOOD
            imageUpdated = true
            checkClose()
          }).catch((error) => {
            //UPDATE IMAGE ERROR
            userError(error.code)
            loading.style.opacity = '0'
          })
        }
      } else imageUpdated = true

      //UPDATE PASS
      const pass = document.getElementById('editPass').value.trim()
      if (pass != '') {
        loading.style.opacity = '1'
        updatePassword(user, pass).then(() => {
          //ALL GOOD
          passUpdated = true
          checkClose()
        }).catch((error) => {
          //UPDATE NAME ERROR
          userError(error.code)
          loading.style.opacity = '0'
        })
      } else passUpdated = true

      //CHECK TO CLOSE
      checkClose()
      function checkClose() {
        if (nameUpdated && imageUpdated && passUpdated) {
          checkUser()
          closeDialog(dialogid)
          createNoti('Settings', 'Saved Successfully')
        }
      }
    })
  
    clickListener('editImageFolder', function() {
      event.stopPropagation()
      ipcRenderer.send('getFile', 'requestedUserImage', 'Choose an Image')
    })

    ipcRenderer.removeAllListeners('requestedUserImage')
    ipcRenderer.on('requestedUserImage', (event, path) => {
      if (path == '') return
      ipcRenderer.send('getBase64', 'requestedUserBase64', path, path)
    })

    ipcRenderer.removeAllListeners('requestedUserBase64')
    ipcRenderer.on('requestedUserBase64', async function(event, base64, tag) {
      if (base64 == '') {
        document.getElementById('editImage').value = tag
        document.getElementById('editPfp').src = tag
      } else {
        const result = await resizeBase64Image(base64)
        document.getElementById('editImage').value = result
        document.getElementById('editPfp').src = result
      }
    }) 
    
    function refreshPFP() {
      const image = document.getElementById('editImage').value
      if (image != '')
        document.getElementById('editPfp').src = image
      else if (user.photoURL != null) 
        document.getElementById('editPfp').src = user.photoURL
      else 
        document.getElementById('editPfp').src = 'Data/Images/avatar.png'
    }

    clickListener('editPfp', refreshPFP)

    clickListener('editPassShow', function() {
      event.stopPropagation()
      const input = document.getElementById('editPass')
      if (input.type == 'password') {
        input.type = 'text'
        this.innerHTML = `<path d="M21.2714 9.17834C20.9814 8.71834 20.6714 8.28834 20.3514 7.88834C19.9814 7.41834 19.2814 7.37834 18.8614 7.79834L15.8614 10.7983C16.0814 11.4583 16.1214 12.2183 15.9214 13.0083C15.5714 14.4183 14.4314 15.5583 13.0214 15.9083C12.2314 16.1083 11.4714 16.0683 10.8114 15.8483C10.8114 15.8483 9.38141 17.2783 8.35141 18.3083C7.85141 18.8083 8.01141 19.6883 8.68141 19.9483C9.75141 20.3583 10.8614 20.5683 12.0014 20.5683C13.7814 20.5683 15.5114 20.0483 17.0914 19.0783C18.7014 18.0783 20.1514 16.6083 21.3214 14.7383C22.2714 13.2283 22.2214 10.6883 21.2714 9.17834Z"/>
                          <path d="M14.0206 9.98062L9.98062 14.0206C9.47062 13.5006 9.14062 12.7806 9.14062 12.0006C9.14062 10.4306 10.4206 9.14062 12.0006 9.14062C12.7806 9.14062 13.5006 9.47062 14.0206 9.98062Z"/>
                          <path d="M18.25 5.74969L14.86 9.13969C14.13 8.39969 13.12 7.95969 12 7.95969C9.76 7.95969 7.96 9.76969 7.96 11.9997C7.96 13.1197 8.41 14.1297 9.14 14.8597L5.76 18.2497H5.75C4.64 17.3497 3.62 16.1997 2.75 14.8397C1.75 13.2697 1.75 10.7197 2.75 9.14969C3.91 7.32969 5.33 5.89969 6.91 4.91969C8.49 3.95969 10.22 3.42969 12 3.42969C14.23 3.42969 16.39 4.24969 18.25 5.74969Z"/>
                          <path d="M14.8581 11.9981C14.8581 13.5681 13.5781 14.8581 11.9981 14.8581C11.9381 14.8581 11.8881 14.8581 11.8281 14.8381L14.8381 11.8281C14.8581 11.8881 14.8581 11.9381 14.8581 11.9981Z"/>
                          <path d="M21.7689 2.22891C21.4689 1.92891 20.9789 1.92891 20.6789 2.22891L2.22891 20.6889C1.92891 20.9889 1.92891 21.4789 2.22891 21.7789C2.37891 21.9189 2.56891 21.9989 2.76891 21.9989C2.96891 21.9989 3.15891 21.9189 3.30891 21.7689L21.7689 3.30891C22.0789 3.00891 22.0789 2.52891 21.7689 2.22891Z"/>`
      } else {
        input.type = 'password'
        this.innerHTML = `<path d="M21.25 9.14969C18.94 5.51969 15.56 3.42969 12 3.42969C10.22 3.42969 8.49 3.94969 6.91 4.91969C5.33 5.89969 3.91 7.32969 2.75 9.14969C1.75 10.7197 1.75 13.2697 2.75 14.8397C5.06 18.4797 8.44 20.5597 12 20.5597C13.78 20.5597 15.51 20.0397 17.09 19.0697C18.67 18.0897 20.09 16.6597 21.25 14.8397C22.25 13.2797 22.25 10.7197 21.25 9.14969ZM12 16.0397C9.76 16.0397 7.96 14.2297 7.96 11.9997C7.96 9.76969 9.76 7.95969 12 7.95969C14.24 7.95969 16.04 9.76969 16.04 11.9997C16.04 14.2297 14.24 16.0397 12 16.0397Z"/>
                          <path d="M11.9984 9.14062C10.4284 9.14062 9.14844 10.4206 9.14844 12.0006C9.14844 13.5706 10.4284 14.8506 11.9984 14.8506C13.5684 14.8506 14.8584 13.5706 14.8584 12.0006C14.8584 10.4306 13.5684 9.14062 11.9984 9.14062Z"/>`
      }
    })
  })

  clickListener('userSettings', function() {
    toggleUserMenu() 
    loadModule('Settings')
  })

  clickListener('userBackup', function() {
    if (!user) return
    toggleUserMenu()
    //RESET PASSWORD
    const dialogid = createDialog(fs.readFileSync(data.modules+'Settings/userBackup.html').toString(), 'Cloud Save')

    //PREPARE DIALOG
    const loading = document.getElementById('backLoading')
    loading.style.opacity = '1'
    const text = document.getElementById('backText')
    const back = document.getElementById('backBackup')
    const rest = document.getElementById('backRestore')
    rest.style.display = 'none'

    const configRef = ref(storage, userFolder+'settings.json')
    getDownloadURL(configRef).then((url) => {
      //HAS SETTINGS BACKUP
      checkSettings(url)
    }).catch((error) => {
      //GET IMAGE URL ERROR
      checkSettings()
    })

    function checkSettings(url) {
      if (url) {
        const req = new XMLHttpRequest()
        req.responseType = 'blob'
        req.onload = (event) => {
          req.response.text().then(function(settings) {
            const settings2 = JSON.stringify(json, null, 2)
            if (settings != settings2)
              text.innerText = 'There is a Different Settings Backup in the Cloud'
            else
              text.innerText = 'There is an Identical Settings Backup in the Cloud'
            addListeners(settings, settings2)
          })
        }
        req.open('GET', url)
        req.send()
      } else {
        text.innerText = 'There is no Settings Backup in the Cloud'
        addListeners()
      }
    }

    function addListeners(settings, settings2) {
      loading.style.opacity = '0'

      clickListener('backBackup', function() {
        loading.style.opacity = '1'
        uploadString(configRef, settings2).then((snapshot) => {
          closeDialog(dialogid)
          createNoti('Settings', 'Backed up Successfully')
        })
      })

      if (settings) {
        rest.style.display = 'flex'
        clickListener('backRestore', function() {
          loading.style.opacity = '1'
          let menuOpen = json.main.menu
          fs.writeFileSync(data.data+'settings.json', settings)
          refreshData()
          if (json.main.menu != menuOpen) document.getElementById('menuLogo').click()
          closeDialog(dialogid)
          createNoti('Settings', 'Restored Successfully')
        })
      }
    }
  })

  clickListener('userLogout', function() {
    if (!user) return
    toggleUserMenu()
    //LOG OUT
    getAuth().signOut().then(function() {
      //ALL GOOD
      main.email = ''
      main.pass = ''
      setKey('main', main)
      checkUser()
    }, function(error) {
      //LOG OUT ERROR
      userError(error.code)
    })
  })

  function userError(error) {
    if (typeof error !== 'string') return
    if (error.includes('/')) 
      error = error.substring(error.indexOf('/')+1)
    error = error.replaceAll('-', ' ')
    createNoti('Error', titleCase(error))
  }

  function titleCase(str) {
    var splitStr = str.toLowerCase().split(' ')
    for (var i = 0; i < splitStr.length; i++) {
      splitStr[i] = splitStr[i].charAt(0).toUpperCase() + splitStr[i].substring(1)
    }
    return splitStr.join(' ')
  }
</script>
</html>