<style>
  .list {
    color: var(--textPrimary);
    overflow: hidden;
    overflow-x: auto;
    display: flex;

    padding-bottom: 5px;
    margin-left: 5px; 
    margin-right: 5px;
  }

  .listFeatured {
    flex-grow: 1;
    height: 100%;

    position: relative;
    display: flex;
    transition: all 0.4s;
    overflow: hidden;

    border-radius: var(--buttonCornerRadius);

    background: transparent;
    background-position: center;
    background-size: cover;

    color: var(--textPrimary);
    box-shadow: var(--shadow);
  }

  .listItems {
    height: 100%;
    min-width: fit-content;

    padding-top: 2px;
    padding-bottom: 2px;

    overflow-y: auto;
    overflow-x: hidden;

    display: flex;
    flex-direction: column;
    flex-wrap: nowrap;
    gap: 10px 0px;

    color: var(--textPrimary);
  }
</style>

<div class="vc" style="padding: 2%; position: relative;">
  <div class="hc" style="width: 100%; align-items: center; margin-bottom: 20px;">
    <div id="title" style="padding-top: 10px; padding-bottom: 10px; color: var(--textPrimary); font-family: Special; font-size: 40px; line-height: 40px; text-overflow: ellipsis; white-space: nowrap; overflow: hidden;">Home</div>
    <div id="status" class="button buttonEmoteText" style="width: 40px; min-width: 40px; height: 40px; margin-left: 10px;">üåê</div>
    <div style="flex-grow: 1;"></div>
    <div class="button hc" style="width: 40%; min-width: 40%; margin-left: 10px;">
      <div id="discover" class="buttonEmoteText" style="min-width: 40px; height: 40px;">üî•</div>
      <input id='editText' class="input" type="text" spellcheck="false" placeholder="Search" maxlength="30" style="flex-grow: 1; padding-left: 0; padding-right: 0;"></input>
      <div id="search" class="buttonEmoteText" style="min-width: 40px; height: 40px;">üîé</div>
    </div>
  </div>

  <div id="status-container" class="button hc" style="height: 0; margin: 0 50px; font-size: 15px; line-height: normal; justify-content: space-around; transition: all .2s, height 0s; opacity: 0; pointer-events: none;">
    <div class="hc" style="align-items: center; margin: 20px 0;">
      <div>ElAmigos</div>
      <div id="status-elamigos" style="width: 10px; height: 10px; margin-left: 10px;  border-radius: 5px;"></div>
    </div>
    <div class="hc" style="align-items: center; margin: 20px 0;">
      <div>Fitgirl</div>
      <div id="status-fitgirl" style="width: 10px; height: 10px; margin-left: 10px;  border-radius: 5px;"></div>
    </div>
    <div class="hc" style="align-items: center; margin: 20px 0;">
      <div >Pivi</div>
      <div id="status-pivi" style="width: 10px; height: 10px; margin-left: 10px;  border-radius: 5px;"></div>
    </div>
    <div class="hc" style="align-items: center; margin: 20px 0;">
      <div>Steam Unlocked</div>
      <div id="status-steamunlocked" style="width: 10px; height: 10px; margin-left: 10px;  border-radius: 5px;"></div>
    </div>
  </div>

  <div id="storeList" class="vc" style="margin: 10px 30px;">

  </div>
</div>

<script>
  //MODULE NAME CAN'T BE CHANGED FREELY (SETTINGS MODULE, TRAY & MAIN.HTML) üò°
  storeModulePath = currentModule
  storeLastUpdated = 0

  refreshData()
  storeStatus = json.storeStatus
  if (storeStatus) {
    document.getElementById('status-container').style.height = 'auto'
    document.getElementById('status-container').style.opacity = '1'
  }
    

  document.getElementById('windowBackground').style.overflowY = 'scroll'
  setStoreListeners()

  ipcRenderer.on('specialData', (event, specialData) => {
    if (specialData == undefined) specialData = ''
    searchGames(specialData)
  })

  //SEARCH FUNCTIONS
  function searchGames(orSearch) {
    setbuttons()
    updateModules()
    setStoreListeners()
    searchingResults('elamigos')
    searchingResults('fitgirl')
    searchingResults('pivi')
    searchingResults('steamunlocked')
    if (orSearch == '')
      document.getElementById('title').innerHTML = 'Store'
    else
      document.getElementById('title').innerHTML = 'Store - '+orSearch
    document.getElementById('storeList').innerHTML = ''

    let search = orSearch.toLowerCase().replaceAll(' ', '+')
    let storeUpdated = Date.now()
    storeLastUpdated = storeUpdated

    let fullURL = 'https://www.elamigos-games.com/?q='+search
    if (search == '') fullURL = 'https://www.elamigos-games.com/'
    getHTMLAgent(fullURL).then(function(result) {
      if (result == undefined) noResults('elamigos')
      else elamigos(result, storeUpdated)
    })
    
    fullURL = 'https://fitgirlrepacks.co/search/'+search
    if (search == '' || search.length < 3) fullURL = 'https://fitgirlrepacks.co/'
    getHTMLAgent(fullURL).then(function(result) {
      if (result == undefined) noResults('fitgirl')
      else fitgirl(result, storeUpdated)
    })

    fullURL = 'https://pivigames.blog/?s='+search
    if (search == '') fullURL = 'https://pivigames.blog/'
    getHTMLAgent(fullURL).then(function(result) {
      if (result == undefined) noResults('pivi')
      else pivi(result, storeUpdated)
    })

    fullURL = 'https://steamunlocked.net/?s='+search
    if (search == '') fullURL = 'https://steamunlocked.net/'
    getHTMLAgent(fullURL).then(function(result) {
      if (result == undefined) noResults('steamunlocked')
      else steamunlocked(result, search, storeUpdated)
    })
  }
  
  async function getHTMLAgent(url) {
    //process.env.NODE_TLS_REJECT_UNAUTHORIZED = '0';
    const superagent = require('superagent')
    const response = await superagent.get(url).set('User-Agent', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.128 Safari/537.36').catch(function(err){ console.log(err) })
    if (response != undefined) return response.text
    else console.log('no va '+url)
  }

  //STORE FUNCTIONS
  function elamigos(result, storeUpdated) {
    if (currentModule != storeModulePath) return
    if (storeUpdated != storeLastUpdated) return
    let part = result.substring(result.indexOf('<div class="col-lg-2 '), result.indexOf('<!-- /.row -->'))
    var si = part.split('<div class="col-lg-2 ')
    var links = []
    var names = []
    var imgs = []
    var infos = []
    //LINKS & NAMES & IMAGES
    for(i in si) {
      if (links.length == 12) break
      let tmp = si[i].substring(si[i].lastIndexOf('href="')+6)
      tmp = tmp.substring(0, tmp.indexOf('<'))
      let link = tmp.substring(0, tmp.indexOf('"'))
      let name = tmp.substring(tmp.indexOf('>')+1)
      let img = si[i].substring(si[i].indexOf('src="')+5)
      img = 'https://www.elamigos-games.com'+img.substring(0, img.indexOf('"'))
      let info = si[i].substring(si[i].lastIndexOf('<small>')+7)
      info = info.substring(0, info.indexOf('</small>'))
      info = info.replaceAll('+', '').trim()
      if (link != '' && img != '' && link.startsWith('https://www.elamigos-games.com')) {
        links.push(link)
        names.push(titleCase(name))
        imgs.push(img)
        infos.push(info)
      }
    }
    //HAS RESULTS
    if (links.length != 0) createStore('elamigos', 'https://fitgirl-repacks.site/', 'ElAmigos')
    else noResults('elamigos')
    //ADD GAMES
    for(i in links) {
      let id = `elamigos${i}-${Date.now()}`
      let imgid = 'img-'+id
      let img = imgs[i]
      let link = links[i]
      let name = names[i]
      let info = infos[i]
      if (info != '') html = createStoreItemHTML2(id, imgid, img, name, info)
      else html = createStoreItemHTML(id, imgid, img, name)
      document.getElementById('list-elamigos').insertAdjacentHTML('beforeend', html)
      addListener(id, link, 'elamigos', name, info, imgid)
    }
    if (document.getElementById("list-elamigos").childNodes.length > 0) document.getElementById("list-elamigos").firstChild.click()
  }

  function fitgirl(result, storeUpdated) {
    if (currentModule != storeModulePath) return
    if (storeUpdated != storeLastUpdated) return
    if (!result.includes('<article class="post')) {
      noResults('fitgirl')
      return
    }
    
    let part = result.substring(result.indexOf('<article class="post'), result.indexOf('<nav class="navigation paging-navigation"'))
    var si = part.split('<article class="post')
    var links = []
    var names = []
    //LINKS & NAMES
    for(i in si) {
      let link = si[i].substring(si[i].indexOf('href="https://fitgirlrepacks.co/repack')+6)
      link = link.substring(0, link.indexOf('"'))
      let name = si[i].substring(si[i].indexOf('rel="bookmark">')+15)
      name = name.substring(0, name.indexOf('<'))
      if (link != '' && name != '' && name != 'Upcoming repacks') {
        links.push(link)
        names.push(titleCase(name))
      }
    }
    //HAS RESULTS
    if (links.length != 0) createStore('fitgirl', 'https://fitgirl-repacks.site/', 'Fitgirl')
    else noResults('fitgirl')
    //ADD GAMES
    for(i in links) {
      let id = `fitgirl${i}-${Date.now()}`
      let imgid = 'img-'+id
      let tmp = links[i]
      tmp = tmp.substring(tmp.lastIndexOf('/'))
      tmp = tmp.substring(tmp.indexOf('-')+1)
      let link = 'https://fitgirl-repacks.site/'+tmp
      let name = names[i]
      let name2 = ''
      let info = ''
      if (name.includes('&#8211;')) {
        name2 = name.substring(0, name.indexOf('&#8211;')).trim()
        info = name.substring(name.indexOf('&#8211;')+7).trim()
      }
      let html
      if (name2 != '' && info != '') html = createStoreItemHTML2(id, imgid, './Data/Images/iconFile.png', name2, info)
      else html = createStoreItemHTML(id, imgid, './Data/Images/iconFile.png', name)
      document.getElementById('list-fitgirl').insertAdjacentHTML('beforeend', html)
      if (name2 != '') addListener(id, link, 'fitgirl', name2, info, imgid)
      else addListener(id, link, 'fitgirl', name, info, imgid)
      //IMAGE
      fitgirlImg(links[i]).then((image) =>{ 
        if (document.getElementById(imgid) != null)
        document.getElementById(imgid).style.backgroundImage = `url('${image}')`
        if (document.getElementById('link-fitgirl').innerHTML == link)
        document.getElementById('featured-fitgirl').style.backgroundImage = `url('${image}')`
      })
    }
    if (document.getElementById("list-fitgirl").childNodes.length > 0) document.getElementById("list-fitgirl").firstChild.click()

    async function fitgirlImg(link) {
      const superagent = require('superagent');
      const response = await superagent.get(link)
      let html = response.text
      
      let img = html.substring(html.indexOf('<h1 class="entry-title">'))
      img = img.substring(img.indexOf('src="')+5)
      img = img.substring(0, img.indexOf('"'))
      return img
    }
  }

  function pivi(result, storeUpdated) {
    if (currentModule != storeModulePath) return
    if (storeUpdated != storeLastUpdated) return
    let part = result.substring(result.indexOf('<div id="gp-content-wrapper"')) //remove top bar
    part = part.substring(part.indexOf('<section class="gp-post-item gp-standard-post'))
    var si = part.split('<section')
    var links = []
    var names = []
    var imgs = []
    //LINKS & NAMES & IMAGES
    for(i in si) {
      let tmp = si[i].toLowerCase()
      if (!tmp.includes('>estrenos<') && !tmp.includes('>tops<') && !tmp.includes('>promociones<') && !tmp.includes('>oferta<') && !tmp.includes('>free to play<') && !tmp.includes('>destacadas<')) {
        let link = si[i].substring(si[i].indexOf('href="')+6)
        link = link.substring(0, link.indexOf('"')-1)
        let name = si[i].substring(si[i].indexOf('title="')+7)
        name = name.substring(0, name.indexOf('"'))
        let img = si[i].substring(si[i].indexOf('src="')+5)
        img = img.substring(0, img.indexOf('"'))
        if (link != '' && name != '' && !name.toLowerCase().startsWith('sorteo') && img != '' && link.startsWith('https://pivigames.blog/') && !links.includes(link)) {
          links.push(link)
          names.push(titleCase(name))
          imgs.push(img)
        }
      }
    }
    //HAS RESULTS
    if (links.length != 0) createStore('pivi', 'https://pivigames.blog/', 'Pivi')
    else noResults('pivi')
    //ADD GAMES
    for(i in links) {
      let id = `pivi${i}-${Date.now()}`
      let imgid = 'img-'+id
      let img = imgs[i]
      let link = links[i]
      let name = names[i]
      let name2 = ''
      let info = ''
      if (name.toLowerCase().includes('pc ')) {
        name2 = name.substring(0, name.toLowerCase().indexOf('pc ')).trim()
        info = name.substring(name.toLowerCase().indexOf('pc ')+2).replaceAll('+', '').trim()
      }
      if (name2 != '' && info != '') html = createStoreItemHTML2(id, imgid, img, name2, info)
      else html = createStoreItemHTML(id, imgid, img, name)
      document.getElementById('list-pivi').insertAdjacentHTML('beforeend', html)
      if (name2 != '') addListener(id, link, 'pivi', name2, info, imgid)
      else addListener(id, link, 'pivi', name, info, imgid)
    }
    if (document.getElementById("list-pivi").childNodes.length > 0) document.getElementById("list-pivi").firstChild.click()
  }

  function steamunlocked(result, search, storeUpdated) {
    if (currentModule != storeModulePath) return
    if (storeUpdated != storeLastUpdated) return
    var si
    if (search != '') {
      let part = result.substring(result.indexOf('class="cover-items"')) //remove top
      part = part.substring(0, part.indexOf('class="col-lg-4"')) //to bot
      si = part.split('class="cover-item category"')
    } else {
      let part = result.substring(result.indexOf('class="vc_pageable-slide-wrapper vc_clearfix"')) //remove top
      part = part.substring(0, part.indexOf('class="vc_pageable-load-more-btn"')) //to bot
      si = part.split('class="vc_grid-item vc_clearfix')
    }
    var links = []
    var names = []
    var imgs = []
    //LINKS & NAMES & IMAGES
    for(i in si) {
      if (links.length == 12) break
      let link = si[i].substring(si[i].indexOf('href="')+6)
      link = link.substring(0, link.indexOf('"')-1)
      let name
      if (search != '') {
        name = si[i].substring(si[i].indexOf('<h1>')+4)
        name = name.substring(0, name.indexOf('</h1>'))
      } else {
        name = si[i].substring(si[i].indexOf('title="')+7)
        name = name.substring(0, name.indexOf('"'))
      }
      let img = si[i].substring(si[i].lastIndexOf('src="')+5)
      img = img.substring(0, img.indexOf('"'))
      if (link != '' && name != '' && img != '') {
        links.push(link)
        names.push(titleCase(name))
        imgs.push(img)
      }
    }
    //HAS RESULTS
    if (links.length != 0) createStore('steamunlocked', 'https://steamunlocked.net/', 'Steam Unlocked')
    else noResults('steamunlocked')
    //ADD GAMES
    for(i in links) {
      let id = `steamunlocked${i}-${Date.now()}`
      let imgid = 'img-'+id
      let img = imgs[i]
      let link = links[i]
      let name = names[i]
      let name2 = ''
      let info = ''
      if (name.toLowerCase().includes('free download')) {
        name2 = name.substring(0, name.toLowerCase().indexOf('free download')).trim()
        info = name.substring(name.toLowerCase().indexOf('free download')+13).trim()
      }
      if (name2 != '' && info != '') html = createStoreItemHTML2(id, imgid, img, name2, info)
      else if (name2 != '') html = createStoreItemHTML(id, imgid, img, name2)
      else html = createStoreItemHTML(id, imgid, img, name)

      document.getElementById('list-steamunlocked').insertAdjacentHTML('beforeend', html)

      if (name2 != '') addListener(id, link, 'steamunlocked', name2, info, imgid)
      else addListener(id, link, 'steamunlocked', name, info, imgid)
    }
    if (document.getElementById("list-steamunlocked").childNodes.length > 0) document.getElementById("list-steamunlocked").firstChild.click()
  }

  //RESULTS FUNCTIONS
  function createStore(id, store, name) {
    document.getElementById('status-'+id).style.background = '#00ac25'
    let html = createStoreHTML(id, store, name)
    document.getElementById('storeList').insertAdjacentHTML('beforeend', html)

    addButtonListener('open-'+id, function() {
      let link = document.getElementById('link-'+id).innerHTML
      let name = document.getElementById('name-'+id).innerHTML
      if (name.includes('<div style')) name = name.substring(0, name.indexOf('<div style'))
      createNoti('Store:', name)
      openLink(link)
    })     

    addButtonListener('preview-'+id, function() {
      let link = document.getElementById('link-'+id).innerHTML
      let name = document.getElementById('name-'+id).innerHTML
      if (name.includes('<div style')) name = name.substring(0, name.indexOf('<div style'))
      createNoti('Store:', name)
      ipcRenderer.send('newSimpleWindow', link)
    })  
  }

  function searchingResults(id) {
    document.getElementById('status-'+id).style.background = 'var(--textSecondary)'
  }

  function noResults(id) {
    document.getElementById('status-'+id).style.background = '#C70039'
  }

  //HTML FUNCTIONS
  function titleCase(str) {
    var splitStr = str.toLowerCase().split(' ');
    for (var i = 0; i < splitStr.length; i++) {
      splitStr[i] = splitStr[i].charAt(0).toUpperCase() + splitStr[i].substring(1);     
    }
    return splitStr.join(' '); 
  }

  function createStoreItemHTML(id, img, icon, name) {
    return `<div class="button" id="${id}" style="width: 260px; min-height: 120px; display: flex; margin-left: 10px; margin-right: 8px;">
              <div id="${img}" style="min-width: 80px; min-height: 100px; margin: 10px; border-radius: inherit; box-shadow: inherit; background: url('${icon}'); background-size: cover; background-position: center; background-repeat: no-repeat;"></div>
              <div style="width: 150px; margin: 10px 10px 10px 0; display: flex; flex-direction: column;">
                <div id="name-${id}" style="width: 140px; margin: auto; display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; text-overflow: ellipsis; overflow: hidden; font-size: 15px; line-height: 17px;">${name}</div>
              </div>
            </div>`
  }

  function createStoreItemHTML2(id, img, icon, name, info) {
    return `<div class="button" id="${id}" style="width: 260px; min-height: 120px; display: flex; margin-left: 10px; margin-right: 8px;">
              <div id="${img}" style="min-width: 80px; min-height: 100px; margin: 10px; border-radius: inherit; box-shadow: inherit; background: url('${icon}'); background-size: cover; background-position: center; background-repeat: no-repeat;"></div>
              <div style="width: 150px; margin: 10px 10px 10px 0; display: flex; flex-direction: column;">
                <div id="name-${id}" style="width: 140px; margin: auto; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; text-overflow: ellipsis; overflow: hidden; font-size: 15px; line-height: 17px;">${name}</div>
                <div style="width: 140px; margin: auto; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; text-overflow: ellipsis; overflow: hidden; font-size: 13px; line-height: 15px; color: var(--textSecondary);">${info}</div>
              </div>
            </div>`
  }

  function createStoreHTML(id, store, name) {
    return `
    <div class="hc" style="margin-bottom: 5px; font-family: Main; font-weight: bold; align-items: center;">
      <div style="width: fit-content; padding: 5px; color: var(--textPrimary); font-size: 16px; line-height: 16px; white-space: nowrap;">‚óà</div>
      <div id="title-${id}" style="width: fit-content; padding: 5px; color: var(--textPrimary); font-size: 16px; line-height: 16px; white-space: nowrap;">${name}</div>
      <div id="more-${id}" class="button-elevated" onclick="openStore('${name}', '${store}')" style="width: fit-content; margin-left: auto; padding: 5px; color: var(--textPrimary); font-size: 16px; line-height: 16px; white-space: nowrap;">View All ‚ûú</div>
    </div>
    <div style="height: var(--storeListHeight); margin-bottom: 30px; display: flex;">
      <div id="featured-${id}" class="listFeatured">
        <div style="width: fit-content; max-width: 90%; height: fit-content; position: absolute; bottom: 0; display: flex; flex-direction: column;">
          <div style="width: 100%; height: 100%; position: absolute; border-radius: var(--buttonCornerRadius); border-top-left-radius: 0; border-bottom-right-radius: 0; background: var(--button); opacity: 0.3;"></div>
          <div style="width: 100%; height: 100%; position: absolute; border-radius: var(--buttonCornerRadius); border-top-left-radius: 0; border-bottom-right-radius: 0; box-shadow: 0 0 1rem 0 rgba(0, 0, 0, .2); backdrop-filter: blur(6px);"></div>
          <div style="width: 100%; height: 100%; position: relative; display: flex; flex-direction: column;">
            <div style="flex-grow: 1; margin: 20px; display: flex; align-items: center;">
              <div id="name-${id}" style="flex-grow: 1; font-size: 15px; line-height: normal; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 5; -webkit-box-orient: vertical;">Name</div>
              <div id="preview-${id}" class="button buttonEmoteText" style="min-width: 40px; height: 40px; margin: 0 10px 0 20px;">üëÄ</div>
              <div id="open-${id}" class="button buttonText" style="min-width: 100px; height: 40px;">Open</div>
              <div id="link-${id}" style="display: none;"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="listItems" id="list-${id}"></div>
    </div>`
  }

  //OTHER FUNCTIONS
  function setStoreListeners() {
    const storeResizeOb = new ResizeObserver(function(entries) {
      let contentW = document.getElementById('window').offsetWidth
      document.body.style.setProperty('--storeListHeight', contentW/2.7+'px')
    })
    storeResizeOb.observe(document.querySelector("#window"))

    addButtonListener('status', function() {
      if (storeStatus) {
        storeStatus = false
        $('#status-container').animate({height: '0'}, 200, function() {
          document.getElementById('status-container').style.opacity = '0'
        })
      } else {
        document.getElementById('status-container').style.opacity = '1'
        storeStatus = true
        var el = $('#status-container'),
        curHeight = el.height(),
        autoHeight = el.css('height', 'auto').height()
        el.height(curHeight).animate({height: autoHeight}, 200)
      }
      setData('storeStatus', storeStatus)
    })

    addButtonListener('discover', function() {
      searchGames('')
    })

    $('#editText').bind('keydown', function(event) {
      if (event.keyCode === 13) {
        event.preventDefault();
        let search = document.getElementById('editText').value
        if (search == '') return
        searchGames(search)
        return false;
      }
    })

    addButtonListener('search', function() {
      let search = document.getElementById('editText').value
      if (search == '') return
      searchGames(search)
    })
  }

  function addListener(id, link, store, name, info, img) {
    addButtonListener(id, function() {
      document.getElementById('featured-'+store).style.backgroundImage = document.getElementById(img).style.backgroundImage
      if (info == '') document.getElementById('name-'+store).innerHTML = name
      else document.getElementById('name-'+store).innerHTML = name+'<div style="font-size: 13px;"><br />'+info+'</div>'
      document.getElementById('link-'+store).innerHTML = link
    })

    addRightButtonListener(id, function() {
      let url = document.getElementById(img).style.backgroundImage
      ipcRenderer.send('newSimpleWindow', url.substring(5, url.length-2), false, true, 540, 540)
    })
  }

  function openStore(name, link) {
    createNoti('Store:', name+' Official Page')
    shell.openExternal(link)
  }

  function openLink(link) {
    shell.openExternal(link)
  }

  function addScroll(id) {
    $('#'+id).bind('wheel', function() {
      if ($('#'+id).hasScrollBar()) {
        this.scrollLeft -= (event.wheelDelta/1.5)
        event.preventDefault()
      }
    })
  }

  jQuery.fn.hasScrollBar = function(direction) {
    return this.get(0).scrollWidth > this.innerWidth();
  }
</script>