<div class="win-c">
  <div class="win-t">
    <div id="title" class="title">Installer</div>
  </div>

  <div class="hc" style="width: 100%;">
    <o-input id='path' placeholder="File Path" label="File Path" style="width: calc(100% - 50px); margin-right: 10px;"></o-input>
    <o-button id="pathFolder" content="box">
      <svg class="button-svg" viewBox="0 0 24 24" style="fill: #f0bd23;">
        <path d="M21.0169 7.99175C21.4148 8.55833 20.9405 9.25 20.2482 9.25H3C2.44772 9.25 2 8.80228 2 8.25V6.42C2 3.98 3.98 2 6.42 2H8.74C10.37 2 10.88 2.53 11.53 3.4L12.93 5.26C13.24 5.67 13.28 5.72 13.86 5.72H16.65C18.4546 5.72 20.0516 6.61709 21.0169 7.99175Z"/>
        <path d="M20.9834 10.75C21.5343 10.75 21.9815 11.1957 21.9834 11.7466L22 16.6503C22 19.6003 19.6 22.0003 16.65 22.0003H7.35C4.4 22.0003 2 19.6003 2 16.6503V11.7503C2 11.198 2.44771 10.7503 2.99999 10.7503L20.9834 10.75Z"/>
      </svg>
    </o-button>
  </div>
  
  <div class="hc" style="width: 100%; margin-top: 20px;">
    <o-input id='name' placeholder="Name (optional)" label="Name" max="30" style="width: 100%;"></o-input>
  </div>
  
  <div class="hc" style="width: 100%; margin-top: 20px;">
    <o-input id='destination' placeholder="Destination" label="Destination" style="width: calc(100% - 50px); margin-right: 10px;"></o-input>
    <o-button id="destinationFolder" content="box">
      <svg class="button-svg" viewBox="0 0 24 24" style="fill: #f0bd23;">
        <path d="M21.0169 7.99175C21.4148 8.55833 20.9405 9.25 20.2482 9.25H3C2.44772 9.25 2 8.80228 2 8.25V6.42C2 3.98 3.98 2 6.42 2H8.74C10.37 2 10.88 2.53 11.53 3.4L12.93 5.26C13.24 5.67 13.28 5.72 13.86 5.72H16.65C18.4546 5.72 20.0516 6.61709 21.0169 7.99175Z"/>
        <path d="M20.9834 10.75C21.5343 10.75 21.9815 11.1957 21.9834 11.7466L22 16.6503C22 19.6003 19.6 22.0003 16.65 22.0003H7.35C4.4 22.0003 2 19.6003 2 16.6503V11.7503C2 11.198 2.44771 10.7503 2.99999 10.7503L20.9834 10.75Z"/>
      </svg>
    </o-button>
  </div>
  
  <div id="installerLog" class="hc" style="height: 20px; font-size: 15px; line-height: 15px; margin: 20px 10px; align-items: center; color: var(--text1);">Log</div>
  
  <o-button id="install" style="width: 100%; justify-content: center;">Install</o-button>
</div>

<script>
  // /$$    /$$  /$$$$$$  /$$$$$$$  /$$$$$$  /$$$$$$  /$$$$$$$  /$$       /$$$$$$$$  /$$$$$$ 
  //| $$   | $$ /$$__  $$| $$__  $$|_  $$_/ /$$__  $$| $$__  $$| $$      | $$_____/ /$$__  $$
  //| $$   | $$| $$  \ $$| $$  \ $$  | $$  | $$  \ $$| $$  \ $$| $$      | $$      | $$  \__/
  //|  $$ / $$/| $$$$$$$$| $$$$$$$/  | $$  | $$$$$$$$| $$$$$$$ | $$      | $$$$$   |  $$$$$$ 
  // \  $$ $$/ | $$__  $$| $$__  $$  | $$  | $$__  $$| $$__  $$| $$      | $$__/    \____  $$
  //  \  $$$/  | $$  | $$| $$  \ $$  | $$  | $$  | $$| $$  \ $$| $$      | $$       /$$  \ $$
  //   \  $/   | $$  | $$| $$  | $$ /$$$$$$| $$  | $$| $$$$$$$/| $$$$$$$$| $$$$$$$$|  $$$$$$/
  //    \_/    |__/  |__/|__/  |__/|______/|__/  |__/|_______/ |________/|________/ \______/

  installer = getKey('installer')


  //  /$$$$$$   /$$$$$$  /$$$$$$$  /$$$$$$$$
  // /$$__  $$ /$$__  $$| $$__  $$| $$_____/
  //| $$  \__/| $$  \ $$| $$  \ $$| $$      
  //| $$      | $$  | $$| $$  | $$| $$$$$   
  //| $$      | $$  | $$| $$  | $$| $$__/   
  //| $$    $$| $$  | $$| $$  | $$| $$      
  //|  $$$$$$/|  $$$$$$/| $$$$$$$/| $$$$$$$$
  // \______/  \______/ |_______/ |________/

  //SETTINGS KEY
  if (installer == undefined) {
    installer = { destination: '' }
    setKey('installer', installer)
  }

  //SET DESTINATION
  if (installer.destination != undefined) 
    document.getElementById('destination').value = installer.destination

  //DEFAULT LOG
  installerLog('Logs Will Appear Here')


  // /$$       /$$$$$$  /$$$$$$  /$$$$$$$$ /$$$$$$$$ /$$   /$$ /$$$$$$$$ /$$$$$$$   /$$$$$$ 
  //| $$      |_  $$_/ /$$__  $$|__  $$__/| $$_____/| $$$ | $$| $$_____/| $$__  $$ /$$__  $$
  //| $$        | $$  | $$  \__/   | $$   | $$      | $$$$| $$| $$      | $$  \ $$| $$  \__/
  //| $$        | $$  |  $$$$$$    | $$   | $$$$$   | $$ $$ $$| $$$$$   | $$$$$$$/|  $$$$$$ 
  //| $$        | $$   \____  $$   | $$   | $$__/   | $$  $$$$| $$__/   | $$__  $$ \____  $$
  //| $$        | $$   /$$  \ $$   | $$   | $$      | $$\  $$$| $$      | $$  \ $$ /$$  \ $$
  //| $$$$$$$$ /$$$$$$|  $$$$$$/   | $$   | $$$$$$$$| $$ \  $$| $$$$$$$$| $$  | $$|  $$$$$$/
  //|________/|______/ \______/    |__/   |________/|__/  \__/|________/|__/  |__/ \______/
  
  //GET FILE
  clickListener('pathFolder', function() {
    ipcRenderer.send('getFile', '', '', 'fileGottenInstaller')
  })

  ipcRenderer.on('fileGottenInstaller', (event, text) => {
    if (text != '')
      document.getElementById('path').value = text
  })
  
  //GET DESTINATION
  clickListener('destinationFolder', function() {
    ipcRenderer.send('getFolder', '', '', 'folderGottenInstaller')
  })

  ipcRenderer.on('folderGottenInstaller', (event, text) => {
    if (text != '')
      document.getElementById('destination').value = text
  })

  //INSTALL
  clickListener('install', function() {
    //PATH
    let path = document.getElementById('path').value
    if (path == '') {
      installerLog('File Path is Necesary')
      return
    }
    //PATH EXISTS
    if (!fs.existsSync(path)) {
      installerLog('File Path Does Not Exist')
      return
    }
    //NAMES
    let name = document.getElementById('name').value
    let customName = true
    if (name == '') {
      name = path.substring(path.lastIndexOf('\\')+1)
      name = name.substring(0, name.lastIndexOf('.'))
      customName = false
    }
    //DESTINATION
    let destination = document.getElementById('destination').value
    if (destination == '') {
      installerLog('Destination is Necesary')
      return
    }
    //DESTINATION EXISTS
    if (!destination.endsWith('\\')) destination = destination+'\\'
    if (!fs.existsSync(destination)) {
      installerLog('Destination Does Not Exist')
      return
    }
    //DESTINATION IS VALID
    if (!fs.lstatSync(destination).isDirectory()) {
      installerLog('Destination Must be a Folder')
      return
    }
    installer.destination = destination
    //INSTALL
    ipcRenderer.send('pause')
    //CHECK IF FILE CONTAINS A FOLDER INSIDE
    exec = require('child_process').exec
    exec(`"${data.zip}" l "${path}" -x!*\\*`, function (error, stdOut, stdErr) {
      if (!(error || stdErr)) {
        if (stdOut.replaceAll('\r', '').replaceAll('\n', '').endsWith('0 files, 1 folders')) { 
          //HAS A FOLDER
          exec(`"${data.zip}" l -slt "${path}" -x!*\\*`, function (error, stdOut, stdErr) {
            if (!(error || stdErr)) {
              //GET FOLDER NAME
              let outSplit = stdOut.replaceAll('\r', '').split("\n")
              let paths = []
              for(i in outSplit) {
                if (outSplit[i].includes('Path = '))
                  paths.push(outSplit[i].substring(7))
              }  
              let insideFolderName = paths[paths.length-1]
              let finalDestination
              if (customName) finalDestination = destination+name+'\\'
              else finalDestination = destination+insideFolderName+'\\'
              //CHECK IF INSTALLED
              if (fs.existsSync(finalDestination)) {
                installerLog(name+' is Already Installed')
                ipcRenderer.send('resume')
                return
              }
              //INSTALL
              setKey('installer', installer) 
              installerLog('Installing '+name+'...')
              let tmpDestination = destination+'orion'+Date.now()+'\\'
              exec(`"${data.zip}" x "${path}" -o"${tmpDestination}"`, function (error, stdOut, stdErr) {
                if (!(error || stdErr)) {
                  fs.rename(tmpDestination+insideFolderName, finalDestination, function(err) {
                    if (!err) {
                      installerLog('Installation Successful')
                      createNoti('Installer', name+' Installed Successfully')
                      ipcRenderer.send('resume')
                      shell.showItemInFolder(finalDestination)
                      //REMOVE TEMP FOLDER
                      fs.rmdir(tmpDestination, function(err) {})
                    } else {
                      installerLog('An Error Ocurred While Renaming a Folder')
                      ipcRenderer.send('resume')
                    }
                  })
                } else {
                  installerLog('An Error Ocurred While Unzipping')
                  ipcRenderer.send('resume')
                }
              })
            } else {
              installerLog('An Error Ocurred While Reading the File ~2')
              ipcRenderer.send('resume')
            }
          })
        } else {
          //HAS NO FOLDER
          let finalDestination = destination+name+'\\'
          //CHECK IF INSTALLED
          if (fs.existsSync(finalDestination)) {
            installerLog(name+' is Already Installed')
            ipcRenderer.send('resume')
            return
          }
          //INSTALL
          setKey('installer', installer)
          installerLog('Installing '+name+'...')
          exec(`"${data.zip}" x "${path}" -o"${finalDestination}"`, function (error, stdOut, stdErr) {
            if (!(error || stdErr)) {
              installerLog('Installation Successful')
              createNoti('Installer', name+' Installed Successfully')
              ipcRenderer.send('resume')
              shell.showItemInFolder(finalDestination)
            } else {
              installerLog('An Error Ocurred While Unzipping')
              ipcRenderer.send('resume')
            }
          })
        }
      } else {
        installerLog('An Error Ocurred While Reading the File ~1')
        ipcRenderer.send('resume')
      }
    })
  })


  // /$$$$$$$$ /$$   /$$ /$$   /$$  /$$$$$$  /$$$$$$$$ /$$$$$$  /$$$$$$  /$$   /$$  /$$$$$$ 
  //| $$_____/| $$  | $$| $$$ | $$ /$$__  $$|__  $$__/|_  $$_/ /$$__  $$| $$$ | $$ /$$__  $$
  //| $$      | $$  | $$| $$$$| $$| $$  \__/   | $$     | $$  | $$  \ $$| $$$$| $$| $$  \__/
  //| $$$$$   | $$  | $$| $$ $$ $$| $$         | $$     | $$  | $$  | $$| $$ $$ $$|  $$$$$$ 
  //| $$__/   | $$  | $$| $$  $$$$| $$         | $$     | $$  | $$  | $$| $$  $$$$ \____  $$
  //| $$      | $$  | $$| $$\  $$$| $$    $$   | $$     | $$  | $$  | $$| $$\  $$$ /$$  \ $$
  //| $$      |  $$$$$$/| $$ \  $$|  $$$$$$/   | $$    /$$$$$$|  $$$$$$/| $$ \  $$|  $$$$$$/
  //|__/       \______/ |__/  \__/ \______/    |__/   |______/ \______/ |__/  \__/ \______/

  function installerLog(text) {
    document.getElementById('installerLog').innerText = `(${Date.now()}) `+text
  }
</script>