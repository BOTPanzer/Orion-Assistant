<style>
  .libraryButton {
    background: transparent;
    box-shadow: none;
  }
  
  .libraryButton:hover {
    background: var(--buttonHover);
  }
</style>

<div class="vc" style="padding: 2%;">
  <div id="content" class="vc">
    <div class="hc" style="width: 100%; align-items: center; margin-bottom: 20px;">
      <div id="title" style="padding-top: 10px; padding-bottom: 10px; color: var(--textPrimary); font-family: Special; font-size: 40px; line-height: 40px; text-overflow: ellipsis; white-space: nowrap; overflow: hidden;">Home</div>
      <div id="add" class="button" style="width: 40px; min-width: 40px; height: 40px; min-height: 40px; margin-left: 10px;">
        <svg class="svg" viewBox="0 0 24 24">
          <path d="M12 2C6.49 2 2 6.49 2 12C2 17.51 6.49 22 12 22C17.51 22 22 17.51 22 12C22 6.49 17.51 2 12 2ZM16 12.75H12.75V16C12.75 16.41 12.41 16.75 12 16.75C11.59 16.75 11.25 16.41 11.25 16V12.75H8C7.59 12.75 7.25 12.41 7.25 12C7.25 11.59 7.59 11.25 8 11.25H11.25V8C11.25 7.59 11.59 7.25 12 7.25C12.41 7.25 12.75 7.59 12.75 8V11.25H16C16.41 11.25 16.75 11.59 16.75 12C16.75 12.41 16.41 12.75 16 12.75Z"/>
        </svg>
      </div>
      <div style="flex-grow: 1;"></div>
      <div class="hc" style="min-width: 260px; margin-left: 10px;">
        <div id="items" class="button" style="width: 40px; min-width: 40px; height: 40px; min-height: 40px;">
          <svg class="svg" viewBox="0 0 24 24">
            <path d="M21.9707 5.5V9.5C21.9707 11.2615 20.6712 12.7232 18.9692 12.9649C18.6958 13.0038 18.4707 12.7761 18.4707 12.5V12.25C18.4707 8.53 15.4507 5.5 11.7207 5.5H11.4707C11.1946 5.5 10.9669 5.27486 11.0061 5.0015C11.2488 3.30678 12.7099 2 14.4707 2H18.4707C20.4107 2 21.9707 3.57 21.9707 5.5Z"/>
            <path d="M11.7207 7H10.9707H6.9707C4.2107 7 1.9707 9.24 1.9707 12V17C1.9707 19.76 4.2107 22 6.9707 22H11.9707C14.7307 22 16.9707 19.76 16.9707 17V13V12.25C16.9707 9.35 14.6207 7 11.7207 7Z"/>
          </svg>
        </div>
        <div class="button" style="min-width: 200px; margin-left: 10px;">
          <input id='editText' class="input" type="text" spellcheck="false" placeholder="Search" maxlength="30" style="width: 160px; padding-right: 0;"></input>
          <svg id="search" class="svg" viewBox="0 0 24 24">
            <path class="st0" d="M2.2,21.8c-0.3-0.3-0.3-0.7,0-1l1.9-1.9c0.3-0.3,0.7-0.3,1,0s0.3,0.7,0,1l-1.9,1.9C3.1,21.9,2.9,22,2.7,22S2.3,21.9,2.2,21.8z"/>
            <path class="st0" d="M21.7,9.1c-0.8-3.3-3.5-6-6.8-6.8C7.9,0.5,1.5,6.9,3.3,13.9c0.8,3.3,3.5,6,6.8,6.8C17.1,22.5,23.5,16.1,21.7,9.1z M18.6,10c-0.1-0.3,0.1-0.7,0.5-0.7c0.3-0.1,0.6,0.1,0.7,0.4c0.1,0.6,0.2,1.2,0.2,1.8c0,0.3,0,0.7-0.1,1c-0.1,0.4-0.5,0.5-0.8,0.5c-0.2-0.1-0.5-0.3-0.5-0.6l0,0c0-0.3,0.1-0.5,0.1-0.8C18.8,10.9,18.7,10.4,18.6,10z M12.5,19C8.4,19,5,15.6,5,11.5S8.4,4,12.5,4c2.4,0,4.6,1.2,6,3c0.2,0.3,0.2,0.7-0.1,0.9C18.1,8,17.7,8,17.5,7.7l0,0c-1.1-1.5-2.9-2.5-5-2.5C9,5.3,6.3,8,6.3,11.5s2.8,6.3,6.3,6.3c0.6,0,1.2-0.1,1.8-0.3l0,0c0.4-0.1,0.8,0,0.9,0.4c0.1,0.3-0.1,0.7-0.5,0.8C14,18.9,13.2,19,12.5,19z"/>
          </svg>
        </div>
      </div>
    </div>

    <div class="vc" id="launcherEmpty" style="width: 100%; align-items: center; line-height: normal; display: none;">
      <div style="font-size: 100px; margin-top: 20px;">ðŸ˜ž</div>
      <div style="font-size: 15px; color: var(--textPrimary);">Such Empty...</div>
      <div style="font-size: 15px; color: var(--textSecondary);">Try Importing From the [+] Button</div>
    </div>
    <div class="hc" id="launcherList" style="flex-wrap: wrap;">
    
    </div>
  </div>
</div>

<script>
  //MODULE NAME USED IN - TRAY & MAIN.HTML & SETTINGS ðŸ˜¡
  search = ''
  click = ''
  adding = false

  launcherFolder = currentModule+'Launcher\\'
  selecting = false
  selected = []
  timeId = ''
  time = 0
  
  document.getElementById('windowBackground').style.overflowY = 'scroll'
  refreshData()
  actualPath = json.actualPath
  itemLong = json.itemLong
  createList(actualPath)

  ipcRenderer.on('specialData', (event, specialData) => {
    //LOAD SPECIAL DATA PATH / RELOAD
    if (specialData == undefined)
      specialData = actualPath
    document.getElementById('content').style.minHeight = document.getElementById('content').offsetHeight+'px'
    createList(specialData)
  })

  ipcRenderer.on('changeIcon', (event, img, icon, path) => {
    if (actualPath == path) document.getElementById(img).src = icon
  })

  function startLauncher(s) {
    document.body.style.setProperty('--libraryItemSize', '0')
    const libraryResizeOb = new ResizeObserver(function(entries) {
    	let contentW = document.getElementById('launcherList').offsetWidth
      let i = 4
      while (contentW/i > 155) { i++ }
      document.body.style.setProperty('--libraryItemSize', 100/i+'%')
    })
    libraryResizeOb.observe(document.querySelector("#launcherList"))

    setbuttons()
    updateModules(false)
    adding = true

    selecting = false
    selected = []
    search = s

    ipcRenderer.send('resume')

    //ADD
    addButtonListener('add', function() {
      ipcRenderer.send('pause')
      ipcRenderer.send('newOrionWindow', currentModule+'add.html', false, 390, 150, true)
    })

    //ITEMS
    addButtonListener('items', function() {
      if (itemLong)
        itemLong = false
      else 
        itemLong = true
      setData('itemLong', itemLong)
      createList(actualPath, search)
    })

    //SEARCH
    $('#editText').bind('keydown', function(event) {
      if (event.keyCode === 13) {
        event.preventDefault()
        if (document.getElementById('editText').value != search) {
          $("#windowBackground").animate({ scrollTop: 0 }, "fast")
          createList(actualPath, document.getElementById('editText').value)
        }
        return false;
      }
    })

    addButtonListener('search', function() {
      if (document.getElementById('editText').value != search) {
        $("#windowBackground").animate({ scrollTop: 0 }, "fast")
        createList(actualPath, document.getElementById('editText').value)
      }
    })

    //CLEAR LIST
    document.getElementById('launcherEmpty').style.display = 'none'
    document.getElementById('launcherList').innerHTML = ''
  }

  function createList(argPath, search) {
    if (search == undefined) search = ''
    if (!fs.existsSync(argPath)) argPath = launcherFolder
    if (!argPath.startsWith(launcherFolder)) argPath = launcherFolder
    if (!argPath.endsWith('\\')) argPath = argPath+'\\'
    if (!fs.existsSync(argPath)) return
    startLauncher(search)
    //SET TITLE & LOCATION
    actualPath = argPath
    setData('actualPath', actualPath)
    let title = 'Home'
    if (actualPath != launcherFolder) title = actualPath.slice(0,-1).substring(actualPath.slice(0,-1).lastIndexOf("\\")+1)
    if (search != '') title = title+' - '+search
    document.getElementById('title').innerText = title
    //BACK BUTTON
    createBackButt(actualPath, search)
    //GET PATHS
    let paths = []
    if (search == '') {
      paths = fs.readdirSync(actualPath)
      rest()
    } else {
      var recursive = require("recursive-readdir")
      recursive(actualPath, function (err, files) {
        for(i in files) {
          let tmp = files[i].substring(actualPath.length)
          let tmp2 = files[i].substring(files[i].lastIndexOf('\\')+1)
          if (tmp2.endsWith('.txt')) tmp2 = tmp2.slice(0,-4)
          if (tmp2.toLowerCase().includes(search.toLowerCase()))
            paths.push(tmp)
        }
        rest()
      })
    }

    function rest() {
      //FIRST FOLDERS THEN FILES
      let folders = []
      let files = []
      for(i in paths) {
        let path = argPath+paths[i]
        if (fs.statSync(path).isFile()) {
          files.push(paths[i])
        } else {
          folders.push(paths[i])
        }
      }
      let allPaths = []
      for(i in folders) { allPaths.push(folders[i]) }
      for(i in files) { allPaths.push(files[i]) }
      //START
      if (actualPath == launcherFolder && allPaths.length == 0 && search == '') document.getElementById('launcherEmpty').style.display = 'Flex'
      else for(i in allPaths) {
        //DATA
        let path = argPath+allPaths[i]
        let data = getFileInfo(path)
        let isFile = data.isFile
        let name = data.name
        let gamePath = data.gamePath
        let iconPath = data.iconPath
        if (iconPath == undefined) iconPath = ''
        let pathClean = ''
        let argsClean = ''
        if (isFile) {
          let gamePathArg = getPathInfo(gamePath)
          pathClean = gamePathArg.pathClean
          argsClean = gamePathArg.argsClean
        }
        //ID
        let id = `game${i}`
        if (!isFile) id = `folder${i}`
        let img = `img${i}`
        //DEF IMAGE
        let icon = "./Data/Images/iconFolder.png"
        if (isFile) icon = "./Data/Images/iconFile.png"
        //CREATE HTML
        let html = createDataHTML(id, img, icon, path, isFile, name, gamePath, iconPath, pathClean, argsClean)
        document.getElementById('launcherList').insertAdjacentHTML('beforeend', html)
        //ADD LISTENER
        addListener(id, img)

        if (isFile) {
          if (iconPath == '') iconPath = pathClean
          if (fs.existsSync(iconPath) && fs.statSync(iconPath).isFile())
            ipcRenderer.send('requestIcon', img, iconPath, actualPath)
        }
      }
      adding = false
      document.getElementById('content').style.minHeight = ''
    }
  }

  function createBackButt(argPath, search) {
    if (search == '' && argPath == launcherFolder) return
    let bpath = argPath
    if (search == '' && argPath != launcherFolder) {
      //bpath
      if (bpath.endsWith("\\")) bpath = bpath.slice(0,-1)
      let numb = bpath.split("\\").length - 1
      if (numb > 1) bpath = bpath.substring(0, bpath.lastIndexOf("\\")+1)
    }
    //HTML
    let html = createDataHTML('backButt', 'backImg', './Data/Images/iconBack.png', bpath, 'false', 'Back', '', '', '', '')
    document.getElementById('launcherList').insertAdjacentHTML('beforeend', html)
    addListener('backButt', 'backImg')
  }

  function addListener(id, img) {
    let path = document.getElementById('path-'+id).innerText
    let isFile = true
    if (document.getElementById('isFile-'+id).innerText != 'true') isFile = false

    addCustomButtonListener(id, function() {
      if (adding) return
      //CLICK ELEMENT & SAVE IT'S ID & THE TIME OF CLICK
      time = Date.now()
      timeId = id
    }, function() {
      //IF ISN'T A CLICK & ISN'T SELECTING REMOVE CLICKED BG
      if ($("#"+id+":hover").length == 0 && !selecting) {
        //document.getElementById(id).removeAttribute('hover')
        document.getElementById('selected-'+id).style.visibility = 'hidden'
      }
    }, function() {
      if (adding) return
      //CHECK IF CLICK WAS LONG ENOUGH TO SELECT
      if (id != 'backButt' && timeId == id && time+300 < Date.now()) selecting = true
      //THEN IF SELECTING
      if (id != 'backButt' && selecting) {
        if (selected.includes(id)) {
          //ALREADY SELECTED
          const index = selected.indexOf(id);
          if (index > -1) {
            selected.splice(index, 1);
            if (selected.length == 0) selecting = false
            //document.getElementById(id).removeAttribute('hover')
            document.getElementById('selected-'+id).style.visibility = 'hidden'
          }
        } else {
          //ADD TO SELECTED
          selected.push(id)
          //document.getElementById(id).setAttribute('hover', '')
          document.getElementById('selected-'+id).style.visibility = 'visible'
        }
      } else {
        //NORMAL CLICK
        //document.getElementById(id).removeAttribute('hover')
        document.getElementById('selected-'+id).style.visibility = 'hidden'
        if (isFile) {
          let name = document.getElementById('name-'+id).innerText
          let pathClean = document.getElementById('pathClean-'+id).innerText
          let argsClean = document.getElementById('argsClean-'+id).innerText
          if (argsClean != '') argsClean = argsClean.split(",")
          openFile(id, name, pathClean, argsClean)
        } else {
          openFolder(path)
        }
      }
    })

    if (id != 'backButt')
    addRightButtonListener(id, function() {
      if (!selecting || selected.length == 1 && selected.includes(id)) {
        ipcRenderer.send('pause')
        if (isFile) {
          let argData = {}
          argData.path = path
          argData.src = document.getElementById(img).src
          argData.launcherFolder = launcherFolder
          ipcRenderer.send('newOrionWindow', currentModule+'context-file.html', false, 390, 380, true, argData)
        } else {
          let argData = {}
          argData.path = path
          argData.launcherFolder = launcherFolder
          ipcRenderer.send('newOrionWindow', currentModule+'context-folder.html', false, 390, 210, true, argData)
        }
      } else if (selected.includes(id)) {
        let paths = []
        for(i in selected) {
          paths.push(document.getElementById('path-'+selected[i]).innerText)
        }
        ipcRenderer.send('pause')
        let argData = {}
        argData.paths = paths
        argData.launcherFolder = launcherFolder
        ipcRenderer.send('newOrionWindow', currentModule+'context-multi.html', false, 390, 190, true, argData)
      }
    })
  }

  function createDataHTML(id, img, icon, path, isFile, name, gamePath, iconPath, pathClean, argsClean) {
    if (itemLong)
      return `<div id="${id}" class="button vc" style="width: calc(var(--libraryItemSize) - 6px); margin: 3px; flex-direction: column; position: relative;">
                <div id="path-${id}" style="display: none;">${path}</div>
                <div id="isFile-${id}" style="display: none;">${isFile}</div>
                <div id="gamePath-${id}" style="display: none;">${gamePath}</div>
                <div id="iconPath-${id}" style="display: none;">${iconPath}</div>
                <div id="pathClean-${id}" style="display: none;">${pathClean}</div>
                <div id="argsClean-${id}" style="display: none;">${argsClean}</div>
                <div class="vc" style="width: 100%; aspect-ratio: 1/1; align-items: center;">
                  <img id="${img}" style="width: 90%; margin: auto; aspect-ratio: 1/1; border-radius: var(--buttonCorner); filter: drop-shadow(var(--shadow)); object-fit: contain;" src="${icon}"></img>
                </div>
                <div class="vc" style="width: 100%; height: 50px; align-items: center;">
                  <div id="name-${id}" style="width: 90%; margin: auto; text-align: center; font-size: 15px; line-height: 18px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; color: var(--textColor);">${name}</div>
                </div>
                <div id="selected-${id}" class="hc" style="width: 100%; height: 100%; position: absolute; visibility: hidden;">
                  <svg class="svg" style="margin-left: auto;" viewBox="0 0 24 24">
                    <path d="M16.19 2H7.81C4.17 2 2 4.17 2 7.81V16.18C2 19.83 4.17 22 7.81 22H16.18C19.82 22 21.99 19.83 21.99 16.19V7.81C22 4.17 19.83 2 16.19 2ZM16.78 9.7L11.11 15.37C10.97 15.51 10.78 15.59 10.58 15.59C10.38 15.59 10.19 15.51 10.05 15.37L7.22 12.54C6.93 12.25 6.93 11.77 7.22 11.48C7.51 11.19 7.99 11.19 8.28 11.48L10.58 13.78L15.72 8.64C16.01 8.35 16.49 8.35 16.78 8.64C17.07 8.93 17.07 9.4 16.78 9.7Z"/>
                  </svg>
                </div>
              </div>`
    else 
      return `<div id="${id}" class="button vc" style="width: calc(var(--libraryItemSize) - 6px); aspect-ratio: 1/1; margin: 3px; flex-direction: column; position: relative;">
                <div id="path-${id}" style="display: none;">${path}</div>
                <div id="isFile-${id}" style="display: none;">${isFile}</div>
                <div id="gamePath-${id}" style="display: none;">${gamePath}</div>
                <div id="iconPath-${id}" style="display: none;">${iconPath}</div>
                <div id="pathClean-${id}" style="display: none;">${pathClean}</div>
                <div id="argsClean-${id}" style="display: none;">${argsClean}</div>
                <div class="vc" style="height: 65%;">
                  <img id="${img}" style="height: 90%; aspect-ratio: 1/1; margin: 5% auto 0 auto; border-radius: var(--buttonCorner); filter: drop-shadow(var(--shadow)); object-fit: contain;" src="${icon}"></img>
                </div>
                <div class="vc" style="height: 35%; align-items: center;">
                  <div id="name-${id}" style="width: 90%; margin: auto; text-align: center; font-size: 15px; line-height: 18px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; color: var(--textColor);">${name}</div>
                </div>
                <div id="selected-${id}" class="hc" style="width: 100%; height: 100%; position: absolute; visibility: hidden;">
                  <svg class="svg" style="margin-left: auto;" viewBox="0 0 24 24">
                    <path d="M16.19 2H7.81C4.17 2 2 4.17 2 7.81V16.18C2 19.83 4.17 22 7.81 22H16.18C19.82 22 21.99 19.83 21.99 16.19V7.81C22 4.17 19.83 2 16.19 2ZM16.78 9.7L11.11 15.37C10.97 15.51 10.78 15.59 10.58 15.59C10.38 15.59 10.19 15.51 10.05 15.37L7.22 12.54C6.93 12.25 6.93 11.77 7.22 11.48C7.51 11.19 7.99 11.19 8.28 11.48L10.58 13.78L15.72 8.64C16.01 8.35 16.49 8.35 16.78 8.64C17.07 8.93 17.07 9.4 16.78 9.7Z"/>
                  </svg>
                </div>
              </div>`
    
  }

  //GET
  function getFileInfo(argPath, fixed) {
    if (fixed == undefined) fixed = true
    let path = argPath
    if (path.endsWith('\\')) path = path.slice(0,-1)
    //isFile
    let isFile = false
    if (fs.statSync(argPath).isFile()) isFile = true
    //Name
    let name = argPath.substring(argPath.lastIndexOf("\\")+1)
    if (name.includes('.')) name = name.substring(0, name.lastIndexOf('.'))
    //File Stuff
    if (isFile) {
      let si = fs.readFileSync(argPath).toString().trim().split('\n')
      //Path
      let gamePath = si[0]
      if (gamePath != undefined) {
        gamePath = gamePath.replaceAll('\r', '')
        if (gamePath.startsWith('?:') && fixed) gamePath = gamePath.replace('?:', launcherFolder.substring(0, 2))
      }
      //Icon
      let iconPath = si[1]
      if (iconPath != undefined) {
        iconPath = iconPath.replaceAll('\r', '')
      }
      let data = {isFile, name, gamePath, iconPath}
      return data
    } else {
      let data = {isFile, name}
      return data
    }
  }

  function getPathInfo(gamePath) {
    //update add and context aswell
    gamePath = gamePath.trim()
    let pathClean = gamePath
    let argsClean = ''
    if (gamePath.includes('--') && gamePath.includes(' ') && !gamePath.endsWith('"')) {
      if (gamePath.startsWith('"') ) {
        pathClean = gamePath.substring(1, gamePath.lastIndexOf('"'))
        let args = gamePath.substring(pathClean.length+2).trim()
        argsClean = args.split(' ')
        argsClean.unshift("/c", pathClean)
      } else {
        pathClean = gamePath.substring(0, gamePath.lastIndexOf(' '))
        let args = gamePath.substring(pathClean.length+2).trim()
        argsClean = args.split(' ')
        argsClean.unshift("/c", pathClean)
      }
    }
    let data = {pathClean, argsClean}
    return data
  }

  //OPEN
  function openFile(id, name, pathClean, argsClean) {
    if (click == id) {
      if (argsClean != '') {
        let spawn = require("child_process").spawn;
        let bat = spawn("cmd.exe", argsClean)
      } else {
        ipcRenderer.send('showOnExplorer', pathClean, false)
      }
      createNoti('Launching:', name)
      click = ''
    } else {
      click = id
      setTimeout(function() {
        if (click == id) {
          click = ''
        }
      }, 500)
    }
  }

  function openFolder(path) {
    let scroll = document.getElementById('windowBackground').scrollTop
    if (scroll == 0) {
      createList(path)
    } else {
      $("#windowBackground").animate({ scrollTop: 0 }, "fast")
	    setTimeout(function() {
        createList(path)
      }, 150)
    }
  }
</script>