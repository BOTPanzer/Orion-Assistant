<div id="content" class="win-c">
  <div class="win-t">
    <div id="title" class="title">Home</div>
    <o-button id="libraryItems" content="box" style="margin-left: 10px;">
      <svg class="button-svg" viewBox="0 0 24 24">
        <path class="st0" d="M11,16.1v2.7c0,2.2-0.9,3.1-3.2,3.1H5.2C2.9,22,2,21.1,2,18.9v-2.7C2,13.9,2.9,13,5.2,13h2.7C10.1,13,11,13.9,11,16.1z"/>
        <path class="st0" d="M16.5,2h-8C5.5,2,3,4.5,3,7.5v3c0,0.6,0.5,1,1,1h4.5c2.2,0,4,1.8,4,4V20c0,0.5,0.4,1,1,1h3c3.5,0,5.5-2.1,5.5-5.5v-8C22,4.5,19.5,2,16.5,2z"/>
      </svg>
    </o-button>
    <o-button id="libraryAdd" content="box" style="margin-left: 10px;">
      <svg class="button-svg" viewBox="0 0 24 24">
        <path d="M12 2C6.49 2 2 6.49 2 12C2 17.51 6.49 22 12 22C17.51 22 22 17.51 22 12C22 6.49 17.51 2 12 2ZM16 12.75H12.75V16C12.75 16.41 12.41 16.75 12 16.75C11.59 16.75 11.25 16.41 11.25 16V12.75H8C7.59 12.75 7.25 12.41 7.25 12C7.25 11.59 7.59 11.25 8 11.25H11.25V8C11.25 7.59 11.59 7.25 12 7.25C12.41 7.25 12.75 7.59 12.75 8V11.25H16C16.41 11.25 16.75 11.59 16.75 12C16.75 12.41 16.41 12.75 16 12.75Z"/>
      </svg>
    </o-button>
    <div style="flex-grow: 1;"></div>
    <o-button content="box" style="margin-left: 10px;">
      <o-input id="librarySearchInput" style="width: 170px; margin-left: 10px;" placeholder="Search" label="Search" transparent></o-input>
      <svg id="librarySearch" class="button-svg" viewBox="0 0 24 24">
        <path class="st0" d="M2.2,21.8c-0.3-0.3-0.3-0.7,0-1l1.9-1.9c0.3-0.3,0.7-0.3,1,0s0.3,0.7,0,1l-1.9,1.9C3.1,21.9,2.9,22,2.7,22S2.3,21.9,2.2,21.8z"/>
        <path class="st0" d="M21.7,9.1c-0.8-3.3-3.5-6-6.8-6.8C7.9,0.5,1.5,6.9,3.3,13.9c0.8,3.3,3.5,6,6.8,6.8C17.1,22.5,23.5,16.1,21.7,9.1z M18.6,10c-0.1-0.3,0.1-0.7,0.5-0.7c0.3-0.1,0.6,0.1,0.7,0.4c0.1,0.6,0.2,1.2,0.2,1.8c0,0.3,0,0.7-0.1,1c-0.1,0.4-0.5,0.5-0.8,0.5c-0.2-0.1-0.5-0.3-0.5-0.6l0,0c0-0.3,0.1-0.5,0.1-0.8C18.8,10.9,18.7,10.4,18.6,10z M12.5,19C8.4,19,5,15.6,5,11.5S8.4,4,12.5,4c2.4,0,4.6,1.2,6,3c0.2,0.3,0.2,0.7-0.1,0.9C18.1,8,17.7,8,17.5,7.7l0,0c-1.1-1.5-2.9-2.5-5-2.5C9,5.3,6.3,8,6.3,11.5s2.8,6.3,6.3,6.3c0.6,0,1.2-0.1,1.8-0.3l0,0c0.4-0.1,0.8,0,0.9,0.4c0.1,0.3-0.1,0.7-0.5,0.8C14,18.9,13.2,19,12.5,19z"/>
      </svg>
    </o-button>
  </div>

  <div class="vc" id="libraryEmpty" style="width: 100%; align-items: center; line-height: normal; display: none;">
    <div style="font-size: 100px; margin-top: 20px;">üòû</div>
    <div style="font-size: 15px; color: var(--text1);">Such Empty...</div>
    <div style="font-size: 15px; color: var(--text2);">Try Importing From the (+) Button</div>
  </div>
  <div class="hc" id="libraryList" style="flex-wrap: wrap;">
  
  </div>
</div>

<script>
  //MODULE NAME USED IN - TRAY & MAIN.HTML & SETTINGS üò°

  // /$$    /$$  /$$$$$$  /$$$$$$$  /$$$$$$  /$$$$$$  /$$$$$$$  /$$       /$$$$$$$$  /$$$$$$ 
  //| $$   | $$ /$$__  $$| $$__  $$|_  $$_/ /$$__  $$| $$__  $$| $$      | $$_____/ /$$__  $$
  //| $$   | $$| $$  \ $$| $$  \ $$  | $$  | $$  \ $$| $$  \ $$| $$      | $$      | $$  \__/
  //|  $$ / $$/| $$$$$$$$| $$$$$$$/  | $$  | $$$$$$$$| $$$$$$$ | $$      | $$$$$   |  $$$$$$ 
  // \  $$ $$/ | $$__  $$| $$__  $$  | $$  | $$__  $$| $$__  $$| $$      | $$__/    \____  $$
  //  \  $$$/  | $$  | $$| $$  \ $$  | $$  | $$  | $$| $$  \ $$| $$      | $$       /$$  \ $$
  //   \  $/   | $$  | $$| $$  | $$ /$$$$$$| $$  | $$| $$$$$$$/| $$$$$$$$| $$$$$$$$|  $$$$$$/
  //    \_/    |__/  |__/|__/  |__/|______/|__/  |__/|_______/ |________/|________/ \______/

  libraryFolder = currentModule+'Library\\'
  librarySearch = ''
  adding = false
  selecting = false
  selected = []
  library = getKey('library')
  

  //  /$$$$$$   /$$$$$$  /$$$$$$$  /$$$$$$$$
  // /$$__  $$ /$$__  $$| $$__  $$| $$_____/
  //| $$  \__/| $$  \ $$| $$  \ $$| $$      
  //| $$      | $$  | $$| $$  | $$| $$$$$   
  //| $$      | $$  | $$| $$  | $$| $$__/   
  //| $$    $$| $$  | $$| $$  | $$| $$      
  //|  $$$$$$/|  $$$$$$/| $$$$$$$/| $$$$$$$$
  // \______/  \______/ |_______/ |________/

  //SHOW SCROLLBAR
  document.getElementById('window').style.overflowY = 'scroll'

  //SETTINGS KEY
  if (library == undefined) {
    library = { path: libraryFolder, smallItems: false }
    setKey('library', library)
  }

  //LIBRARY FOLDER
  if (!fs.existsSync(libraryFolder)) fs.mkdirSync(libraryFolder)


  // /$$       /$$$$$$  /$$$$$$  /$$$$$$$$ /$$$$$$$$ /$$   /$$ /$$$$$$$$ /$$$$$$$   /$$$$$$ 
  //| $$      |_  $$_/ /$$__  $$|__  $$__/| $$_____/| $$$ | $$| $$_____/| $$__  $$ /$$__  $$
  //| $$        | $$  | $$  \__/   | $$   | $$      | $$$$| $$| $$      | $$  \ $$| $$  \__/
  //| $$        | $$  |  $$$$$$    | $$   | $$$$$   | $$ $$ $$| $$$$$   | $$$$$$$/|  $$$$$$ 
  //| $$        | $$   \____  $$   | $$   | $$__/   | $$  $$$$| $$__/   | $$__  $$ \____  $$
  //| $$        | $$   /$$  \ $$   | $$   | $$      | $$\  $$$| $$      | $$  \ $$ /$$  \ $$
  //| $$$$$$$$ /$$$$$$|  $$$$$$/   | $$   | $$$$$$$$| $$ \  $$| $$$$$$$$| $$  | $$|  $$$$$$/
  //|________/|______/ \______/    |__/   |________/|__/  \__/|________/|__/  |__/ \______/

  ipcRenderer.on('specialData', (event, specialData) => {
    document.getElementById('content').style.minHeight = document.getElementById('content').offsetHeight+'px'
    createList(specialData)
  })

  ipcRenderer.on('requestedIcon', (event, img, icon, tag) => {
    if (library.path == tag && icon != '') 
      document.getElementById(img).src = icon
  })

  //ADD
  clickListener('libraryAdd', function() {
    let dialogid = createDialog(fs.readFileSync(currentModule+'add.html').toString(), 'Add Games/Folders')

    //PREPARE DIALOG
    importMax = 0
    imported = 0
    importFolder = 0
    
    function createGame(name, path, icon, importing) {
      if (name == undefined) name = 'Game '+Date.now()
      if (path == undefined) path = ''
      if (icon == undefined) icon = ''
      if (path.startsWith('"') && path.endsWith('"')) path = path.substring(1, path.length-1)
      
      let filePath = library.path+name+'.json'
      let data = {}
      data.path = path
      data.icon = icon
      
      if (!fs.existsSync(filePath)) {
        //CREATE FOLDER IN CASE IT DOESN'T EXIST
        fs.mkdir(filePath.substring(0, filePath.lastIndexOf('\\')), { recursive: true }, (err) => {
          //CREATE GAME
          fs.writeFile(filePath, JSON.stringify(data, null, 2), (err) => {
            if (importing) 
              importClose()
            else {
              closeDialog(dialogid)
              createList('refresh')
            }
          })
        })
      } else {
        if (importing) importClose()
        else createNoti('Library', `"${name}" Already Exists`)
      }
    }

    function importClose() {
      imported++
      if (importMax == imported) {
        ipcRenderer.send('resume')
        closeDialog(dialogid)
        createList('refresh')
      }
    }
 
    //DIALOG LISTENERS
    clickListener('folder', function() {
      setDialogTitle(dialogid, 'Add Folder')
      document.getElementById('addWindow').style.display = 'none'
      document.getElementById('folderWindow').style.display = 'flex'
    })
  
    $('#folderName').on('keydown', function(event) {
      if (event.keyCode === 13) {
        event.preventDefault()
        document.getElementById('folderAdd').click()
        return false
      }
    })

    clickListener('folderAdd', function() {
      let name = document.getElementById('folderName').value.trim()
      if (name == '') {
        createNoti('Library', 'Name Is Necesary')
        return
      }
        
      let fullName = library.path+name
      if (!fs.existsSync(fullName)) {
        fs.mkdirSync(fullName)
        closeDialog(dialogid)
        createList('refresh')
      } else createNoti('Library', `"${name}" Already Exists`)
    })

    clickListener('game', function() {
      setDialogTitle(dialogid, 'Add Game')
      document.getElementById('addWindow').style.display = 'none'
      document.getElementById('gameWindow').style.display = 'flex'
    })

    clickListener('gamePathFolder', function() {
      let a = document.getElementById('gamePath').value
      let gamePathArg = getPathInfo(a)
      let path = gamePathArg.pathClean.substring(0, gamePathArg.pathClean.lastIndexOf('\\')+1)
      ipcRenderer.send('getFile', path, 'Choose a Game', 'requestedGame')
    })
  
    ipcRenderer.removeAllListeners('requestedGame')
    ipcRenderer.on('requestedGame', (event, path) => {
      if (path != '')
        document.getElementById('gamePath').value = path
      if (document.getElementById('gameName').value == '')
        document.getElementById('gameName').value = path.substring(path.lastIndexOf('\\')+1)
    })
    
    clickListener('gameIconFolder', function() {
      let a = document.getElementById('gamePath').value
      if (document.getElementById('gameIcon').value != '') a = document.getElementById('gameIcon').value
      let gamePathArg = getPathInfo(a)
      let path = gamePathArg.pathClean.substring(0, gamePathArg.pathClean.lastIndexOf('\\')+1)
      ipcRenderer.send('getFile', path, 'Choose an Icon', 'requestedGameIcon')
    })

    ipcRenderer.removeAllListeners('requestedGameIcon')
    ipcRenderer.on('requestedGameIcon', (event, path) => {
      if (path == '') return
      ipcRenderer.send('getBase64', path, path)
    })

    ipcRenderer.removeAllListeners('requestedBase64')
    ipcRenderer.on('requestedBase64', async (event, base64, tag) => {
      if (base64 == '') 
        document.getElementById('gameIcon').value = tag
      else {
        const result = await resizeBase64Image(base64)
        document.getElementById('gameIcon').value = result
      }
    })

    clickListener('gameAdd', function() {
      let name = document.getElementById('gameName').value.trim()
      if (name == '') {
        createNoti('Library', 'Name Is Necesary')
        return
      }
      let path = document.getElementById('gamePath').value.trim()
      if (path == '') {
        createNoti('Library', 'Path Is Necesary')
       return
      }
      let icon = document.getElementById('gameIcon').value.trim()
  
      createGame(name, path, icon, false)
    })

    clickListener('import', function() {
      ipcRenderer.send('getFolder', '', 'Folder to Import Shortcuts From', 'requestedImportFolder')
    })
  
    ipcRenderer.removeAllListeners('requestedImportFolder')
    ipcRenderer.on('requestedImportFolder', (event, folderPath) => {
      if (folderPath == '') return
      var recursive = require("recursive-readdir")
      recursive(folderPath, function (err, files) {
        if (err) {
          createNoti('Library', 'Error Reading Folder')
          return
        }
        //GET NUMBER OF SHORTCUTS TO IMPORT
        let shortcuts = []
        for(i in files) {
          if (files[i].toLowerCase().endsWith('.lnk') || files[i].toLowerCase().endsWith('.url')) {
            importMax++
            shortcuts.push(files[i])
          }
        }
        if (importMax == 0) {
          createNoti('Library', 'Nothing to Import')
          return
        }
        //CREATE LIST
        const path = require("path")
        for(i in shortcuts) {
          let name = path.basename(shortcuts[i])
          if (name.includes('.')) name = name.substring(0, name.lastIndexOf('.'))
          let id = 'short'+i
          let short = shortcuts[i]
          document.getElementById('importList').insertAdjacentHTML('beforeend', 
          `<o-button id="${id}" style="width: 100%; justify-content: center;">${name}</o-button>`)
          clickListener(id, function() {
            let index = shortcuts.indexOf(short)
            if (index == -1) return
            shortcuts.splice(index, 1)
            importMax--
            document.getElementById(id).remove()
            if (shortcuts.length == 0) closeDialog(dialogid)
          })
        }
        //SHOW IMPORT WINDOW
        setDialogTitle(dialogid, 'Import')
        document.getElementById('addWindow').style.display = 'none'
        document.getElementById('importWindow').style.display = 'flex'
        //ADD IMPORT LISTENER
        clickListener('importImport', function() {
          ipcRenderer.send('pause')
          setDialogTitle(dialogid, 'Importing...')
          //IMPORT SHORTCUTS
          for(i in shortcuts) {
            let shortcut = shortcuts[i]
            let name = shortcut.substring(folderPath.length)
            name = name.substring(0, name.length-4)
            if (shortcut.toLowerCase().endsWith('.lnk')) {
              //LNK
              try {
                let short = shell.readShortcutLink(shortcut)
                let target = short.target
                if (short.args != '') target = `"${target}" ${short.args}`
                let icon = short.icon
                if (target == icon) icon = ''
                createGame(name, target, icon, true)
              } catch(e) {
                importClose()
              }
            } else if (shortcut.toLowerCase().endsWith('.url')) {
              //URL
              let shdata = fs.readFileSync(shortcut).toString().split('\r\n')
              let path = ''
              let icon = ''
              for (i in shdata) {
                let str = shdata[i]
                if (str.startsWith('URL=')) path = str.substring(4)
                if (str.startsWith('IconFile=')) icon = str.substring(9)
              }
              if (path != '') createGame(name, path, icon, true)
              else importClose()
            }
          }
        })
      })
    })
  })

  //ITEMS
  clickListener('libraryItems', function() {
    if (library.smallItems)
      library.smallItems = false
    else 
      library.smallItems = true
    setKey('library', library)
    createList('refresh', librarySearch)
  })

  //SEARCH
  keydownListener('librarySearchInput', function() {
    if (event.which != 13) return
    event.preventDefault()
    let search = document.getElementById('librarySearchInput').value
    if (search == '') return
    createList('refresh', search)
  })

  clickListener('librarySearch', function() {
    let search = document.getElementById('librarySearchInput').value
    if (search == '') return
    createList('refresh', search)
  })


  // /$$$$$$$$ /$$   /$$ /$$   /$$  /$$$$$$  /$$$$$$$$ /$$$$$$  /$$$$$$  /$$   /$$  /$$$$$$ 
  //| $$_____/| $$  | $$| $$$ | $$ /$$__  $$|__  $$__/|_  $$_/ /$$__  $$| $$$ | $$ /$$__  $$
  //| $$      | $$  | $$| $$$$| $$| $$  \__/   | $$     | $$  | $$  \ $$| $$$$| $$| $$  \__/
  //| $$$$$   | $$  | $$| $$ $$ $$| $$         | $$     | $$  | $$  | $$| $$ $$ $$|  $$$$$$ 
  //| $$__/   | $$  | $$| $$  $$$$| $$         | $$     | $$  | $$  | $$| $$  $$$$ \____  $$
  //| $$      | $$  | $$| $$\  $$$| $$    $$   | $$     | $$  | $$  | $$| $$\  $$$ /$$  \ $$
  //| $$      |  $$$$$$/| $$ \  $$|  $$$$$$/   | $$    /$$$$$$|  $$$$$$/| $$ \  $$|  $$$$$$/
  //|__/       \______/ |__/  \__/ \______/    |__/   |______/ \______/ |__/  \__/ \______/
  
  //START
  function startLibrary(s) {
    document.body.style.setProperty('--libraryItemSize', '0')
    const libraryResizeOb = new ResizeObserver(function(entries) {
      let i = 1
      while (document.getElementById('libraryList').offsetWidth/i > 155) { i++ }
      document.body.style.setProperty('--libraryItemSize', 100/i+'%')
    })
    libraryResizeOb.observe(document.querySelector("#libraryList"))
    
    adding = true
    selecting = false
    selected = []
    librarySearch = s

    $('#libraryList *').off()
    $(window).off('mouseup')

    ipcRenderer.send('resume')

    //CLEAR LIST
    document.getElementById('libraryEmpty').style.display = 'none'
    document.getElementById('libraryList').innerHTML = ''
  }

  function createList(argPath, search) {
    if (search == undefined) search = ''
    if (argPath == undefined || argPath == 'refresh') argPath = library.path
    if (!fs.existsSync(argPath)) argPath = libraryFolder
    if (!argPath.startsWith(libraryFolder)) argPath = libraryFolder
    if (!argPath.endsWith('\\')) argPath = argPath+'\\'
    startLibrary(search)
    //SET TITLE & SAVE PATH
    library.path = argPath
    setKey('library', library)
    let title = 'Home'
    if (library.path != libraryFolder) title = library.path.slice(0,-1).substring(library.path.slice(0,-1).lastIndexOf("\\")+1)
    if (search != '') title = title+' - '+search
    document.getElementById('title').innerText = title
    //BACK BUTTON
    createBackButt(library.path, search)
    //GET PATHS
    let paths = []
    if (search == '') {
      paths = fs.readdirSync(library.path)
      addGames(argPath, paths)
    } else {
      var recursive = require("recursive-readdir")
      recursive(library.path, function (err, files) {
        for(i in files) {
          let tmp = files[i].substring(library.path.length)
          let tmp2 = files[i].substring(files[i].lastIndexOf('\\')+1)
          if (tmp2.endsWith('.txt')) tmp2 = tmp2.slice(0,-4)
          if (tmp2.toLowerCase().includes(search.toLowerCase()))
            paths.push(tmp)
        }
        addGames(argPath, paths)
      })
    }
  }

  function addGames(argPath, paths) {
    //FIRST FOLDERS THEN FILES
    let folders = []
    let files = []
    for(i in paths) {
      let path = argPath+paths[i]
      if (fs.statSync(path).isFile())
        files.push(paths[i])
      else
        folders.push(paths[i])
    }
    let allPaths = []
    for(i in folders) { allPaths.push(folders[i]) }
    for(i in files) { allPaths.push(files[i]) }
    //START
    let gamesCreated = 0
    for(i in allPaths) {
      //DATA
      let filePath = argPath+allPaths[i]
      let data = getFileInfo(filePath)
      if (data == undefined) continue
      gamesCreated++
      let isFile = data.isFile
      let name = data.name
      let path = data.path
      let pathClean = data.pathClean
      let pathArgs = data.pathArgs
      let icon = data.icon
      let admin = data.admin
      //ID
      let id = `folder${i}`
      if (isFile) id = `game${i}`
      let img = `img${i}`
      //ADD HTML & LISTENER
      if (!isFile) document.getElementById('libraryList').insertAdjacentHTML('beforeend', createDataHTML(id, img, "./Data/Images/iconFolder.png", filePath, admin, isFile, name, path, icon, pathClean, pathArgs))
      else document.getElementById('libraryList').insertAdjacentHTML('beforeend', createDataHTML(id, img, "./Data/Images/iconFile.png", filePath, isFile, admin, name, path, icon, pathClean, pathArgs))
      addListener(id, img)
      //CHANGE IMAGE
      if (!isFile) continue
      if (icon == '')
        ipcRenderer.send('getIcon', img, pathClean, library.path)
      else
        ipcRenderer.send('getIcon', img, icon, library.path)
    }
    adding = false
    document.getElementById('content').style.minHeight = ''
    if (library.path == libraryFolder && librarySearch == '' && gamesCreated == 0) document.getElementById('libraryEmpty').style.display = 'Flex'
  }

  function createBackButt(argPath, search) {
    if (search == '' && argPath == libraryFolder) return
    let bpath = argPath
    if (search == '' && argPath != libraryFolder) {
      //bpath
      if (bpath.endsWith("\\")) bpath = bpath.slice(0,-1)
      let numb = bpath.split("\\").length - 1
      if (numb > 1) bpath = bpath.substring(0, bpath.lastIndexOf("\\")+1)
    }
    //HTML
    let html = createDataHTML('backButt', 'backImg', './Data/Images/iconBack.png', bpath, 'false', 'asAdmin', 'Back', '', '', '', '')
    document.getElementById('libraryList').insertAdjacentHTML('beforeend', html)
    addListener('backButt', 'backImg')
  }

  function addListener(id, img) {
    let filePath = document.getElementById('filePath-'+id).innerText
    let isFile = true
    if (document.getElementById('isFile-'+id).innerText != 'true') isFile = false

    longpressListener(id, function() {
      if (!selecting) selecting = true
    }, 300)

    clickListener(id, function() {
      if (selecting) {
        if (selected.includes(id)) {
          //ALREADY SELECTED
          selected.splice(selected.indexOf(id), 1)
          document.getElementById('selected-'+id).style.visibility = 'hidden'
          if (selected.length == 0) selecting = false
        } else {
          //ADD TO SELECTED
          selected.push(id)
          document.getElementById('selected-'+id).style.visibility = 'visible'
        }
      } else if (!isFile) {
        //FOLDER
        openFolder(filePath)
      }
    })

    duobleClickListener(id, function() {
      if (!selecting && isFile) {
        //OPEN AS ADMIN
        let asAdmin = false
        if (document.getElementById('asAdmin-'+id).innerText == 'true') asAdmin = true
        //NAME
        let name = document.getElementById('name-'+id).innerText
        //PATH & ARGS
        let pathClean = document.getElementById('pathClean-'+id).innerText
        let argsClean = document.getElementById('pathArgs-'+id).innerText
        if (argsClean != '') argsClean = argsClean.split(",")
        openFile(id, asAdmin, name, pathClean, argsClean)
      }
    })

    if (id != 'backButt') 
    contextListener(id, function() {
      if (selected.length > 1 && selected.includes(id)) {
        //SELECTED MULTIPLE
        multiDialog()
      } else if (!selecting || selected.length == 1 && selected.includes(id)) {
        if (isFile) {
          //SELECTED FILE
          fileDialog()
        } else {
          //SELECTED FOLDER
          folderDialog()
        }
      }

      //DIALOGS
      function multiDialog() {
        let dialogid = createDialog(fs.readFileSync(currentModule+'multi.html').toString())

        //PREPARE DIALOG
        const path = require("path")
        let paths = []
        for(i in selected) {
          paths.push(document.getElementById('filePath-'+selected[i]).innerText)
          let name = path.basename(paths[i])
          if (document.getElementById('isFile-'+selected[i]).innerText == 'true') {
            name = 'üìÑ ¬∑ '+name
            if (name.includes('.')) name = name.substring(0, name.lastIndexOf('.'))
          } else name = 'üìÅ ¬∑ '+name
          document.getElementById('multiList').insertAdjacentHTML('beforeend', 
          `<o-button style="width: 100%; justify-content: center;">${name}</o-button>`)
        }
        setDialogTitle(dialogid, paths.length+' Games/Folders Selected')

        //DIALOG LISTENERS
        clickListener('multiMove', function() {
          ipcRenderer.send('getFolder', library.path, 'Choose a Folder', 'multiMoveDestination')
        })

        ipcRenderer.removeAllListeners('multiMove')
        ipcRenderer.on('multiMove', (event, destination) => {
          moveFiles(paths, destination, dialogid)
        })

        clickListener('multiRemove', function() {
          document.getElementById('removeTitle').innerHTML = 'Remove ' + paths.length + ' Games/Folders?'
          document.getElementById('multiWindow').style.display = 'none'
          document.getElementById('removeWindow').style.display = 'flex'
        })

        clickListener('removeRemove', function() {
          removeFiles(paths, dialogid)
        })

        clickListener('removeCancel', function() {
          document.getElementById('multiWindow').style.display = 'flex'
          document.getElementById('removeWindow').style.display = 'none'
        })
      }
    
      function fileDialog() {
        let dialogid = createDialog(fs.readFileSync(currentModule+'file.html').toString(), 'Game Properties')

        //PREPARE DIALOG
        let paths = [filePath]
        let fileInfo = getFileInfo(filePath)
        let oldName = fileInfo.name
        let oldPath = fileInfo.path
        let oldPathClean = fileInfo.pathClean
        let oldIcon = fileInfo.icon
        let oldAdmin = fileInfo.admin
        let admin = oldAdmin
        document.getElementById('fileName').value = oldName
        document.getElementById('filePath').value = oldPath
        if (!fs.existsSync(oldPathClean)) 
          document.getElementById('fileShow').style.display = 'none'
        document.getElementById('fileIcon').value = oldIcon
        document.getElementById('fileImg').src = document.getElementById(img).src
        refreshIcon()
        if (admin) 
          document.getElementById('fileAdmin').checked = 'true'

        //DIALOG LISTENERS
        clickListener('filePathFolder', function() {
          let value = document.getElementById('filePath').value
          let pathInfo = getPathInfo(value)
          let path = pathInfo.pathClean.substring(0, pathInfo.pathClean.lastIndexOf('\\')+1)
          ipcRenderer.send('getFile', path, 'Choose a Game', 'requestedFile')
        })

        ipcRenderer.removeAllListeners('requestedFile')
        ipcRenderer.on('requestedFile', (event, path) => {
          if (path != '')
            document.getElementById('filePath').value = path
          if (document.getElementById('fileName').value == '')
            document.getElementById('fileName').value = path.substring(path.lastIndexOf('\\')+1)
          refreshIcon()
        })
        
        clickListener('fileIconFolder', function() {
          let value = document.getElementById('fileIcon').value
          if (value == '') value = document.getElementById('filePath').value
          let pathInfo = getPathInfo(value)
          let path = pathInfo.pathClean.substring(0, pathInfo.pathClean.lastIndexOf('\\')+1)
          ipcRenderer.send('getFile', path, 'Choose an Icon', 'requestedFileIcon')
        })

        ipcRenderer.removeAllListeners('requestedFileIcon')
        ipcRenderer.on('requestedFileIcon', (event, path) => {
          if (path == '') return
          ipcRenderer.send('getBase64', path, path)
        })

        ipcRenderer.removeAllListeners('requestedBase64')
        ipcRenderer.on('requestedBase64', async function(event, base64, tag) {
          if (base64 == '') 
            document.getElementById('fileIcon').value = tag
          else {
            const result = await resizeBase64Image(base64)
            document.getElementById('fileIcon').value = result
          }
          refreshIcon()
        }) 
        
        clickListener('fileAdmin', function() {
          admin = !admin
          let gameData = JSON.parse(fs.readFileSync(filePath))
          gameData.admin = admin
          fs.writeFileSync(filePath, JSON.stringify(gameData, null, 2))
        })  

        clickListener('fileShow', function() {
          shell.showItemInFolder(oldPathClean)
        })  

        clickListener('fileStore', function() {
          loadModule('Store', oldName)
          closeDialog(dialogid)
        })
  
        clickListener('fileMove', function() {
          ipcRenderer.send('getFolder', library.path, 'Choose a Folder', 'fileMove')
        })

        ipcRenderer.removeAllListeners('fileMove')
        ipcRenderer.on('fileMove', (event, destination) => {
          moveFiles(paths, destination, dialogid)
        })
          
        clickListener('fileRemove', function() {
          document.getElementById('removeTitle').innerHTML = 'Remove "' + oldName + '"?'
          document.getElementById('fileWindow').style.display = 'none'
          document.getElementById('removeWindow').style.display = 'flex'
        })
        
        clickListener('removeRemove', function() {
          removeFiles(paths, dialogid)
        })

        clickListener('removeCancel', function() {
          document.getElementById('fileWindow').style.display = 'flex'
          document.getElementById('removeWindow').style.display = 'none'
        })
      
        clickListener('fileSave', function() {
          let newName = document.getElementById('fileName').value
          let newPath = document.getElementById('filePath').value
          let newIcon = document.getElementById('fileIcon').value
          if (newName == oldName && newPath == oldPath && newIcon == oldIcon && admin == oldAdmin) closeDialog(dialogid)
          else if (newName == '') createNoti('Library', 'Name Is Necesary')
          else if (newPath == '') createNoti('Library', 'Path Is Necesary')
          else if (fs.existsSync(filePath)) {
            let newFilePath = filePath.substring(0, filePath.lastIndexOf('\\')+1)+newName.trim()+'.json'
            if (newName != oldName && fs.existsSync(newFilePath)) createNoti('Library', 'File Already Exists') 
            else {
              let gameData = JSON.parse(fs.readFileSync(filePath))
              gameData.path = newPath
              gameData.icon = newIcon
              fs.writeFileSync(filePath, JSON.stringify(gameData, null, 2))
              if (newName != oldName) 
                fs.renameSync(filePath, newFilePath)
              closeDialog(dialogid)
              createList('refresh')
            }
          }
        })
        
        //REFRESH ICON
        function refreshIcon() {
          document.getElementById('fileImg').src = 'Data/Images/iconFile.png'
          let icon = document.getElementById('fileIcon').value
          let path = document.getElementById('filePath').value
          if (icon != '') {
            if (icon.startsWith('?:')) icon = data.root.substring(0, 2)+icon.substring(2)
            ipcRenderer.send('getIcon', 'fileImg', icon, library.path)
          } else if (path != '') {
            if (path.startsWith('?:')) path = data.root.substring(0, 2)+path.substring(2)
            ipcRenderer.send('getIcon', 'fileImg', path, library.path)
          }
        }
      }

      function folderDialog() {
        let dialogid = createDialog(fs.readFileSync(currentModule+'folder.html').toString(), 'Folder Properties')

        //PREPARE DIALOG
        const path = require("path")
        let paths = [filePath]
        let oldName = filePath.substring(filePath.lastIndexOf("\\")+1)
        document.getElementById('folderName').value = oldName

        //DIALOG LISTENERS
        clickListener('folderMove', function() {
          ipcRenderer.send('getFolder', library.path, 'Choose a Folder', 'folderMove')
        })

        ipcRenderer.removeAllListeners('folderMove')
        ipcRenderer.on('folderMove', (event, destination) => {
          moveFiles(paths, destination, dialogid)
        })
          
        clickListener('folderRemove', function() {
          document.getElementById('removeTitle').innerHTML = 'Remove "' + oldName + '"?'
          document.getElementById('folderWindow').style.display = 'none'
          document.getElementById('removeWindow').style.display = 'flex'
        })
        
        clickListener('removeRemove', function() {
          removeFiles(paths, dialogid)
        })

        clickListener('removeCancel', function() {
          document.getElementById('folderWindow').style.display = 'flex'
          document.getElementById('removeWindow').style.display = 'none'
        })
        
        clickListener('folderSave', function() {
          let newName = document.getElementById('folderName').value.trim()
          if (oldName == newName) closeDialog(dialogid)
          else if (newName == '') createNoti('Library', 'Name Is Necesary')
          else if (fs.existsSync(filePath)) {
            let newFilePath = filePath.substring(0, filePath.lastIndexOf('\\')+1)+newName
            if (fs.existsSync(newFilePath)) createNoti('Library', 'Folder Already Exists')
            else {
              fs.renameSync(filePath, newFilePath)
              closeDialog(dialogid)
              createList('refresh')
            }
          }
        })
      }

      //MOVE FILES
      function moveFiles(paths, destination, dialogid) {
        destination = destination+'\\'
        if (!destination.startsWith(libraryFolder)) return

        //CHECK IF NEW FOLDER IS ALSO BEING MOVED
        let posibleToMove = true
        for (i in paths) {
          if (destination.startsWith(paths[i]+'\\'))
            posibleToMove = false
        }

        //IF POSIBLE MOVE „Éæ(‚Ä¢œâ‚Ä¢`)o
        if (posibleToMove) for (i in paths) {
          let mpath = paths[i]
          if (fs.existsSync(mpath)) {
            let oldPath = mpath
            if (mpath.endsWith('\\')) oldPath = mpath.slice(0,-1)
            let name = oldPath.substring(oldPath.lastIndexOf('\\')+1)
            fs.renameSync(mpath, destination+name)
          }
          if (i == paths.length-1) {
            closeDialog(dialogid)
            createList('refresh')
          }
        } else createNoti('Library', 'Destination Folder is Also Being Moved')
      }
    
      //REMOVE FILES
      function removeFiles(paths, dialogid) {
        for (i in paths) {
          let path = paths[i]
          if (fs.existsSync(path)) {
            if (fs.statSync(path).isFile())
              fs.unlinkSync(path)
            else
              fs.rmSync(path, { recursive: true })
          }
          if (i == paths.length-1) {
            closeDialog(dialogid)
            createList('refresh')
          }
        }
      }
    })
  }

  function createDataHTML(id, img, tmpicon, filePath, isFile, asAdmin, name, path, icon, pathClean, pathArgs) {
    if (!library.smallItems)
      return `<div id="${id}" class="button vc" style="width: calc(var(--libraryItemSize) - 6px); margin: 3px; flex-direction: column; position: relative;">
                <div id="filePath-${id}" style="display: none;">${filePath}</div>
                <div id="isFile-${id}" style="display: none;">${isFile}</div>
                <div id="asAdmin-${id}" style="display: none;">${asAdmin}</div>
                <div id="path-${id}" style="display: none;">${path}</div>
                <div id="icon-${id}" style="display: none;">${icon}</div>
                <div id="pathClean-${id}" style="display: none;">${pathClean}</div>
                <div id="pathArgs-${id}" style="display: none;">${pathArgs}</div>
                <div class="vc" style="width: 100%; aspect-ratio: 1/1; align-items: center;">
                  <img id="${img}" style="width: 90%; margin: auto; aspect-ratio: 1/1; border-radius: var(--buttonCorner); filter: drop-shadow(var(--shadow)); object-fit: contain;" src="${tmpicon}"></img>
                </div>
                <div class="vc" style="width: 100%; height: 50px; align-items: center;">
                  <div id="name-${id}" style="width: 90%; margin: auto; text-align: center; font-size: 15px; line-height: 18px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; color: var(--textColor);">${name}</div>
                </div>
                <div id="selected-${id}" class="hc" style="width: 100%; height: 100%; position: absolute; visibility: hidden;">
                  <svg class="button-svg" style="margin-left: auto; filter: drop-shadow(var(--shadow));" viewBox="0 0 24 24">
                    <path d="M16.19 2H7.81C4.17 2 2 4.17 2 7.81V16.18C2 19.83 4.17 22 7.81 22H16.18C19.82 22 21.99 19.83 21.99 16.19V7.81C22 4.17 19.83 2 16.19 2ZM16.78 9.7L11.11 15.37C10.97 15.51 10.78 15.59 10.58 15.59C10.38 15.59 10.19 15.51 10.05 15.37L7.22 12.54C6.93 12.25 6.93 11.77 7.22 11.48C7.51 11.19 7.99 11.19 8.28 11.48L10.58 13.78L15.72 8.64C16.01 8.35 16.49 8.35 16.78 8.64C17.07 8.93 17.07 9.4 16.78 9.7Z"/>
                  </svg>
                </div>
              </div>`
    else 
      return `<div id="${id}" class="button vc" style="width: calc(var(--libraryItemSize) - 6px); aspect-ratio: 1/1; margin: 3px; flex-direction: column; position: relative;">
                <div id="filePath-${id}" style="display: none;">${filePath}</div>
                <div id="isFile-${id}" style="display: none;">${isFile}</div>
                <div id="asAdmin-${id}" style="display: none;">${asAdmin}</div>
                <div id="path-${id}" style="display: none;">${path}</div>
                <div id="icon-${id}" style="display: none;">${icon}</div>
                <div id="pathClean-${id}" style="display: none;">${pathClean}</div>
                <div id="pathArgs-${id}" style="display: none;">${pathArgs}</div>
                <div class="vc" style="height: 65%;">
                  <img id="${img}" style="height: 90%; aspect-ratio: 1/1; margin: 5% auto 0 auto; border-radius: var(--buttonCorner); filter: drop-shadow(var(--shadow)); object-fit: contain;" src="${tmpicon}"></img>
                </div>
                <div class="vc" style="height: 35%; align-items: center;">
                  <div id="name-${id}" style="width: 90%; margin: auto; text-align: center; font-size: 15px; line-height: 18px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; color: var(--textColor);">${name}</div>
                </div>
                <div id="selected-${id}" class="hc" style="width: 100%; height: 100%; position: absolute; visibility: hidden;">
                  <svg class="button-svg" style="margin-left: auto; filter: drop-shadow(var(--shadow));" viewBox="0 0 24 24">
                    <path d="M16.19 2H7.81C4.17 2 2 4.17 2 7.81V16.18C2 19.83 4.17 22 7.81 22H16.18C19.82 22 21.99 19.83 21.99 16.19V7.81C22 4.17 19.83 2 16.19 2ZM16.78 9.7L11.11 15.37C10.97 15.51 10.78 15.59 10.58 15.59C10.38 15.59 10.19 15.51 10.05 15.37L7.22 12.54C6.93 12.25 6.93 11.77 7.22 11.48C7.51 11.19 7.99 11.19 8.28 11.48L10.58 13.78L15.72 8.64C16.01 8.35 16.49 8.35 16.78 8.64C17.07 8.93 17.07 9.4 16.78 9.7Z"/>
                  </svg>
                </div>
              </div>`
    
  }

  //GET FILE INFO
  function getFileInfo(filePath) {
    if (!fs.existsSync(filePath)) return
    //IS FOLDER OR FILE
    let isFile = false
    if (fs.statSync(filePath).isFile()) isFile = true
    //NAME
    let name = filePath.substring(filePath.lastIndexOf("\\")+1)
    if (name.includes('.') && isFile) name = name.substring(0, name.lastIndexOf('.'))
    //RETURN FILE OR FOLDER INFO
    if (!isFile)
      //IS FOLDER
      return {isFile, name}
    else try {
      //IS FILE
      const data = JSON.parse(fs.readFileSync(filePath))
      const path = data.path
      const icon = data.icon
      const admin = data.admin
      const pathInfo = getPathInfo(path)
      const pathClean = pathInfo.pathClean
      const pathArgs = pathInfo.pathArgs
      return {isFile, name, path, admin, pathClean, pathArgs, icon}
    } catch (e) {
      //ISN'T A JSON
      return undefined
    }
  }

  function getPathInfo(path) {
    let pathClean = path
    let pathArgs = ''
    try {
      if (path.includes('--') && path.includes(' ') && !path.endsWith('"')) {
        if (path.startsWith('"'))
          pathClean = path.substring(1, path.lastIndexOf('"'))
        else 
          pathClean = path.substring(0, path.lastIndexOf(' '))
        let args = path.substring(pathClean.length+2).trim()
        pathArgs = args.split(' ')
        pathArgs.unshift("/c", pathClean)
      }
      if (pathClean.startsWith('"') && pathClean.endsWith('"')) pathClean = pathClean.substring(1, pathClean.length-1)
      if (pathClean.startsWith('?:')) pathClean = data.root.substring(0, 2)+pathClean.substring(2)
    } catch (e) {}
    return {pathClean, pathArgs}
  }
  
  //OPEN
  function openFile(id, asAdmin, name, pathClean, argsClean) {
    if (asAdmin) {
      const wincmd = require('node-windows')
      if (argsClean != '') {
        argsClean[1] = `"${argsClean[1]}"`
        wincmd.elevate(`cmd.exe ${argsClean}`)
      } else {
        wincmd.elevate(`"${pathClean}"`)
      }
    } else {
      if (argsClean != '') {
        let spawn = require("child_process").spawn
        spawn("cmd.exe", argsClean)
      } else {
        shell.openPath(pathClean)
      }
    }
    createNoti('Library', name)
  }

  function openFolder(path) {
    if (document.getElementById('window').scrollTop == 0)
      createList(path)
    else 
      $("#window").animate({ scrollTop: 0 }, "fast", function() {
        createList(path)
      })
  }
</script>