<style>
  .libraryButton {
    background: transparent;
    box-shadow: none;
  }
  
  .libraryButton:hover {
    background: var(--buttonHover);
  }
</style>

<div id="content" class="win-c">
  <div class="win-t">
    <div id="title" class="title">Home</div>
    <div id="items" class="button" style="width: 40px; min-width: 40px; height: 40px; min-height: 40px; margin-left: 10px;">
      <svg class="svg" viewBox="0 0 24 24">
        <path class="st0" d="M11,16.1v2.7c0,2.2-0.9,3.1-3.2,3.1H5.2C2.9,22,2,21.1,2,18.9v-2.7C2,13.9,2.9,13,5.2,13h2.7C10.1,13,11,13.9,11,16.1z"/>
        <path class="st0" d="M16.5,2h-8C5.5,2,3,4.5,3,7.5v3c0,0.6,0.5,1,1,1h4.5c2.2,0,4,1.8,4,4V20c0,0.5,0.4,1,1,1h3c3.5,0,5.5-2.1,5.5-5.5v-8C22,4.5,19.5,2,16.5,2z"/>
      </svg>
    </div>
    <div id="add" class="button" style="width: 40px; min-width: 40px; height: 40px; min-height: 40px; margin-left: 10px;">
      <svg class="svg" viewBox="0 0 24 24">
        <path d="M12 2C6.49 2 2 6.49 2 12C2 17.51 6.49 22 12 22C17.51 22 22 17.51 22 12C22 6.49 17.51 2 12 2ZM16 12.75H12.75V16C12.75 16.41 12.41 16.75 12 16.75C11.59 16.75 11.25 16.41 11.25 16V12.75H8C7.59 12.75 7.25 12.41 7.25 12C7.25 11.59 7.59 11.25 8 11.25H11.25V8C11.25 7.59 11.59 7.25 12 7.25C12.41 7.25 12.75 7.59 12.75 8V11.25H16C16.41 11.25 16.75 11.59 16.75 12C16.75 12.41 16.41 12.75 16 12.75Z"/>
      </svg>
    </div>
    <div style="flex-grow: 1;"></div>
    <div class="button" style="min-width: 210px; margin-left: 10px;">
      <input id='editText' class="input" type="text" spellcheck="false" placeholder="Search" maxlength="30" style="width: 160px; padding-right: 0;"></input>
      <svg id="search" class="svg" viewBox="0 0 24 24">
        <path class="st0" d="M2.2,21.8c-0.3-0.3-0.3-0.7,0-1l1.9-1.9c0.3-0.3,0.7-0.3,1,0s0.3,0.7,0,1l-1.9,1.9C3.1,21.9,2.9,22,2.7,22S2.3,21.9,2.2,21.8z"/>
        <path class="st0" d="M21.7,9.1c-0.8-3.3-3.5-6-6.8-6.8C7.9,0.5,1.5,6.9,3.3,13.9c0.8,3.3,3.5,6,6.8,6.8C17.1,22.5,23.5,16.1,21.7,9.1z M18.6,10c-0.1-0.3,0.1-0.7,0.5-0.7c0.3-0.1,0.6,0.1,0.7,0.4c0.1,0.6,0.2,1.2,0.2,1.8c0,0.3,0,0.7-0.1,1c-0.1,0.4-0.5,0.5-0.8,0.5c-0.2-0.1-0.5-0.3-0.5-0.6l0,0c0-0.3,0.1-0.5,0.1-0.8C18.8,10.9,18.7,10.4,18.6,10z M12.5,19C8.4,19,5,15.6,5,11.5S8.4,4,12.5,4c2.4,0,4.6,1.2,6,3c0.2,0.3,0.2,0.7-0.1,0.9C18.1,8,17.7,8,17.5,7.7l0,0c-1.1-1.5-2.9-2.5-5-2.5C9,5.3,6.3,8,6.3,11.5s2.8,6.3,6.3,6.3c0.6,0,1.2-0.1,1.8-0.3l0,0c0.4-0.1,0.8,0,0.9,0.4c0.1,0.3-0.1,0.7-0.5,0.8C14,18.9,13.2,19,12.5,19z"/>
      </svg>
    </div>
  </div>

  <div class="vc" id="launcherEmpty" style="width: 100%; align-items: center; line-height: normal; display: none;">
    <div style="font-size: 100px; margin-top: 20px;">ðŸ˜ž</div>
    <div style="font-size: 15px; color: var(--textPrimary);">Such Empty...</div>
    <div style="font-size: 15px; color: var(--textSecondary);">Try Importing From the [+] Button</div>
  </div>
  <div class="hc" id="launcherList" style="flex-wrap: wrap;">
  
  </div>
</div>

<script>
  //MODULE NAME USED IN - TRAY & MAIN.HTML & SETTINGS ðŸ˜¡
  search = ''
  click = ''
  adding = false

  libraryFolder = currentModule+'Library\\'
  selecting = false
  selected = []
  timeId = ''
  time = 0
  
  document.getElementById('windowBackground').style.overflowY = 'scroll'
  refreshData()
  actualPath = json.actualPath
  itemSmall = json.itemSmall

  ipcRenderer.on('specialData', (event, specialData) => {
    //LOAD SPECIAL DATA PATH / RELOAD
    if (specialData == undefined)
      specialData = actualPath
    document.getElementById('content').style.minHeight = document.getElementById('content').offsetHeight+'px'
    createList(specialData)
  })

  ipcRenderer.on('requestedIcon', (event, img, icon, tag) => {
    if (actualPath == tag && icon != '') 
      document.getElementById(img).src = icon
  })

  function startLauncher(s) {
    document.body.style.setProperty('--libraryItemSize', '0')
    const libraryResizeOb = new ResizeObserver(function(entries) {
    	let contentW = document.getElementById('launcherList').offsetWidth
      let i = 4
      while (contentW/i > 155) { i++ }
      document.body.style.setProperty('--libraryItemSize', 100/i+'%')
    })
    libraryResizeOb.observe(document.querySelector("#launcherList"))

    updateButtons(true)
    adding = true

    selecting = false
    selected = []
    search = s

    ipcRenderer.send('resume')

    //ADD
    clickListener('add', function() {
      ipcRenderer.send('pause')
      ipcRenderer.send('newOrionWindow', currentModule+'add.html', false, 390, 150, true)
    })

    //ITEMS
    clickListener('items', function() {
      if (itemSmall)
        itemSmall = false
      else 
        itemSmall = true
      setData('itemSmall', itemSmall)
      createList(actualPath, search)
    })

    //SEARCH
    $('#editText').on('keydown', function(event) {
      if (event.keyCode === 13) {
        event.preventDefault()
        if (document.getElementById('editText').value != search) {
          $("#windowBackground").animate({ scrollTop: 0 }, "fast")
          createList(actualPath, document.getElementById('editText').value)
        }
        return false;
      }
    })

    clickListener('search', function() {
      if (document.getElementById('editText').value != search) {
        $("#windowBackground").animate({ scrollTop: 0 }, "fast")
        createList(actualPath, document.getElementById('editText').value)
      }
    })

    //CLEAR LIST
    document.getElementById('launcherEmpty').style.display = 'none'
    document.getElementById('launcherList').innerHTML = ''
  }

  function createList(argPath, search) {
    if (search == undefined) search = ''
    if (!fs.existsSync(argPath)) argPath = libraryFolder
    if (!argPath.startsWith(libraryFolder)) argPath = libraryFolder
    if (!argPath.endsWith('\\')) argPath = argPath+'\\'
    if (!fs.existsSync(argPath)) return
    startLauncher(search)
    //SET TITLE & SAVE PATH
    actualPath = argPath
    let title = 'Home'
    if (actualPath != libraryFolder) title = actualPath.slice(0,-1).substring(actualPath.slice(0,-1).lastIndexOf("\\")+1)
    if (search != '') title = title+' - '+search
    document.getElementById('title').innerText = title
    setData('actualPath', actualPath)
    //BACK BUTTON
    createBackButt(actualPath, search)
    //GET PATHS
    let paths = []
    if (search == '') {
      paths = fs.readdirSync(actualPath)
      addGames()
    } else {
      var recursive = require("recursive-readdir")
      recursive(actualPath, function (err, files) {
        for(i in files) {
          let tmp = files[i].substring(actualPath.length)
          let tmp2 = files[i].substring(files[i].lastIndexOf('\\')+1)
          if (tmp2.endsWith('.txt')) tmp2 = tmp2.slice(0,-4)
          if (tmp2.toLowerCase().includes(search.toLowerCase()))
            paths.push(tmp)
        }
        addGames()
      })
    }

    function addGames() {
      //FIRST FOLDERS THEN FILES
      let folders = []
      let files = []
      for(i in paths) {
        let path = argPath+paths[i]
        if (fs.statSync(path).isFile())
          files.push(paths[i])
        else
          folders.push(paths[i])
      }
      let allPaths = []
      for(i in folders) { allPaths.push(folders[i]) }
      for(i in files) { allPaths.push(files[i]) }
      //START
      let gamesCreated = 0
      for(i in allPaths) {
        //DATA
        let filePath = argPath+allPaths[i]
        let data = getFileInfo(filePath)
        if (data == undefined) continue
        gamesCreated++
        let isFile = data.isFile
        let name = data.name
        let path = data.path
        let pathClean = data.pathClean
        let pathArgs = data.pathArgs
        let icon = data.icon
        //ID
        let id = `folder${i}`
        if (isFile) id = `game${i}`
        let img = `img${i}`
        //CREATE HTML
        let html = ''
        if (!isFile) html = createDataHTML(id, img, "./Data/Images/iconFolder.png", filePath, isFile, name, path, icon, pathClean, pathArgs)
        else html = createDataHTML(id, img, "./Data/Images/iconFile.png", filePath, isFile, name, path, icon, pathClean, pathArgs)
        document.getElementById('launcherList').insertAdjacentHTML('beforeend', html)
        //ADD LISTENER
        addListener(id, img)
        //CHANGE IMAGE
        if (!isFile) continue
        if (icon == '')
          ipcRenderer.send('requestIcon', img, pathClean, actualPath)
        else
          ipcRenderer.send('requestIcon', img, icon, actualPath)
      }
      adding = false
      document.getElementById('content').style.minHeight = ''
      if (actualPath == libraryFolder && search == '' && gamesCreated == 0) document.getElementById('launcherEmpty').style.display = 'Flex'
    }
  }

  function createBackButt(argPath, search) {
    if (search == '' && argPath == libraryFolder) return
    let bpath = argPath
    if (search == '' && argPath != libraryFolder) {
      //bpath
      if (bpath.endsWith("\\")) bpath = bpath.slice(0,-1)
      let numb = bpath.split("\\").length - 1
      if (numb > 1) bpath = bpath.substring(0, bpath.lastIndexOf("\\")+1)
    }
    //HTML
    let html = createDataHTML('backButt', 'backImg', './Data/Images/iconBack.png', bpath, 'false', 'Back', '', '', '', '')
    document.getElementById('launcherList').insertAdjacentHTML('beforeend', html)
    addListener('backButt', 'backImg')
  }

  function addListener(id, img) {
    let path = document.getElementById('filePath-'+id).innerText
    let isFile = true
    if (document.getElementById('isFile-'+id).innerText != 'true') isFile = false

    clickCustomListener(id, function() {
      if (adding) return
      //CLICK ELEMENT & SAVE IT'S ID & THE TIME OF CLICK
      time = Date.now()
      timeId = id
    }, function() {
      //IF ISN'T A CLICK & ISN'T SELECTING REMOVE CLICKED BG
      if ($("#"+id+":hover").length == 0 && !selecting) {
        //document.getElementById(id).removeAttribute('hover')
        document.getElementById('selected-'+id).style.visibility = 'hidden'
      }
    }, function() {
      if (adding) return
      //CHECK IF CLICK WAS LONG ENOUGH TO SELECT
      if (id != 'backButt' && timeId == id && time+300 < Date.now()) selecting = true
      //THEN IF SELECTING
      if (id != 'backButt' && selecting) {
        if (selected.includes(id)) {
          //ALREADY SELECTED
          const index = selected.indexOf(id);
          if (index > -1) {
            selected.splice(index, 1);
            if (selected.length == 0) selecting = false
            document.getElementById('selected-'+id).style.visibility = 'hidden'
          }
        } else {
          //ADD TO SELECTED
          selected.push(id)
          document.getElementById('selected-'+id).style.visibility = 'visible'
        }
      } else {
        //NORMAL CLICK
        document.getElementById('selected-'+id).style.visibility = 'hidden'
        if (isFile) {
          let name = document.getElementById('name-'+id).innerText
          let pathClean = document.getElementById('pathClean-'+id).innerText
          let argsClean = document.getElementById('pathArgs-'+id).innerText
          if (argsClean != '') argsClean = argsClean.split(",")
          openFile(id, name, pathClean, argsClean)
        } else {
          openFolder(path)
        }
      }
    })

    if (id != 'backButt')
    clickRightListener(id, function() {
      if (!selecting || selected.length == 1 && selected.includes(id)) {
        ipcRenderer.send('pause')
        if (isFile) {
          //SELECTED FILE
          let argData = {}
          argData.path = path
          argData.src = document.getElementById(img).src
          argData.libraryFolder = libraryFolder
          ipcRenderer.send('newOrionWindow', currentModule+'context-file.html', false, 390, 380, true, argData)
        } else {
          //SELECTED FOLDER
          let argData = {}
          argData.path = path
          argData.libraryFolder = libraryFolder
          ipcRenderer.send('newOrionWindow', currentModule+'context-folder.html', false, 390, 210, true, argData)
        }
      } else if (selected.includes(id)) {
        //SELECTED MULTI
        ipcRenderer.send('pause')
        let paths = []
        for(i in selected) {
          paths.push(document.getElementById('filePath-'+selected[i]).innerText)
        }
        let argData = {}
        argData.paths = paths
        argData.libraryFolder = libraryFolder
        if (paths.length <3)
          ipcRenderer.send('newOrionWindow', currentModule+'context-multi.html', false, 390, 170, true, argData)
        else
          ipcRenderer.send('newOrionWindow', currentModule+'context-multi.html', false, 390, 190, true, argData)
      }
    })
  }

  function createDataHTML(id, img, tmpicon, filePath, isFile, name, path, icon, pathClean, pathArgs) {
    if (!itemSmall)
      return `<div id="${id}" class="button vc" style="width: calc(var(--libraryItemSize) - 6px); margin: 3px; flex-direction: column; position: relative;">
                <div id="filePath-${id}" style="display: none;">${filePath}</div>
                <div id="isFile-${id}" style="display: none;">${isFile}</div>
                <div id="path-${id}" style="display: none;">${path}</div>
                <div id="icon-${id}" style="display: none;">${icon}</div>
                <div id="pathClean-${id}" style="display: none;">${pathClean}</div>
                <div id="pathArgs-${id}" style="display: none;">${pathArgs}</div>
                <div class="vc" style="width: 100%; aspect-ratio: 1/1; align-items: center;">
                  <img id="${img}" style="width: 90%; margin: auto; aspect-ratio: 1/1; border-radius: var(--buttonCorner); filter: drop-shadow(var(--shadow)); object-fit: contain;" src="${tmpicon}"></img>
                </div>
                <div class="vc" style="width: 100%; height: 50px; align-items: center;">
                  <div id="name-${id}" style="width: 90%; margin: auto; text-align: center; font-size: 15px; line-height: 18px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; color: var(--textColor);">${name}</div>
                </div>
                <div id="selected-${id}" class="hc" style="width: 100%; height: 100%; position: absolute; visibility: hidden;">
                  <svg class="svg" style="margin-left: auto; filter: drop-shadow(var(--shadow));" viewBox="0 0 24 24">
                    <path d="M16.19 2H7.81C4.17 2 2 4.17 2 7.81V16.18C2 19.83 4.17 22 7.81 22H16.18C19.82 22 21.99 19.83 21.99 16.19V7.81C22 4.17 19.83 2 16.19 2ZM16.78 9.7L11.11 15.37C10.97 15.51 10.78 15.59 10.58 15.59C10.38 15.59 10.19 15.51 10.05 15.37L7.22 12.54C6.93 12.25 6.93 11.77 7.22 11.48C7.51 11.19 7.99 11.19 8.28 11.48L10.58 13.78L15.72 8.64C16.01 8.35 16.49 8.35 16.78 8.64C17.07 8.93 17.07 9.4 16.78 9.7Z"/>
                  </svg>
                </div>
              </div>`
    else 
      return `<div id="${id}" class="button vc" style="width: calc(var(--libraryItemSize) - 6px); aspect-ratio: 1/1; margin: 3px; flex-direction: column; position: relative;">
                <div id="filePath-${id}" style="display: none;">${filePath}</div>
                <div id="isFile-${id}" style="display: none;">${isFile}</div>
                <div id="path-${id}" style="display: none;">${path}</div>
                <div id="icon-${id}" style="display: none;">${icon}</div>
                <div id="pathClean-${id}" style="display: none;">${pathClean}</div>
                <div id="pathArgs-${id}" style="display: none;">${pathArgs}</div>
                <div class="vc" style="height: 65%;">
                  <img id="${img}" style="height: 90%; aspect-ratio: 1/1; margin: 5% auto 0 auto; border-radius: var(--buttonCorner); filter: drop-shadow(var(--shadow)); object-fit: contain;" src="${tmpicon}"></img>
                </div>
                <div class="vc" style="height: 35%; align-items: center;">
                  <div id="name-${id}" style="width: 90%; margin: auto; text-align: center; font-size: 15px; line-height: 18px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; color: var(--textColor);">${name}</div>
                </div>
                <div id="selected-${id}" class="hc" style="width: 100%; height: 100%; position: absolute; visibility: hidden;">
                  <svg class="svg" style="margin-left: auto; filter: drop-shadow(var(--shadow));" viewBox="0 0 24 24">
                    <path d="M16.19 2H7.81C4.17 2 2 4.17 2 7.81V16.18C2 19.83 4.17 22 7.81 22H16.18C19.82 22 21.99 19.83 21.99 16.19V7.81C22 4.17 19.83 2 16.19 2ZM16.78 9.7L11.11 15.37C10.97 15.51 10.78 15.59 10.58 15.59C10.38 15.59 10.19 15.51 10.05 15.37L7.22 12.54C6.93 12.25 6.93 11.77 7.22 11.48C7.51 11.19 7.99 11.19 8.28 11.48L10.58 13.78L15.72 8.64C16.01 8.35 16.49 8.35 16.78 8.64C17.07 8.93 17.07 9.4 16.78 9.7Z"/>
                  </svg>
                </div>
              </div>`
    
  }

  //GET FILE INFO
  function getFileInfo(filePath) {
    if (!fs.existsSync(filePath)) return
    //IS FOLDER OR FILE
    let isFile = false
    if (fs.statSync(filePath).isFile()) isFile = true
    //NAME
    let name = filePath.substring(filePath.lastIndexOf("\\")+1)
    if (name.includes('.') && isFile) name = name.substring(0, name.lastIndexOf('.'))
    //RETURN FILE OR FOLDER INFO
    if (!isFile)
      //IS FOLDER
      return {isFile, name}
    else try {
      //IS FILE
      const data = JSON.parse(fs.readFileSync(filePath))
      const path = data.path
      const icon = data.icon
      const pathInfo = getPathInfo(path)
      const pathClean = pathInfo.pathClean
      const pathCleanFix = pathInfo.pathCleanFix
      const pathArgs = pathInfo.pathArgs
      return {isFile, name, path, pathClean, pathCleanFix, pathArgs, icon}
    } catch (e) {
      //ISN'T A JSON
      return undefined
    }
  }

  function getPathInfo(path) {
    let pathClean = path
    let pathCleanFix = ''
    let pathArgs = ''
    try {
      if (path.includes('--') && path.includes(' ') && !path.endsWith('"')) {
        if (path.startsWith('"'))
          pathClean = path.substring(1, path.lastIndexOf('"'))
        else 
          pathClean = path.substring(0, path.lastIndexOf(' '))
        let args = path.substring(pathClean.length+2).trim()
        pathArgs = args.split(' ')
        pathArgs.unshift("/c", pathClean)
      }
      if (pathClean.startsWith('"') && pathClean.endsWith('"')) pathClean = pathClean.substring(1, pathClean.length-1)
      pathCleanFix = pathClean
      if (pathClean.startsWith('?:')) pathCleanFix = data.root.substring(0, 2)+pathClean.substring(2)
    } catch (e) {}
    return {pathClean, pathCleanFix, pathArgs}
  }
  
  //OPEN
  function openFile(id, name, pathClean, argsClean) {
    if (click == id) {
      if (argsClean != '') {
        let spawn = require("child_process").spawn;
        let bat = spawn("cmd.exe", argsClean)
      } else {
        ipcRenderer.send('showOnExplorer', pathClean, false)
      }
      oCreateNoti('Launching', name)
      click = ''
    } else {
      click = id
      setTimeout(function() {
        if (click == id) {
          click = ''
        }
      }, 500)
    }
  }

  function openFolder(path) {
    let scroll = document.getElementById('windowBackground').scrollTop
    if (scroll == 0) {
      createList(path)
    } else {
      $("#windowBackground").animate({ scrollTop: 0 }, "fast")
	    setTimeout(function() {
        createList(path)
      }, 150)
    }
  }
</script>