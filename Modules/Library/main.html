<div id="content" class="win-c">
  <div class="win-t">
    <div id="title" class="title">Home</div>
    <o-button id="libraryAdd" size="big" lefticon="Modules/Library/Icons/add.svg"></o-button>
    
    <div style="flex-grow: 1; margin-right: -20px;"></div>
    
    <o-button id="librarySearch" size="big" righticon="Modules/Library/Icons/search.svg" text style="max-width: 220px">
      <o-input id="librarySearchInput" style="width: 140px; margin-left: 5px;" hint="Search" label transparent width="0" style="flex: 1;"></o-input>
    </o-button>
  </div>

  <div id="libraryEmpty" class="vc" style="width: 100%; align-items: center; display: none;">
    <div style="font-size: 100px; margin-top: 20px;">😞</div>
    <div style="font-size: 15px; color: var(--text);">Such empty...</div>
    <div style="font-size: 15px; color: var(--textSecondary);">Try importing from the (+) button</div>
  </div>

  <div id="libraryList" style="display: grid; gap: 15px; grid-template-columns: repeat(auto-fill, 150px); justify-content: center;"></div>

  <div id="moveWindow" style="padding: 20px; position: fixed; right: 30px; bottom: 20px; display: flex; flex-direction: column; align-items: center; gap: 20px; background: var(--background); border-radius: 20px; box-shadow: var(--shadowB); opacity: 0; pointer-events: none; transition: opacity .2s;">
    <span id="moveTitle">Move 3 items here?</span>
    <div class="hc" style="gap: 10px;">
      <o-button id="moveMove" text="Move" style="width: 130px;"></o-button>
      <o-button id="moveCancel" text="Cancel" style="width: 130px;"></o-button>
    </div>
  </div>
</div>





<script>
   /*$    /$$                             
  | $$   | $$                             
  | $$   | $$ /$$$$$$   /$$$$$$   /$$$$$$$
  |  $$ / $$/|____  $$ /$$__  $$ /$$_____/
   \  $$ $$/  /$$$$$$$| $$  \__/|  $$$$$$ 
    \  $$$/  /$$__  $$| $$       \____  $$
     \  $/  |  $$$$$$$| $$       /$$$$$$$/
      \_/    \_______/|__/      |______*/ 

  var libraryFile = cModule.path + 'library.xml'
  var libraryPath = settings.get('path', [])
  var libraryXML = {}
  var librarySearch = ''
  var librarySelecting = false
  var librarySelected  = []
  

  


   /*$$$$$$$                              /$$     /$$                              
  | $$_____/                             | $$    |__/                              
  | $$    /$$   /$$ /$$$$$$$   /$$$$$$$ /$$$$$$   /$$  /$$$$$$  /$$$$$$$   /$$$$$$$
  | $$$$$| $$  | $$| $$__  $$ /$$_____/|_  $$_/  | $$ /$$__  $$| $$__  $$ /$$_____/
  | $$__/| $$  | $$| $$  \ $$| $$        | $$    | $$| $$  \ $$| $$  \ $$|  $$$$$$ 
  | $$   | $$  | $$| $$  | $$| $$        | $$ /$$| $$| $$  | $$| $$  | $$ \____  $$
  | $$   |  $$$$$$/| $$  | $$|  $$$$$$$  |  $$$$/| $$|  $$$$$$/| $$  | $$ /$$$$$$$/
  |__/    \______/ |__/  |__/ \_______/   \___/  |__/ \______/ |__/  |__/|______*/ 
  
  function createList(argPath, search) {
    //Default values
    if (argPath == 'refresh') argPath = libraryPath
    if (typeof argPath === 'string') argPath = argPath.split('/')
    if (typeof search !== 'string') search = ''
    search = search.toLowerCase()

    //Get folder & path
    if (!Array.isArray(argPath)) argPath = libraryPath
    let folder = libraryXML
    let path = []

    //Get folder path as array of names
    for (i in argPath) {
      let goodKey = false
      let folderTmp = folder
      let folderName = argPath[i]
      let folderElems = folderTmp.childNodes

      //Check if key is a folder
      for (i2 in folderElems) {
        let elem = folderElems[i2]
        if (elem.tagName == 'folder' && elem.getAttribute('name') == folderName) {
          goodKey = true
          folderTmp = elem
          break
        }
      }

      //Stay where we are if key is not a folder
      if (!goodKey) break

      //Update path
      folder = folderTmp
      path.push(folderName)
    }

    //Save path
    libraryPath = Array.from(path)
    settings.set('path', libraryPath)
    console.log(libraryPath)

    //Set title
    let title = 'Home'
    if (path.length > 0) title = path[path.length-1]
    if (search != '') title = title+' - '+search
    document.getElementById('title').innerText = title

    //Prepare library
    librarySelecting = false
    librarySelected = []
    librarySearch = search
    document.getElementById('libraryEmpty').style.display = 'none'
    document.getElementById('libraryList').innerHTML = ''

    //Create back button
    if (path.length != 0 || search != '') {
      //Get back folder path
      let backPath = Array.from(path)
      if (backPath.length != 0 && search == '') backPath.pop()
      
      //HTML
      const data = {
        id: 'backButton',
        name: 'Back',
        img: './Data/Images/back.png',
        type: 'folder',
        path: backPath
      }
      document.getElementById('libraryList').insertAdjacentHTML('beforeend', createDataHTML(data))
      addListener(data)
    }

    //Sort alphabetically and by type
    let items = sortItems(folder, search)
    addGames(items.folders, items.games, search)
  }

  function sortItems(folder, search) {
    //Default values
    if (typeof folder !== 'object') return { folders: [], games: [] }
    if (typeof search !== 'string') search = ''

    //Folders & games lists
    let folders = []
    let games = []
    let items
    if (search != '')
      items = folder.getElementsByTagName("*")
    else 
      items = folder.childNodes

    //Separate & filter folders & games
    for (i in items) {
      switch (items[i].tagName) {
        case 'folder':
          //Add folder
          if (search == '') folders.push(items[i])
          break
        case 'game':
          //Add game
          if (search == '') games.push(items[i])
          //Add game & location
          else if (items[i].getAttribute('name').toLowerCase().includes(search)) {
            let loc = ''
            let goodLock = false
            let game = items[i]
            if (game.parentNode.tagName == 'library') goodLock = true
            while (game.parentNode.tagName != 'library') {
              game = game.parentNode
              let name = game.getAttribute('name')
              if (name != '') {
                if (loc != '')
                  loc = `${name}/${loc}`
                else
                  loc = name
                goodLock = true
              }
              else {
                loc = ''
                goodLock = true
              }
            }
            if (goodLock) {
              items[i].setAttribute('location', loc)
              games.push(items[i])
            }
          }
          break
      }
    }

    //Sort
    folders.sort(function(a, b){
      if(a.getAttribute('name') < b.getAttribute('name')) { return -1 }
      if(a.getAttribute('name') > b.getAttribute('name')) { return 1 }
      return 0
    })
    games.sort(function(a, b){
      if(a.getAttribute('name') < b.getAttribute('name')) { return -1 }
      if(a.getAttribute('name') > b.getAttribute('name')) { return 1 }
      return 0
    })

    //Return lists
    return { folders, games }
  }

  async function addGames(folders, games, search) {
    //Stats
    let itemsCreated = 0
    let itemNames = []

    //Folders
    for (i in folders) {
      let folder = folders[i]

      //Check for attributes (name)
      let atts = folder.getAttributeNames()
      if (!atts.includes('name')) continue

      //Get attributes
      let data = {}
      for (j in atts) { data[atts[j]] = folder.getAttribute(atts[j]) }

      //Check values & don't repeat name
      if (itemNames.indexOf(data.name) != -1) continue
      if (data.name == '') continue
      itemNames.push(data.name)
      if (typeof data.icon !== 'string') data.icon = ''

      //Add attributes
      data.id = `folder${i}-${Date.now()}`
      data.img = './Data/Images/folder.png'
      data.type = 'folder'
      data.path = Array.from(libraryPath)
      data.path.push(data.name)
      data.location = libraryPath.join('/')

      //Add HTML
      document.getElementById('libraryList').insertAdjacentHTML('beforeend', createDataHTML(data))

      //Add listener
      addListener(data)

      //Change image
      if (data.icon != '') getIcon(requestedIcon, data.icon, 'img-' + data.id)

      //Folder created
      itemsCreated++
    }

    //Games
    for (i in games) {
      let game = games[i]

      //Check for attributes (name & path)
      let atts = game.getAttributeNames()
      if (!atts.includes('name')) continue
      if (!atts.includes('path')) continue

      //Get attributes
      let data = {}
      for (j in atts) { data[atts[j]] = game.getAttribute(atts[j]) }

      //Check values & don't repeat name
      if (itemNames.indexOf(data.name) != -1) continue
      if (data.name == '') continue
      itemNames.push(data.name)
      if (data.path == '') continue
      if (typeof data.icon !== 'string') data.icon = ''

      //Add attributes
      data.id = `game${i}-${Date.now()}`
      data.img = './Data/Images/file.png'
      data.type = 'game'
      if (!data.location) data.location = libraryPath.join('/')
      const pathInfo = getPathInfo(data.path)
      data.pathClean = pathInfo.pathClean
      data.pathArgs = pathInfo.pathArgs

      //Add HTML
      document.getElementById('libraryList').insertAdjacentHTML('beforeend', createDataHTML(data))

      //Add listener
      addListener(data)

      //Change image
      if (data.icon != '') 
        getIcon(requestedIcon, data.icon, 'img-' + data.id)
      else if (data.pathClean != '')
        getIcon(requestedIcon, data.pathClean, 'img-' + data.id)

      //Game created
      itemsCreated++
    }

    //No items -> Show empty message
    if (libraryPath.join('') == '' && search == '' && itemsCreated == 0) document.getElementById('libraryEmpty').style.display = 'flex'
  }

  function createDataHTML(data) {
    //Create library item
    return `<o-box id="${data.id}" style="width: 150px; height: 200px; --oCorner: 35px; flex-direction: column;">
              <img id="img-${data.id}" style="width: 120px; height: 120px; margin: 15px; border-radius: 20px; object-fit: contain;" src="${data.img}" onerror="if(!this.src.endsWith('${data.img}')) this.src='${data.img}'">
              <div style="width: 120px; height: 40px; margin: 15px; margin-top: 0; display: flex; align-items: center; justify-content: center;">
                <span id="name-${data.id}" style="font-size: 15px; line-height: 20px; text-align: center; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">${data.name}</span>
              </div>
              <svg id="selected-${data.id}" style="height: 24px; width: 24px; visibility: hidden; position: absolute; top: 15px; right: 15px; filter: drop-shadow(var(--shadow));" viewBox="0 0 24 24">
                <path d="M16.19 2H7.81C4.17 2 2 4.17 2 7.81V16.18C2 19.83 4.17 22 7.81 22H16.18C19.82 22 21.99 19.83 21.99 16.19V7.81C22 4.17 19.83 2 16.19 2ZM16.78 9.7L11.11 15.37C10.97 15.51 10.78 15.59 10.58 15.59C10.38 15.59 10.19 15.51 10.05 15.37L7.22 12.54C6.93 12.25 6.93 11.77 7.22 11.48C7.51 11.19 7.99 11.19 8.28 11.48L10.58 13.78L15.72 8.64C16.01 8.35 16.49 8.35 16.78 8.64C17.07 8.93 17.07 9.4 16.78 9.7Z"/>
              </svg>
              <div style="display: none;">
                <div id="type-${data.id}">${data.type}</div>
                <div id="icon-${data.id}">${data.icon}</div>
                <div id="location-${data.id}">${data.location}</div>
              </div>
            </o-box>`
  }

  function addListener(data) {
    //Item data
    let id = data.id
    let img = 'img-'+id
    let name = data.name
    let path = data.path
    let location = data.location
    let filePath = name
    if (location != '') filePath = location+'/'+name
    let isFolder = (data.type == 'folder')

    //Listeners
    if (id != 'backButton') 
    longpressListener(id, () => {
      if (!librarySelecting) librarySelecting = true
    }, 300)

    clickListener(id, () => {
      if (librarySelecting && id != 'backButton') {
        if (librarySelected.includes(id)) {
          //Already selected
          librarySelected.splice(librarySelected.indexOf(id), 1)
          document.getElementById('selected-'+id).style.visibility = 'hidden'
          if (librarySelected.length == 0) librarySelecting = false
        } else {
          //Add to selected
          librarySelected.push(id)
          document.getElementById('selected-'+id).style.visibility = 'visible'
        }
      } else if (isFolder) {
        //Folder
        openFolder(path)
        if (id == 'backButton') document.getElementById('librarySearchInput').value = ''
      }
    })

    if (!isFolder)
    doubleClickListener(id, () => {
      if (!librarySelecting) {
        //Open as admin
        let admin = (data.admin == 'true')

        //Path & Args
        let pathClean = data.pathClean
        let pathArgs = data.pathArgs
        openFile(id, admin, name, pathClean, pathArgs)
      }
    })

    if (id != 'backButton')
    contextListener(id, () => {
      if (librarySelected.length > 1 && librarySelected.includes(id)) {
        //Selected multiple
        multiDialog()
      } else if (!librarySelecting || librarySelected.length == 1 && librarySelected.includes(id)) {
        if (isFolder) {
          //Selected folder
          folderDialog()
        } else {
          //Selected file
          gameDialog()
        }
      }

      //Dialog creation functions
      function multiDialog() {
        //Craeate dialog
        const dialogid = createDialog(fs.readFileSync(cModule.path + 'Menus/multiple.html').toString())

        //Prepare dialog
        let paths = []
        for(i in librarySelected) {
          //Item data
          let id = librarySelected[i]
          let type = 'folder'
          if (id.startsWith('game')) type = 'game'
          let name = document.getElementById('name-'+id).innerText
          let location = document.getElementById('location-'+id).innerText
          let filePath = name
          if (location != '') filePath = location+'/'+name

          //Add filepath
          paths.push(`${type}://${filePath}`)

          //Change name
          if (type == 'game')
            name = `🎮 ${name}`
          else 
            name = `📁 ${name}`
          document.getElementById('multiList').insertAdjacentHTML('beforeend', `<o-button text="${name}" style="width: 100%;"></o-button>`)
        }

        //Rename dialog
        renameDialog(dialogid, paths.length+' Items Selected')

        //Dialog listeners
        clickListener('multiMove', () => {
          moveFiles(paths, dialogid)
        })

        clickListener('multiRemove', () => {
          document.getElementById('removeTitle').innerHTML = `Remove ${paths.length} items?`
          document.getElementById('multiWindow').style.display = 'none'
          document.getElementById('removeWindow').style.display = 'flex'
        })

        clickListener('removeRemove', () => {
          removeFiles(paths, dialogid)
        })

        clickListener('removeCancel', () => {
          document.getElementById('multiWindow').style.display = 'flex'
          document.getElementById('removeWindow').style.display = 'none'
        })
      }
    
      function folderDialog() {
        //Craeate dialog
        const dialogid = createDialog(fs.readFileSync(cModule.path + 'Menus/folder.html').toString(), 'Folder properties')

        //Prepare dialog
        let paths = [`folder://${filePath}`]
        let oldName = data.name
        let oldIcon = data.icon

        const folderNameInput = document.getElementById('folderNameInput')
        const folderIconInput = document.getElementById('folderIconInput')

        folderNameInput.value = oldName
        folderIconInput.value = oldIcon
        document.getElementById('folderImg').src = document.getElementById(img).src
        refreshIcon()

        //Dialog listeners
        clickListener('righticon-folderIcon', (event) => {
          event.stopPropagation()

          //Get path info
          const pathInfo = getPathInfo(folderIconInput.value)
          const path = pathInfo.pathClean.substring(0, pathInfo.pathClean.lastIndexOf('\\')+1)

          //Request file
          getFile((event, filePath) => {
            if (filePath == '') return
            getIconBase64(async (event, icon, id) => {
              folderIconInput.value = icon == '' ? id : await resizeBase64Image(icon)
              refreshIcon()
            }, filePath, filePath)
          }, 'Choose an Icon', path)
        })
        
        clickListener('folderMove', () => {
          moveFiles(paths, dialogid)
        })
          
        clickListener('folderRemove', () => {
          document.getElementById('removeTitle').innerHTML = `Remove '${oldName}'?`
          document.getElementById('folderWindow').style.display = 'none'
          document.getElementById('removeWindow').style.display = 'flex'
        })
        
        clickListener('removeRemove', () => {
          removeFiles(paths, dialogid)
        })

        clickListener('removeCancel', () => {
          document.getElementById('folderWindow').style.display = 'flex'
          document.getElementById('removeWindow').style.display = 'none'
        })
        
        clickListener('folderSave', () => {
          //Get values
          const newName = folderNameInput.value.trim()
          const newIcon = folderIconInput.value.trim()

          //Save values
          if (newName == oldName && newIcon == oldIcon) closeDialog(dialogid)

          //Missing values
          else if (newName == '') createNoti('Library', 'Name is necesary')
          else if (newName.includes('/')) createNoti('Library', "Forbidden character '/'")

          //Update values
          else {
            //Get folder
            let item = getItem(filePath)
            if (item == undefined) {
              createNoti('Library', 'Error finding folder')
              return
            }

            //Check if new name exists
            if (newName != oldName) {
              //Get folder
              let folder = getItem(location)
              if (folder == undefined) {
                createNoti('Library', 'Error finding parent folder')
                return
              }

              //Check if folder exists
              if (existsFolderIn(newName, folder)) {
                createNoti('Library', `'${newName}' already exists`)
                return
              }
            }

            //Update game
            item.setAttribute('name', newName)
            item.setAttribute('icon', newIcon) 

            //Save file, close dialog & refresh list
            saveXML()
            closeDialog(dialogid)
            createList('refresh')
          }
        })
      
        //Refresh icon
        clickListener('folderImg', refreshIcon)

        function refreshIcon() {
          getIcon((event, icon, id) => {
            if (id == filePath) document.getElementById('folderImg').src = icon
          }, folderIconInput.value.trim(), filePath)
        }
      }

      function gameDialog() {
        //Create dialog
        const dialogid = createDialog(fs.readFileSync(cModule.path + 'Menus/game.html').toString(), 'Game properties')

        //Prepare dialog
        let paths = [`game://${filePath}`]
        let oldName = data.name
        let oldPath = data.path
        let oldPathClean = data.pathClean
        let oldIcon = data.icon
        let oldAdmin = (data.admin == 'true')
        let newAdmin = Boolean(oldAdmin)

        const gameNameInput = document.getElementById('gameNameInput')
        const gamePathInput = document.getElementById('gamePathInput')
        const gameIconInput = document.getElementById('gameIconInput')

        gameNameInput.value = oldName
        gamePathInput.value = oldPath
        if (!fs.existsSync(oldPathClean)) document.getElementById('gameShow').style.display = 'none'
        gameIconInput.value = oldIcon
        document.getElementById('gameImg').src = document.getElementById(img).src
        refreshIcon()
        document.getElementById('gameAdmin').checked = oldAdmin
          

        //Add listeners
        clickListener('righticon-gamePath', (event) => {
          event.stopPropagation()

          //Get path info
          const pathInfo = getPathInfo(gamePathInput.value)
          const path = pathInfo.pathClean.substring(0, pathInfo.pathClean.lastIndexOf('\\') + 1)

          //Request file
          getFile((event, filePath) => {
            if (filePath == '') return
            gamePathInput.value = filePath

            //Update name if empty
            if (gameNameInput.value == '') {
              let name = filePath.substring(filePath.lastIndexOf('\\') + 1)
              if (name.includes('.')) name = name.substring(0, name.lastIndexOf('.'))
              gameNameInput.value = name
            }

            //Refresh icon
            refreshIcon()
          }, 'Choose a Game', path)
        })
        
        clickListener('righticon-gameIcon', (event) => {
          event.stopPropagation()

          //Get path info
          let value = gameIconInput.value
          if (value == '') value = gamePathInput.value
          const pathInfo = getPathInfo(value)
          const path = pathInfo.pathClean.substring(0, pathInfo.pathClean.lastIndexOf('\\') + 1)

          //Request file
          getFile((event, filePath) => {
            if (filePath == '') return
            getIconBase64(async (event, icon, id) => {
              gameIconInput.value = icon == '' ? id : await resizeBase64Image(icon)
              refreshIcon()
            }, filePath, filePath)
          }, 'Choose an Icon', path)
        })
        
        inputListener('gameAdmin', (event) => { newAdmin = event.target.checked })  

        clickListener('gameShow', () => { shell.showItemInFolder(oldPathClean) })  

        clickListener('gameStore', () =>{
          loadModule('Store', oldName)
          closeDialog(dialogid)
        })
  
        clickListener('gameMove', () => { moveFiles(paths, dialogid) })
          
        clickListener('gameRemove', () => {
          document.getElementById('gameWindow').style.display = 'none'
          document.getElementById('removeTitle').innerHTML = `Remove '${oldName}'?`
          document.getElementById('removeWindow').style.display = 'flex'
        })
        
        clickListener('removeRemove', () => { removeFiles(paths, dialogid) })

        clickListener('removeCancel', () => {
          document.getElementById('gameWindow').style.display = 'flex'
          document.getElementById('removeWindow').style.display = 'none'
        })
      
        clickListener('gameSave', () => {
          //Get values
          const newName = gameNameInput.value.trim()
          const newPath = gamePathInput.value.trim()
          const newIcon = gameIconInput.value.trim()

          //Save values
          if (newName == oldName && newPath == oldPath && newIcon == oldIcon && newAdmin == oldAdmin) closeDialog(dialogid)

          //Missing values
          else if (newName == '') createNoti('Library', 'Name is necesary')
          else if (newName.includes('/')) createNoti('Library', "Forbidden character '/'")
          else if (newPath == '') createNoti('Library', 'Path is necesary')

          //Update values
          else {
            //Get name
            let item = getItem(filePath)
            if (item == undefined) {
              createNoti('Library', 'Error finding game')
              return
            }

            //Check if name exists
            if (newName != oldName) {
              //Get folder
              let folder = getItem(location)
              if (folder == undefined) {
                createNoti('Library', 'Error finding parent folder')
                return
              }

              //Check if game exists
              if (existsGameIn(newName, folder)) {
                createNoti('Library', `'${newName}' already exists`)
                return
              }
            }

            //Update game
            item.setAttribute('name', newName)
            item.setAttribute('path', newPath)
            item.setAttribute('icon', newIcon)
            item.setAttribute('admin', newAdmin)

            //Save file, close dialog & refresh list
            saveXML()
            closeDialog(dialogid)
            createList('refresh')
          }
        })
        
        //Refresh icon
        clickListener('gameImg', refreshIcon)

        function refreshIcon() {
          const icon = gameIconInput.value.trim()

          //Get icon to use
          let iconPath = icon
          if (icon == '') {
            const path = gamePathInput.value.trim()
            const pathInfo = getPathInfo(path)
            iconPath = pathInfo.pathClean
          }

          //Refresh icon
          getIcon((event, icon, id) => {
            if (id == filePath) document.getElementById('gameImg').src = icon
          }, iconPath, filePath)
        }
      }

      //Move & remove files
      function moveFiles(paths, dialogid) {
        //Update & show window
        createList('refresh')
        closeDialog(dialogid)
        if (paths.length > 1)
          document.getElementById('moveTitle').innerText = `Moving ${paths.length} items`
        else
          document.getElementById('moveTitle').innerText = `Moving ${paths.length} item`
        document.getElementById('moveWindow').style.pointerEvents = 'all'
        document.getElementById('moveWindow').style.opacity = '1'

        //Listeners
        clickListener('moveCancel', () => {
          document.getElementById('moveWindow').style.pointerEvents = 'none'
          document.getElementById('moveWindow').style.opacity = '0'
        })

        clickListener('moveMove', () => {
          let itemErrors = 0
          let lastError = ''

          //Destination folder
          let dest = getItem(libraryPath)
          if (dest == undefined) {
            createNoti('Library', 'Error finding destination folder')
            return
          }
          if (dest.tagName != 'library' && dest.tagName != 'folder') {
            createNoti('Library', 'Destination is not a folder')
            return
          }
          
          //Check if new folder is also being moved
          let items = []
          for (i in paths) {
            //Get item
            let item = getItem(paths[i])
            if (item == undefined) {
              lastError = 'Error finding item'
              itemErrors++
              continue
            }
            items.push(item)
            //Check if item contains destination
            if (item.contains(dest)) {
              lastError = 'Destination is being moved'
              itemErrors++
              continue
            }
          }

          //Move ヾ(•ω•`)o
          for (i2 in items) {
            let item = items[i2]

            //Check if item exists
            let name = item.getAttribute('name')
            if (item.tagName == 'folder' && existsFolderIn(name, dest)) {
              lastError = `'${name}' already exists`
              itemErrors++
              continue
            }
            if (item.tagName == 'game' && existsGameIn(name, dest)) {
              lastError = `'${name}' already exists`
              itemErrors++
              continue
            }

            //Move it
            dest.append(item)
          }

          //Errors
          if (itemErrors > 0) {
            if (itemErrors == 1) createNoti('Library', lastError)
            else createNoti('Library', `Errors: ${itemErrors}`)
          }

          //Save file, close dialog & refresh list
          saveXML()
          createList('refresh')
          document.getElementById('moveWindow').style.pointerEvents = 'none'
          document.getElementById('moveWindow').style.opacity = '0'
        })
      }
    
      function removeFiles(paths, dialogid) {
        //Remove items
        let itemsRemoved = 0
        for (i in paths) {
          let path = paths[i]
          let item = getItem(path)
          if (item != undefined) {
            item.remove()
            itemsRemoved++
          }
        }
        if (itemsRemoved < paths.length) createNoti('Library', `Errors: ${paths.length - itemsRemoved}`)

        //Save file, close dialog & refresh list
        saveXML()
        closeDialog(dialogid)
        createList('refresh')
      }
    })
  }

  //Info
  function saveXML() {
    //ty stackoverflow (✿◡‿◡)
    let formatted = '', indent= ''
    let tab = '\t'
    libraryXML.outerHTML.split(/>\s*</).forEach(node => {
      if (node.match( /^\/\w/ )) indent = indent.substring(tab.length)
      formatted += indent + '<' + node + '>\r\n'
      if (node.match( /^<?\w[^>]*[^\/]$/ )) indent += tab
    })

    //Save file
    fs.writeFileSync(libraryFile, formatted.substring(1, formatted.length-3))
  }

  function getItem(path) {
    //Get elemment type & parse path array
    let type = ''
    if (typeof path == 'string') {
      if (path.includes('://')) {
        type = path.substring(0, path.indexOf('://'))
        path = path.substring(type.length+3)
      }
      path = path.split('/')
    }
    if (!Array.isArray(path)) return

    //Get item
    let item = libraryXML
    for (i in path) {
      let goodKey = false
      let itemTmp = item
      let itemName = path[i]
      if (itemName == '') continue
      let itemElems = itemTmp.childNodes

      //Check if key is a folder
      for (i2 in itemElems) {
        let elem = itemElems[i2]
        if (typeof elem.tagName != 'string') continue
        if (path.length-1 == i && type != '' && elem.tagName != type) continue
        if (elem.getAttribute('name') == itemName) {
          goodKey = true
          itemTmp = elem
          break
        }
      }

      //Return if key is not a folder
      if (!goodKey) return

      //Update item
      item = itemTmp
    }
    return item
  }
  
  function existsGameIn(name, dest) {
    //Check if a game exists in a folder
    let olis = dest.childNodes
    for (i in olis) {
      let oli = olis[i]
      if (typeof oli.tagName != 'string') continue
      if (oli.tagName == 'game' && oli.getAttribute('name') == name) return true
    }
    return false
  }

  function existsFolderIn(name, dest) {
    //Check if a folder exists in another folder
    let olis = dest.childNodes
    for (i in olis) {
      let oli = olis[i]
      if (typeof oli.tagName != 'string') continue
      if (oli.tagName == 'folder' && oli.getAttribute('name') == name) return true
    }
    return false
  }

  function getPathInfo(path) {
    //Get information from a path
    let pathClean = path
    let pathArgs = []

    //Check for arguments in path
    try {
      if (pathClean.startsWith('"')) {
        //Remove first "
        pathClean = pathClean.substring(1)

        //Remove second "
        pathClean = pathClean.substring(0, pathClean.indexOf('"'))

        //Get args
        let args = path.substring(pathClean.length + 2).trim()
        pathArgs = args.split(' ')
      }
    } catch (e) {
      pathClean = path
      pathArgs = []
    }

    //Clear "" from path
    if (pathClean.startsWith('"') && pathClean.endsWith('"')) pathClean = pathClean.substring(1, pathClean.length - 1)

    //Relative path
    if (pathClean.startsWith('?:')) pathClean = orion.root.substring(0, 2) + pathClean.substring(2)

    //Return clean path & args
    return { pathClean, pathArgs }
  }
  
  function formatText(text) {
    return String(text)
            .replace(/&/g, '&amp;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
  }

  //Open
  function openFile(id, admin, name, pathClean, pathArgs) {
    if (!fs.existsSync(pathClean)) 
      //Path does not exist -> Open it in shell (works for things like urls)
      shell.openPath(pathClean)
    else {
      //Get path data
      const path = require('path')
      const p = path.parse(pathClean)
      let folder = p.dir
      let file = p.base

      //Open
      if (admin && pathClean.toLowerCase().endsWith('.exe')) {
        //As admin
        const wincmd = require('node-windows')
        const child = wincmd.elevate(`"${file}"`, pathArgs, { cwd: folder, detached: true, stdio: 'ignore' })
        child.unref()
      } else {
        //As admin't
        let cmnd = `start "" "${file}"`
        if (pathArgs.length > 0) cmnd = `start "" "${file}" ${pathArgs.join(' ')}`
        const exec = require('child_process').exec
        const child = exec(cmnd, { cwd: folder, detached: true, stdio: 'ignore' })
        child.unref()
      }
    }

    //Notify user
    createNoti('Library', name)
  }

  function openFolder(path) {
    if (document.getElementById('window').scrollTop == 0)
      //Load folder
      createList(path)
    else 
      //Scroll to the top & then load folder
      $("#window").animate({ scrollTop: 0 }, "fast", () => { createList(path) })
  }





   /*$       /$$             /$$                                                      
  | $$      |__/            | $$                                                      
  | $$       /$$  /$$$$$$$ /$$$$$$    /$$$$$$  /$$$$$$$   /$$$$$$   /$$$$$$   /$$$$$$$
  | $$      | $$ /$$_____/|_  $$_/   /$$__  $$| $$__  $$ /$$__  $$ /$$__  $$ /$$_____/
  | $$      | $$|  $$$$$$   | $$    | $$$$$$$$| $$  \ $$| $$$$$$$$| $$  \__/|  $$$$$$ 
  | $$      | $$ \____  $$  | $$ /$$| $$_____/| $$  | $$| $$_____/| $$       \____  $$
  | $$$$$$$$| $$ /$$$$$$$/  |  $$$$/|  $$$$$$$| $$  | $$|  $$$$$$$| $$       /$$$$$$$/
  |________/|__/|_______/    \___/   \_______/|__/  |__/ \_______/|__/      |______*/ 

  //Intent
  onIntent((event, data) => { createList(data) })

  //Update icons
  function requestedIcon(event, icon, id) {
    const element = document.getElementById(id)
    if (element != null) element.src = icon 
  }

  //Add
  clickListener('libraryAdd', () => {
    //Create dialog
    const dialogid = createDialog(fs.readFileSync(cModule.path + 'Menus/add.html').toString(), 'Add games & folders')

    //Dialog listeners
    clickListener('folder', () => {
      renameDialog(dialogid, 'Add Folder')
      document.getElementById('addWindow').style.display = 'none'
      document.getElementById('folderWindow').style.display = 'flex'

      //Inputs
      const folderNameInput = document.getElementById('folderNameInput')
      const folderIconInput = document.getElementById('folderIconInput')

      //Folder listeners
      clickListener('righticon-folderIcon', (event) => {
        event.stopPropagation()

        //Get path info
        const gamePathArg = getPathInfo(folderIconInput.value)
        const path = gamePathArg.pathClean.substring(0, gamePathArg.pathClean.lastIndexOf('\\') + 1)

        //Request file
        getFile((event, filePath) => {
          if (filePath == '') return
          getIconBase64(async (event, icon, id) => {
            if (icon == '') {
              folderIconInput.value = id
            } else {
              const result = await resizeBase64Image(icon)
              folderIconInput.value = result
            }
            refreshIcon()
          }, filePath, filePath)
        }, 'Choose an Icon', path)
      })

      clickListener('folderImg', refreshIcon)

      function refreshIcon() {
        getIcon((event, icon, id) => {
          document.getElementById('folderImg').src = icon
        }, folderIconInput.value.trim())
      }
      
      clickListener('folderAdd', () => {
        let name = folderNameInput.value.trim()
        let icon = folderIconInput.value.trim()
        if (name == '') {
          createNoti('Library', 'Name is necesary')
          return
        }

        //Destination folder
        let dest = getItem(libraryPath)
        if (dest == undefined) {
          createNoti('Library', 'Error finding destination folder')
          return
        }
        if (dest.tagName != 'library' && dest.tagName != 'folder') {
          createNoti('Library', 'Destination is not a folder')
          return
        }

        //Check if folder exists
        if (existsFolderIn(name, dest)) {
          createNoti('Library', `'${name}' already exists`)
          return
        }

        //Add folder
        dest.insertAdjacentHTML('beforeend', `<folder name="${formatText(name)}" icon="${formatText(icon)}"/>`)

        //Save file, close dialog & refresh list
        saveXML()
        closeDialog(dialogid)
        createList('refresh')
      })
    })
  
    clickListener('game', () => {
      renameDialog(dialogid, 'Add Game')
      document.getElementById('addWindow').style.display = 'none'
      document.getElementById('gameWindow').style.display = 'flex'
      
      //Inputs
      const gameNameInput = document.getElementById('gameNameInput')
      const gamePathInput = document.getElementById('gamePathInput')
      const gameIconInput = document.getElementById('gameIconInput')

      //Game listeners
      clickListener('righticon-gamePath', (event) => {
        event.stopPropagation()

        //Get path info
        const gamePathArg = getPathInfo(gamePathInput.value)
        const path = gamePathArg.pathClean.substring(0, gamePathArg.pathClean.lastIndexOf('\\') + 1)

        //Request file
        getFile((event, filePath) => {
          if (filePath == '') return
          
          //Relative path
          if (filePath.startsWith(orion.root.substring(0, 3))) filePath = '?:\\' + filePath.substring(3, filePath.length);
          
          //Update input value
          gamePathInput.value = filePath
          if (gameNameInput.value == '') {
            let name = filePath.substring(filePath.lastIndexOf('\\')+1)
            if (name.includes('.')) name = name.substring(0, name.lastIndexOf('.'))
            gameNameInput.value = name
          }
          refreshIcon()
        }, 'Choose a Game', path)
      })
      
      clickListener('righticon-gameIcon', (event) => {
        event.stopPropagation()

        //Get path info
        let tmp = gamePathInput.value
        if (gameIconInput.value != '') tmp = gameIconInput.value
        const gamePathArg = getPathInfo(tmp)
        const path = gamePathArg.pathClean.substring(0, gamePathArg.pathClean.lastIndexOf('\\') + 1)

        //Request file
        getFile((event, filePath) => {
          if (filePath == '') return
          getIconBase64(async (event, icon, id) => {
            if (icon == '') {
              gameIconInput.value = id
            } else {
              const result = await resizeBase64Image(icon)
              gameIconInput.value = result
            }
            refreshIcon()
          }, filePath, filePath)
        }, 'Choose an Icon', path)
      })

      clickListener('gameImg', refreshIcon)

      function refreshIcon() {
        const icon = gameIconInput.value.trim()
        
        //Refresh icon
        getIcon((event, icon, id) => {
          document.getElementById('gameImg').src = icon
        }, (icon != '' ? icon :  gamePathInput.value.trim()))
      }
      
      clickListener('gameAdd', () => {
        //Get info
        let name = gameNameInput.value.trim()
        if (name == '') {
          createNoti('Library', 'Name is necesary')
          return
        }
        let path = gamePathInput.value.trim()
        if (path == '') {
          createNoti('Library', 'Path is necesary')
          return
        }
        let icon = gameIconInput.value.trim()

        //XML Destination folder
        let dest = getItem(libraryPath)
        if (dest == undefined) {
          createNoti('Library', 'Error finding destination folder')
          return
        }
        if (dest.tagName != 'library' && dest.tagName != 'folder') {
          createNoti('Library', 'Destination is not a folder')
          return
        }

        //Check if game exists
        if (existsGameIn(name, dest)) {
          createNoti('Library', `'${name}' already exists`)
          return
        }

        //Add game
        dest.insertAdjacentHTML('beforeend', `<game name="${formatText(name)}" path="${formatText(path)}" icon="${formatText(icon)}"/>`)

        //Save file, close dialog & refresh list
        saveXML()
        closeDialog(dialogid)
        createList('refresh') 
      })
    })

    clickListener('import', (event) => {
      getFolder((event, folderPath) => {
        if (folderPath == '') return
        pauseAssistant()

        //Get shortcuts from folder
        let files = readdirSync(folderPath)
        let shortcuts = []
        for(i in files) {
          let f = files[i].toLowerCase()
          if (f.endsWith('.lnk') || f.endsWith('.url') || f.endsWith('.json')) {
            shortcuts.push(files[i])
          }
        }
        if (shortcuts.length == 0) {
          createNoti('Library', 'Nothing to import')
          resumeAssistant()
          return
        }

        //Create list
        for(i in shortcuts) {
          let id = 'short'+i
          let short = shortcuts[i]
          let name = short.substring(short.lastIndexOf('\\')+1)
          if (name.includes('.')) name = name.substring(0, name.lastIndexOf('.'))
          document.getElementById('importList').insertAdjacentHTML('beforeend', `<o-button id="${id}" text="${name}" style="width: 100%;"></o-button>`)
          clickListener(id, () => {
            let index = shortcuts.indexOf(short)
            if (index == -1) return
            shortcuts.splice(index, 1)
            document.getElementById(id).remove()
            if (shortcuts.length == 0) closeDialog(dialogid)
          })
        }

        //Show import window
        renameDialog(dialogid, 'Import')
        document.getElementById('addWindow').style.display = 'none'
        document.getElementById('importWindow').style.display = 'flex'
        resumeAssistant()

        //Add import listener
        clickListener('importImport', () => {
          let itemErrors = 0
          let lastError = ''

          //Destination folder
          let destinationFolder = getItem(libraryPath)
          if (destinationFolder == undefined) {
            createNoti('Library', 'Error finding destination folder')
            return
          }
          if (destinationFolder.tagName != 'library' && destinationFolder.tagName != 'folder') {
            createNoti('Library', 'Destination is not a folder')
            console.log(destinationFolder.tagName)
            return
          }

          //Pause assistant while importing
          pauseAssistant()
          renameDialog(dialogid, 'Importing...')

          //Import shortcuts
          for(i in shortcuts) {
            //Get shortcut
            let shortcut = shortcuts[i]

            //Get name (with folders relative to selected included)
            let name = shortcut.substring(folderPath.length + 1)
            name = name.substring(0, name.lastIndexOf('.'))
            
            //Check if game & folders exist
            let existsError = false
            let destNew = Array.from(libraryPath)
            let destFinal = destinationFolder     //The folder where all the shortcuts will be placed
            let pathTmp = name.split('\\')        //Path of the shortcut starting on current folder in library
            for (i2 in pathTmp) {
              let nam = pathTmp[i2]
              if (i2 != pathTmp.length - 1) {
                //Folder does not exist -> Create it
                if (!existsFolderIn(nam, destFinal)) destFinal.insertAdjacentHTML('beforeend', `<folder name="${formatText(nam)}"/>`)
                destNew.push(nam)
                destFinal = getItem(destNew)
                if (destFinal == undefined) {
                  existsError = true
                  break
                }
              } else {
                if (existsGameIn(nam, destFinal)) {
                  //Game exists
                  existsError = true
                  break
                }
                name = nam
              }
            }

            //Error check
            if (existsError) {
              itemErrors++
              continue
            }

            //Get shortcut data
            let path = ''
            let icon = ''
            let admin = ''
            switch (shortcut.toLowerCase().substring(shortcut.lastIndexOf('.'))) {
              case '.lnk':
                //Windows shortcut (LNK)
                try {
                  let short = shell.readShortcutLink(shortcut)
                  path = short.target
                  if (short.args != '') path = `"${path}" ${short.args}`
                  icon = short.icon
                  if (path == icon) icon = ''
                } catch(e) {}
                break
              case '.url':
                //URL shortcut (URL)
                let shdata = fs.readFileSync(shortcut).toString().split('\r\n')
                for (i2 in shdata) {
                  let str = shdata[i2]
                  if (str.startsWith('URL=')) path = str.substring(4)
                  if (str.startsWith('IconFile=')) icon = str.substring(9)
                }
                break
              case '.json':
                //Old assistant JSON library game (JSON)
                try {
                  let sisData = JSON.parse(fs.readFileSync(shortcut))
                  if (sisData.path != undefined) path = sisData.path
                  if (sisData.icon != undefined) icon = sisData.icon
                  if (sisData.admin != undefined) admin = sisData.admin
                } catch(e) {}
                break
            }

            //Check data for errors
            if (typeof path != 'string' || path == '') {
              itemErrors++
              continue
            }
            if (typeof icon != 'string') icon = ''

            //Add game
            destFinal.insertAdjacentHTML('beforeend', `<game name="${formatText(name)}" path="${formatText(path)}" icon="${formatText(icon)}" admin="${formatText(admin)}"/>`)
          }

          //Notify error count
          if (itemErrors > 0) createNoti('Library', `Errors: ${itemErrors}`)

          //Save file, close dialog & refresh list
          saveXML()
          resumeAssistant()
          closeDialog(dialogid)
          createList('refresh')
        })
      }, 'Folder to import shortcuts from')
    
      //Recursive reddir
      const fs = require('fs')
      const path = require('path')

      const readdirSync = (p, a = []) => {
        if (fs.statSync(p).isDirectory())
          fs.readdirSync(p).map(f => readdirSync(a[a.push(path.join(p, f)) - 1], a))
        return a
      }
    })
  })

  //Search
  clickListener('righticon-librarySearch', (event) => {
    event.stopPropagation()

    //Search
    let search = document.getElementById('librarySearchInput').value
    if (search == '') return
    createList('refresh', search)
  })

  keydownListener('librarySearchInput', (event) => {
    if (event.which != 13) return
    event.preventDefault()
    
    //Search
    let search = document.getElementById('librarySearchInput').value
    if (search == '') return
    createList('refresh', search)
  })





    /*$$$$$                  /$$          
   /$$__  $$                | $$          
  | $$  \__/  /$$$$$$   /$$$$$$$  /$$$$$$ 
  | $$       /$$__  $$ /$$__  $$ /$$__  $$
  | $$      | $$  \ $$| $$  | $$| $$$$$$$$
  | $$    $$| $$  | $$| $$  | $$| $$_____/
  |  $$$$$$/|  $$$$$$/|  $$$$$$$|  $$$$$$$
   \______/  \______/  \_______/ \______*/

  //Show scrollbar
  document.getElementById('window').style.overflowY = 'scroll'

  //Library XML
  if (!fs.existsSync(libraryFile)) {
    //Missing library file -> Create a new one
    libraryXML = document.createElement('library')
    saveXML()
  } else {
    //Read library file
    libraryXML = new DOMParser().parseFromString(fs.readFileSync(libraryFile), 'text/xml').getElementsByTagName('library')[0]
  }
</script>