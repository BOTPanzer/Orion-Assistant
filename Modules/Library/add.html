<div class="vc" style="width: 100%;">
  <div class="vc" id="addDiv" style="width: 100%; margin-top: 20px; margin-bottom: 20px; align-items: center;">
    <div class="hc">
      <div id="folder" class="button buttonText" style="width: 130px; min-width: 130px; height: 40px; min-height: 40px;">Add Folder</div>
      <div id="game" class="button buttonText" style="width: 130px; min-width: 130px; height: 40px; min-height: 40px; margin-left: 10px;">Add Game</div>
    </div>
    <div id="import" class="button buttonText" style="width: 130px; min-width: 130px; height: 40px; min-height: 40px; margin-top: 10px;">Import</div>
  </div>

  <div class="vc" id="folderDiv" style="width: 100%; margin-top: 20px; margin-bottom: 20px; display: none;">
    <div class="hc" style="width: calc(100% - 40px); padding-left: 20px; padding-right: 20px;">
      <div class="button hc" style="flex-grow: 1;">
        <input id='nameTextFolder' class="input" type="text" spellcheck="false" placeholder="Name" maxlength="30" style="flex-grow: 1; "></input>
      </div>
    </div>
    
    <div class="hc" style="width: 100%; margin-top: 20px; align-items: center;">
      <div id="addFolder" class="button buttonText" style="width: 130px; min-width: 130px; height: 40px; min-height: 40px; margin-left: 20px; margin-right: 10px;">Add Folder</div>
      <div id="logFolder" style="margin-left: auto; margin-right: 20px; font-size: 15px; line-height: 15px;  display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; align-items: center; color: var(--textPrimary); font-family: Main;"></div>
    </div>
  </div>

  <div class="vc" id="gameDiv" style="width: 100%; margin-top: 20px; margin-bottom: 20px; display: none;">
    <div class="hc" style="width: calc(100% - 40px); padding-left: 20px; padding-right: 20px;">
      <div class="button hc" style="flex-grow: 1;">
        <input id='nameTextGame' class="input" type="text" spellcheck="false" placeholder="Name" maxlength="30" style="flex-grow: 1;"></input>
      </div>
    </div>

    <div class="hc" style="width: calc(100% - 40px); margin-top: 20px; padding-left: 20px; padding-right: 20px;">
      <div class="button hc" style="flex-grow: 1; margin-right: 10px;">
        <input id='pathTextGame' class="input" type="text"  spellcheck="false" placeholder="Path"style="flex-grow: 1;"></input>
      </div>
      <div id="folderGame" class="button" style="width: 40px; min-width: 40px; height: 40px; min-height: 40px;">
        <svg class="buttonSVG" viewBox="0 0 24 24" style="fill: #f0bd23;">
          <path d="M21.0169 7.99175C21.4148 8.55833 20.9405 9.25 20.2482 9.25H3C2.44772 9.25 2 8.80228 2 8.25V6.42C2 3.98 3.98 2 6.42 2H8.74C10.37 2 10.88 2.53 11.53 3.4L12.93 5.26C13.24 5.67 13.28 5.72 13.86 5.72H16.65C18.4546 5.72 20.0516 6.61709 21.0169 7.99175Z"/>
          <path d="M20.9834 10.75C21.5343 10.75 21.9815 11.1957 21.9834 11.7466L22 16.6503C22 19.6003 19.6 22.0003 16.65 22.0003H7.35C4.4 22.0003 2 19.6003 2 16.6503V11.7503C2 11.198 2.44771 10.7503 2.99999 10.7503L20.9834 10.75Z"/>
        </svg>
      </div>
    </div>

    <div class="hc" style="width: calc(100% - 40px); margin-top: 20px; padding-left: 20px; padding-right: 20px;">
      <div class="button hc" style="flex-grow: 1; margin-right: 10px;">
        <input id='iconTextGame' class="input" type="text" spellcheck="false" placeholder="Icon Path (Optional)" style="flex-grow: 1;"></input>
      </div>
      <div id="folderIconGame" class="button" style="width: 40px; min-width: 40px; height: 40px; min-height: 40px;">
        <svg class="buttonSVG" viewBox="0 0 24 24" style="fill: #f0bd23;">
          <path d="M21.0169 7.99175C21.4148 8.55833 20.9405 9.25 20.2482 9.25H3C2.44772 9.25 2 8.80228 2 8.25V6.42C2 3.98 3.98 2 6.42 2H8.74C10.37 2 10.88 2.53 11.53 3.4L12.93 5.26C13.24 5.67 13.28 5.72 13.86 5.72H16.65C18.4546 5.72 20.0516 6.61709 21.0169 7.99175Z"/>
          <path d="M20.9834 10.75C21.5343 10.75 21.9815 11.1957 21.9834 11.7466L22 16.6503C22 19.6003 19.6 22.0003 16.65 22.0003H7.35C4.4 22.0003 2 19.6003 2 16.6503V11.7503C2 11.198 2.44771 10.7503 2.99999 10.7503L20.9834 10.75Z"/>
        </svg>
      </div>
    </div>
    
    <div class="hc" style="width: 100%; margin-top: 20px; align-items: center;">
      <div id="addGame" class="button buttonText" style="width: 130px; min-width: 130px; height: 40px; min-height: 40px; margin-left: 20px; margin-right: 10px;">Add Game</div>
      <div id="logGame" style="margin-left: auto; margin-right: 20px; font-size: 15px; line-height: 15px;  display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; align-items: center; color: var(--textPrimary); font-family: Main;"></div>
    </div>
  </div>
</div>

<script>
  refreshData()
  let actualPath = json.actualPath
  //OTHER
  let importMax = 0
  let imported = 0
  
  document.getElementById('nameDisplay').innerText = 'Oriøn: Add'

  addButtonListener('folder', function() {
    document.getElementById('nameDisplay').innerText = 'Oriøn: Add Folder'
    document.getElementById('addDiv').style.display = 'none'
    document.getElementById('folderDiv').style.display = 'flex'
    win.setResizable(true)
    win.setSize(390, 160)
    win.setResizable(false)
    win.center()
  })
  
  addButtonListener('game', function() {
    document.getElementById('nameDisplay').innerText = 'Oriøn: Add Game'
    document.getElementById('addDiv').style.display = 'none'
    document.getElementById('gameDiv').style.display = 'flex'
    win.setResizable(true)
    win.setSize(390, 280)
    win.setResizable(false)
    win.center()
  })

  addButtonListener('addFolder', function() {
    let name = document.getElementById('nameTextFolder').value
    if (name == '') {
      document.getElementById('logFolder').innerText = 'Name Is Necesary'
      return
    }
      
    let fullName = actualPath+name.trim()
    if (!fs.existsSync(fullName)) {
      fs.mkdirSync(fullName)
      document.getElementById('logFolder').innerText = `"${name}" Added`
      closeWindow(actualPath)
    } else document.getElementById('logFolder').innerText = `"${name}" Already Exists`
  })

  addButtonListener('addGame', function() {
    let name = document.getElementById('nameTextGame').value
    if (name == '') {
      document.getElementById('logGame').innerText = 'Name Is Necesary'
      return
    }
    let path = document.getElementById('pathTextGame').value
    if (path == '') {
      document.getElementById('logGame').innerText = 'Path Is Necesary'
      return
    }
    let icon = document.getElementById('iconTextGame').value

    createGame(name, path, icon, false)
  })
  
  addButtonListener('import', function() {
    ipcRenderer.send('getFolder', '', 'Folder to Import Shortcuts From', 'importFolderGotten')
  })
  
  ipcRenderer.on('importFolderGotten', (event, path) => {
    if (path == '') return
    document.getElementById('nameDisplay').innerText = 'Oriøn: Add - Importing...'
    document.getElementById('wall').style.display = 'block'
    var recursive = require("recursive-readdir")
    recursive(path, function (err, files) {
      if (err) closeWindow()
      //GET NUMBER OF SHORTCUTS TO IMPORT
      for(i in files) {
        if (files[i].toLowerCase().endsWith('.lnk') || files[i].toLowerCase().endsWith('.url')) 
          importMax++
      }
      if (importMax == 0) closeWindow()
      //IMPORT SHORTCUTS
      var ws = require('windows-shortcuts')
      for(i in files) {
        let shortcut = files[i]
        if (shortcut.toLowerCase().endsWith('.lnk')) {
          //LNK
          ws.query(shortcut, createShortcut)
          function createShortcut(a, options) {
            let name = shortcut.substring(path.length)
            name = name.substring(0, name.length-4)
            let target = options.target
            let icon = options.icon
            console.log(target)
            createGame(name, target, icon, true)
          }
        } else if (shortcut.toLowerCase().endsWith('.url')) {
          //URL
          importClose()
        }
      }
    })
  })

  function createGame(name, path, icon, importing) {
    let fullName = actualPath+name.trim()+'.txt'
    let data = path
    if (icon != '') data = path+'\n'+icon
    if (!fs.existsSync(fullName)) {
      console.log(name)
      if (name.includes('\\')) {
        //MAKE FOLDER
        fs.mkdir(fullName.substring(0, fullName.lastIndexOf('\\')), { recursive: true }, (err) => {
          fs.writeFile(fullName, data, (err) => {
            if (!importing) {
              document.getElementById('logGame').innerText = `"${name}" Added`
              closeWindow(actualPath)
            } else {
              importClose()
            }
          })
        })
      } else {
        //DONT MAKE FOLDER
        fs.writeFile(fullName, data, (err) => {
          if (!importing) {
            document.getElementById('logGame').innerText = `"${name}" Added`
            closeWindow(actualPath)
          } else importClose()
        })
      }
    } else {
      if (!importing) document.getElementById('logGame').innerText = `"${name}" Already Exists`
      else importClose()
    }
  }

  function importClose() {
    imported++
    if (importMax == imported) {
      closeWindow(actualPath)
    }
  }

  addButtonListener('folderGame', function() {
    let a = document.getElementById('pathTextGame').value
    let gamePathArg = getPathInfo(a)
    let path = gamePathArg.pathClean.substring(0, gamePathArg.pathClean.lastIndexOf('\\')+1)
    ipcRenderer.send('getFile', path, 'Choose a Game', 'fileGotten')
  })

  ipcRenderer.on('fileGotten', (event, path) => {
    if (path != '')
      document.getElementById('pathTextGame').value = path
    if (document.getElementById('nameTextGame').value == '')
      document.getElementById('nameTextGame').value = path.substring(path.lastIndexOf('\\')+1)
  })
  
  addButtonListener('folderIconGame', function() {
    let a = document.getElementById('pathTextGame').value
    if (document.getElementById('iconTextGame').value != '') a = document.getElementById('iconTextGame').value
    let gamePathArg = getPathInfo(a)
    let path = gamePathArg.pathClean.substring(0, gamePathArg.pathClean.lastIndexOf('\\')+1)
    ipcRenderer.send('getFile', path, 'Choose an Icon', 'fileGottenIcon')
  })

  ipcRenderer.on('fileGottenIcon', (event, path) => {
    if (path != '')
      document.getElementById('iconTextGame').value = path
  })

  function getPathInfo(gamePath) {
    gamePath = gamePath.trim()
    let pathClean = gamePath
    let argsClean = ''
    if (gamePath.includes('--') && gamePath.includes(' ') && !gamePath.endsWith('"')) {
      if (gamePath.startsWith('"') ) {
        pathClean = gamePath.substring(1, gamePath.lastIndexOf('"'))
        let args = gamePath.substring(pathClean.length+2).trim()
        argsClean = args.split(' ')
        argsClean.unshift("/c", pathClean)
      } else {
        pathClean = gamePath.substring(0, gamePath.lastIndexOf(' '))
        let args = gamePath.substring(pathClean.length+2).trim()
        argsClean = args.split(' ')
        argsClean.unshift("/c", pathClean)
      }
    }
    let data = {pathClean, argsClean}
    return data
  }
</script>