<div class="vc" style="width: 100%;">
  <div class="hc" style="width: calc(100% - 40px); margin-top: 20px; padding-left: 20px; padding-right: 20px;">
    <div class="button hc" style="flex-grow: 1; margin-right: 10px;">
      <input id='nameText' class="input" type="text" spellcheck="false" placeholder="Name" maxlength="30" style="flex-grow: 1;"></input>
    </div>
    <img id="img" style="height: 40px; width: 40px; border-radius: 5px; filter: drop-shadow(var(--shadow)); object-fit: contain;" src="Data/Images/iconFile.png"></img>
  </div>

  <div class="hc" style="width: calc(100% - 40px); margin-top: 20px; padding-left: 20px; padding-right: 20px;">
    <div class="button hc" style="flex-grow: 1; margin-right: 10px;">
      <input id='pathText' class="input" type="text" spellcheck="false" placeholder="Path" style="flex-grow: 1;"></input>
    </div>
    <div id="folder" class="button" style="width: 40px; min-width: 40px; height: 40px; min-height: 40px;">
      <svg class="buttonSVG" viewBox="0 0 24 24" style="fill: #f0bd23;">
        <path d="M21.0169 7.99175C21.4148 8.55833 20.9405 9.25 20.2482 9.25H3C2.44772 9.25 2 8.80228 2 8.25V6.42C2 3.98 3.98 2 6.42 2H8.74C10.37 2 10.88 2.53 11.53 3.4L12.93 5.26C13.24 5.67 13.28 5.72 13.86 5.72H16.65C18.4546 5.72 20.0516 6.61709 21.0169 7.99175Z"/>
        <path d="M20.9834 10.75C21.5343 10.75 21.9815 11.1957 21.9834 11.7466L22 16.6503C22 19.6003 19.6 22.0003 16.65 22.0003H7.35C4.4 22.0003 2 19.6003 2 16.6503V11.7503C2 11.198 2.44771 10.7503 2.99999 10.7503L20.9834 10.75Z"/>
      </svg>
    </div>
  </div>

  <div class="hc" style="width: calc(100% - 40px); margin-top: 20px; padding-left: 20px; padding-right: 20px;">
    <div class="button hc" style="flex-grow: 1; margin-right: 10px;">
      <input id='iconText' class="input" type="text" spellcheck="false" placeholder="Icon Path (Optional)" style="flex-grow: 1;"></input>
    </div>
    <div id="folderIcon" class="button" style="width: 40px; min-width: 40px; height: 40px; min-height: 40px;">
      <svg class="buttonSVG" viewBox="0 0 24 24" style="fill: #f0bd23;">
        <path d="M21.0169 7.99175C21.4148 8.55833 20.9405 9.25 20.2482 9.25H3C2.44772 9.25 2 8.80228 2 8.25V6.42C2 3.98 3.98 2 6.42 2H8.74C10.37 2 10.88 2.53 11.53 3.4L12.93 5.26C13.24 5.67 13.28 5.72 13.86 5.72H16.65C18.4546 5.72 20.0516 6.61709 21.0169 7.99175Z"/>
        <path d="M20.9834 10.75C21.5343 10.75 21.9815 11.1957 21.9834 11.7466L22 16.6503C22 19.6003 19.6 22.0003 16.65 22.0003H7.35C4.4 22.0003 2 19.6003 2 16.6503V11.7503C2 11.198 2.44771 10.7503 2.99999 10.7503L20.9834 10.75Z"/>
      </svg>
    </div>
  </div>

  <div class="vc" style="width: 100%; margin-top: 20px; align-items: center;">
    <div class="hc">
      <div id="show" class="button buttonText" style="width: 130px; min-width: 130px; height: 40px; min-height: 40px; margin-right: 10px;">Show</div>
      <div id="showstore" class="button buttonText" style="width: 130px; min-width: 130px; height: 40px; min-height: 40px;">Store</div>
    </div>
    <div class="hc" style="margin-top: 10px;">
      <div id="move" class="button buttonText" style="width: 130px; min-width: 130px; height: 40px; min-height: 40px;">Move</div>
      <div id="remove" class="button buttonText" style="width: 130px; min-width: 130px; height: 40px; min-height: 40px; margin-left: 10px;">Remove</div>
    </div>
    <div class="hc" style="margin-top: 10px; padding-left: 20px; padding-right: 20px; align-items: center;">
      <div id="save" class="button buttonText" style="width: 130px; min-width: 130px; height: 40px; min-height: 40px;;">Save</div>
      <div id="log" style="margin-left: 20px; font-size: 15px; line-height: 15px; display: none; -webkit-line-clamp: 2; -webkit-box-orient: vertical; align-items: center; color: var(--textPrimary); font-family: Main;"></div>
    </div>
  </div>
</div>

<script>
  refreshData()
  let actualPath = json.actualPath
  //FILE PATH
  let filePath = specialData.path
  let fileInfo = getFileInfo(filePath, false)
  //NAME
  let oldName = fileInfo.name
  //PATH
  let oldPath = fileInfo.gamePath
  let filePathInfo = getPathInfo(oldPath)
  let showPath = filePathInfo.pathClean
  let showPathFixed = showPath
  if (showPathFixed.startsWith('?:')) showPathFixed = showPathFixed.replace('?:', data.root.substring(0, 2))
  //ICON PATH
  let oldIcon = fileInfo.iconPath
  if (oldIcon == undefined) oldIcon = ''

  //TITLE
  document.getElementById('nameDisplay').innerText = 'Oriøn: Game Properties'
  //NAME
  document.getElementById('nameText').value = oldName
  //IMAGE
  document.getElementById('img').src = specialData.src
  if (oldIcon == '') ipcRenderer.send('requestIcon', 'img', showPathFixed, filePath)
  else if (fs.existsSync(oldIcon) && fs.statSync(oldIcon).isFile()) ipcRenderer.send('requestIcon', 'img', oldIcon, filePath)
  //PATH
  document.getElementById('pathText').value = oldPath
  if (showPath.startsWith('?:')) showPath = showPath.replace('?:', filePath.substring(0, 2))
  if (!fs.existsSync(showPath)) document.getElementById('show').style.display = 'none'
  //ICON PATH
  document.getElementById('iconText').value = oldIcon
  
  //LISTENERS
  ipcRenderer.on('changeIcon', (event, img, icon, argPath) => {
    if (filePath == argPath) document.getElementById(img).src = icon
  })

  addButtonListener('folder', function() {
    let a = document.getElementById('pathText').value
    let gamePathArg = getPathInfo(a)
    let path = gamePathArg.pathClean.substring(0, gamePathArg.pathClean.lastIndexOf('\\')+1)
    ipcRenderer.send('getFile', path, 'Choose a Game', 'fileGotten')
  })

  ipcRenderer.on('fileGotten', (event, path) => {
    if (path != '')
      document.getElementById('pathText').value = path
    if (document.getElementById('nameText').value == '')
      document.getElementById('nameText').value = path.substring(path.lastIndexOf('\\')+1)
    //REFRESH ICON
    let icon = document.getElementById('iconText').value
    if (icon == '') icon = document.getElementById('pathText').value
    if (fs.existsSync(icon) && fs.statSync(icon).isFile()) ipcRenderer.send('requestIcon', 'img', icon, filePath)
    else document.getElementById(img).src = 'Data/Images/iconFile.png'
  })
  
  addButtonListener('folderIcon', function() {
    let a = document.getElementById('iconText').value
    if (a == '') a = document.getElementById('pathText').value
    let iconPathInfo = getPathInfo(a)
    let path = iconPathInfo.pathClean.substring(0, iconPathInfo.pathClean.lastIndexOf('\\')+1)
    ipcRenderer.send('getFile', path, 'Choose an Icon', 'fileGottenIcon')
  })

  ipcRenderer.on('fileGottenIcon', (event, path) => {
    if (path == '') return
    document.getElementById('iconText').value = path
    //REFRESH ICON
    if (fs.existsSync(path) && fs.statSync(path).isFile()) ipcRenderer.send('requestIcon', 'img', path, filePath)
    else document.getElementById(img).src = 'Data/Images/iconFile.png'
  })

  addButtonListener('show', function() {
    ipcRenderer.send('showOnExplorer', showPath, true)
  })
  
  addButtonListener('showstore', function() {
    ipcRenderer.send('resume')
    ipcRenderer.send('loadModule', 'Store', document.getElementById('nameText').value)
    closeWindow()
  })
  
  addButtonListener('move', function() {
    ipcRenderer.send('getFolder', actualPath, 'Choose a Folder', 'movePaths')
  })
  
  addButtonListener('remove', function() {
    let paths = [filePath]
    showRemoveWindow(paths)
  })

  addButtonListener('save', function() {
    let newName = document.getElementById('nameText').value
    let newPath = document.getElementById('pathText').value
    let newIcon = document.getElementById('iconText').value
    saveFile(newName, newPath, newIcon)
  })

  //MOVE FILE
  ipcRenderer.on('movePaths', (event, newFilePath) => {
    let paths = [filePath]
    newFilePath = newFilePath+'\\'
    if (!newFilePath.includes(specialData.launcherFolder)) return

    //CHECK IF NEW FOLDER IS ALSO BEING MOVED
    let posibleToMove = true
    for (i in paths) {
      if (newFilePath.includes(paths[i]))
      posibleToMove = false
    }

    //IF NOT MOVE ヾ(•ω•`)o
    if (posibleToMove) for (i in paths) {
      let path = paths[i]
      if (fs.existsSync(path)) {
        let oldFilePath = path
        if (path.endsWith('\\')) oldFilePath = path.slice(0,-1)
        let name = oldFilePath.substring(oldFilePath.lastIndexOf('\\')+1)
        fs.rename(path, newFilePath+name, function(err) { if (i == paths.length-1) closeWindow(actualPath) })
      } else if (i == paths.length-1) closeWindow(actualPath)
    }
  })

  //SAVE FILE
  function saveFile(newName, newPath, newIcon) {
    if (newName == oldName && newPath == oldPath && newIcon == oldIcon) {
      closeWindow()
    } else if (newName == '') {
      document.getElementById('log').innerText = 'Name Is Necesary'
      document.getElementById('log').style.display = '-webkit-box'
    } else if (newPath == '') {
      document.getElementById('log').innerText = 'Path Is Necesary'
      document.getElementById('log').style.display = '-webkit-box'
    } else if (fs.existsSync(filePath)) {
      let newFilePath = actualPath+newName+'.txt'
      if (newName != oldName && fs.existsSync(newFilePath)) {
        document.getElementById('log').innerText = 'File Already Exists'
        document.getElementById('log').style.display = '-webkit-box'
      } else fs.writeFile(filePath, newPath+'\n'+newIcon, (err) => {
        if (newName != oldName) fs.rename(filePath, newFilePath, function(err) { closeWindow(actualPath) })
        else closeWindow(actualPath)
      })
    }
  }

  //FUNCTIONS
  function getFileInfo(argPath, fixed) {
    if (fixed == undefined) fixed = true
    let path = argPath
    if (path.endsWith('\\')) path = path.slice(0,-1)
    //isFile
    let isFile = false
    if (fs.statSync(argPath).isFile()) isFile = true
    //Name
    let name = argPath.substring(argPath.lastIndexOf("\\")+1)
    if (name.includes('.')) name = name.substring(0, name.lastIndexOf('.'))
    //File Stuff
    if (isFile) {
      let si = fs.readFileSync(argPath).toString().trim().split('\n')
      //Path
      let gamePath = si[0]
      if (gamePath != undefined) {
        gamePath = gamePath.replaceAll('\r', '')
        if (gamePath.startsWith('?:') && fixed) gamePath = gamePath.replace('?:', data.root.substring(0, 2))
      }
      //Icon
      let iconPath = si[1]
      if (iconPath != undefined) {
        iconPath = iconPath.replaceAll('\r', '')
      }
      let data = {isFile, name, gamePath, iconPath}
      return data
    } else {
      let data = {isFile, name}
      return data
    }
  }

  function getPathInfo(gamePath) {
    gamePath = gamePath.trim()
    let pathClean = gamePath
    let argsClean = ''
    if (gamePath.includes('--') && gamePath.includes(' ') && !gamePath.endsWith('"')) {
      if (gamePath.startsWith('"') ) {
        pathClean = gamePath.substring(1, gamePath.lastIndexOf('"'))
        let args = gamePath.substring(pathClean.length+2).trim()
        argsClean = args.split(' ')
        argsClean.unshift("/c", pathClean)
      } else {
        pathClean = gamePath.substring(0, gamePath.lastIndexOf(' '))
        let args = gamePath.substring(pathClean.length+2).trim()
        argsClean = args.split(' ')
        argsClean.unshift("/c", pathClean)
      }
    }
    let data = {pathClean, argsClean}
    return data
  }
</script>