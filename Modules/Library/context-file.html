<div class="vc" style="width: 100%;">
  <div class="hc" style="width: calc(100% - 40px); margin-top: 20px; padding-left: 20px; padding-right: 20px;">
    <div class="button" style="flex-grow: 1; margin-right: 10px;">
      <input id='nameText' class="input" type="text" spellcheck="false" placeholder="Name" maxlength="30" style="flex-grow: 1;"></input>
    </div>
    <img id="img" style="height: 40px; width: 40px; border-radius: 5px; filter: drop-shadow(var(--shadow)); object-fit: contain;" src="Data/Images/iconFile.png"></img>
  </div>

  <div class="hc" style="width: calc(100% - 40px); margin-top: 20px; padding-left: 20px; padding-right: 20px;">
    <div class="button" style="flex-grow: 1; margin-right: 10px;">
      <input id='pathText' class="input" type="text" spellcheck="false" placeholder="Path" style="flex-grow: 1;"></input>
    </div>
    <div id="folder" class="button" style="width: 40px; min-width: 40px; height: 40px; min-height: 40px;">
      <svg class="svg" viewBox="0 0 24 24" style="fill: #f0bd23;">
        <path d="M21.0169 7.99175C21.4148 8.55833 20.9405 9.25 20.2482 9.25H3C2.44772 9.25 2 8.80228 2 8.25V6.42C2 3.98 3.98 2 6.42 2H8.74C10.37 2 10.88 2.53 11.53 3.4L12.93 5.26C13.24 5.67 13.28 5.72 13.86 5.72H16.65C18.4546 5.72 20.0516 6.61709 21.0169 7.99175Z"/>
        <path d="M20.9834 10.75C21.5343 10.75 21.9815 11.1957 21.9834 11.7466L22 16.6503C22 19.6003 19.6 22.0003 16.65 22.0003H7.35C4.4 22.0003 2 19.6003 2 16.6503V11.7503C2 11.198 2.44771 10.7503 2.99999 10.7503L20.9834 10.75Z"/>
      </svg>
    </div>
  </div>

  <div class="hc" style="width: calc(100% - 40px); margin-top: 20px; padding-left: 20px; padding-right: 20px;">
    <div class="button" style="flex-grow: 1; margin-right: 10px;">
      <input id='iconText' class="input" type="text" spellcheck="false" placeholder="Base64 Icon/Icon Path (Optional)" style="flex-grow: 1;"></input>
    </div>
    <div id="folderIcon" class="button" style="width: 40px; min-width: 40px; height: 40px; min-height: 40px;">
      <svg class="svg" viewBox="0 0 24 24" style="fill: #f0bd23;">
        <path d="M21.0169 7.99175C21.4148 8.55833 20.9405 9.25 20.2482 9.25H3C2.44772 9.25 2 8.80228 2 8.25V6.42C2 3.98 3.98 2 6.42 2H8.74C10.37 2 10.88 2.53 11.53 3.4L12.93 5.26C13.24 5.67 13.28 5.72 13.86 5.72H16.65C18.4546 5.72 20.0516 6.61709 21.0169 7.99175Z"/>
        <path d="M20.9834 10.75C21.5343 10.75 21.9815 11.1957 21.9834 11.7466L22 16.6503C22 19.6003 19.6 22.0003 16.65 22.0003H7.35C4.4 22.0003 2 19.6003 2 16.6503V11.7503C2 11.198 2.44771 10.7503 2.99999 10.7503L20.9834 10.75Z"/>
      </svg>
    </div>
  </div>

  <div class="vc" style="width: 100%; margin-top: 20px; align-items: center;">
    <div class="hc" style="gap: 10px;">
      <div id="show" class="button text" style="width: 130px; min-width: 130px; height: 40px; min-height: 40px; flex-direction: column;">Show</div>
      <div id="showstore" class="button text" style="width: 130px; min-width: 130px; height: 40px; min-height: 40px; flex-direction: column;">Store</div>
    </div>
    <div class="hc" style="margin-top: 10px; gap: 10px;">
      <div id="move" class="button text" style="width: 130px; min-width: 130px; height: 40px; min-height: 40px; flex-direction: column;">Move</div>
      <div id="remove" class="button text" style="width: 130px; min-width: 130px; height: 40px; min-height: 40px; flex-direction: column;">Remove</div>
    </div>
    <div class="hc" style="margin-top: 10px; padding-left: 20px; padding-right: 20px; align-items: center;">
      <div id="save" class="button text" style="width: 130px; min-width: 130px; height: 40px; min-height: 40px; flex-direction: column;">Save</div>
      <div id="log" style="margin-left: 20px; font-size: 15px; line-height: 15px; display: none; -webkit-line-clamp: 2; -webkit-box-orient: vertical; align-items: center; color: var(--textPrimary); font-family: Main;"></div>
    </div>
  </div>
</div>

<script>
  let actualPath = json.actualPath
  let filePath = specialData.path
  let fileInfo = getFileInfo(filePath)
  let oldName = fileInfo.name
  let oldPath = fileInfo.path
  let oldPathClean = fileInfo.pathClean
  let oldPathFix = fileInfo.pathCleanFix
  let oldIcon = fileInfo.icon

  document.getElementById('nameDisplay').innerText = 'Game Properties'
  //NAME & PATH
  document.getElementById('nameText').value = oldName
  document.getElementById('pathText').value = oldPath
  if (!fs.existsSync(oldPathClean)) document.getElementById('show').style.display = 'none'
  //ICON
  document.getElementById('iconText').value = oldIcon
  document.getElementById('img').src = specialData.src
  refreshIcon()
  
  //LISTENERS
  ipcRenderer.on('requestedIcon', (event, img, icon, tag) => {
    if (icon == '') return
    if (tag == filePath)
      document.getElementById(img).src = icon
  })

  addButtonListener('folder', function() {
    let value = document.getElementById('pathText').value
    let pathInfo = getPathInfo(value)
    let path = pathInfo.pathCleanFix.substring(0, pathInfo.pathCleanFix.lastIndexOf('\\')+1)
    ipcRenderer.send('getFile', path, 'Choose a Game', 'requestedFile')
  })

  ipcRenderer.on('requestedFile', (event, path) => {
    if (path != '')
      document.getElementById('pathText').value = path
    if (document.getElementById('nameText').value == '')
      document.getElementById('nameText').value = path.substring(path.lastIndexOf('\\')+1)
    refreshIcon()
  })
  
  addButtonListener('folderIcon', function() {
    let value = document.getElementById('iconText').value
    if (value == '') value = document.getElementById('pathText').value
    let pathInfo = getPathInfo(value)
    let path = pathInfo.pathCleanFix.substring(0, pathInfo.pathCleanFix.lastIndexOf('\\')+1)
    ipcRenderer.send('getFile', path, 'Choose an Icon', 'requestedFileIcon')
  })

  ipcRenderer.on('requestedFileIcon', (event, path) => {
    if (path == '') return
    ipcRenderer.send('requestBase64', path, filePath)
  })

  ipcRenderer.on('requestedBase64', async function(event, base64, tag) {
    if (base64 == '') return
    const result = await resizeBase64Image(base64)
    document.getElementById('iconText').value = result
    refreshIcon()
  })

  addButtonListener('show', function() {
    ipcRenderer.send('showOnExplorer', oldPathClean, true)
  })
  
  addButtonListener('showstore', function() {
    ipcRenderer.send('resume')
    ipcRenderer.send('loadModule', 'Store', document.getElementById('nameText').value)
    closeWindow()
  })
  
  addButtonListener('move', function() {
    ipcRenderer.send('getFolder', actualPath, 'Choose a Folder', 'movePaths')
  })
  
  addButtonListener('remove', function() {
    let paths = [filePath]
    showRemoveWindow(paths)
  })

  addButtonListener('save', function() {
    let newName = document.getElementById('nameText').value
    let newPath = document.getElementById('pathText').value
    let newIcon = document.getElementById('iconText').value
    saveFile(newName, newPath, newIcon)
  })

  //REFRESH ICON
  function refreshIcon() {
    document.getElementById('img').src = 'Data/Images/iconFile.png'

    let icon = document.getElementById('iconText').value
    let path = document.getElementById('pathText').value
    if (icon != '')
      ipcRenderer.send('requestIcon', 'img', icon, filePath)
    else if (path != '')
      ipcRenderer.send('requestIcon', 'img', path, filePath)
  }

  //MOVE FILE
  ipcRenderer.on('movePaths', (event, newFilePath) => {
    let paths = [filePath]
    newFilePath = newFilePath+'\\'
    if (!newFilePath.includes(specialData.libraryFolder)) return

    //CHECK IF NEW FOLDER IS ALSO BEING MOVED
    let posibleToMove = true
    for (i in paths) {
      if (newFilePath.includes(paths[i]))
      posibleToMove = false
    }

    //IF NOT MOVE ヾ(•ω•`)o
    if (posibleToMove) for (i in paths) {
      let path = paths[i]
      if (fs.existsSync(path)) {
        let oldFilePath = path
        if (path.endsWith('\\')) oldFilePath = path.slice(0,-1)
        let name = oldFilePath.substring(oldFilePath.lastIndexOf('\\')+1)
        fs.rename(path, newFilePath+name, function(err) { if (i == paths.length-1) closeWindow(actualPath) })
      } else if (i == paths.length-1) closeWindow(actualPath)
    }
  })

  //SAVE FILE
  function saveFile(newName, newPath, newIcon) {
    if (newName == oldName && newPath == oldPath && newIcon == oldIcon) {
      closeWindow()
      return
    }
    if (newName == '') {
      document.getElementById('log').innerText = 'Name Is Necesary'
      document.getElementById('log').style.display = '-webkit-box'
      return
    }
    if (newPath == '') {
      document.getElementById('log').innerText = 'Path Is Necesary'
      document.getElementById('log').style.display = '-webkit-box'
      return
    }
    if (fs.existsSync(filePath)) {
      let newFilePath = filePath.substring(0, filePath.lastIndexOf('\\')+1)+newName.trim()+'.json'
      if (newName != oldName && fs.existsSync(newFilePath)) {
        document.getElementById('log').innerText = 'File Already Exists'
        document.getElementById('log').style.display = '-webkit-box'
        return
      }
      let data = {}
      data.path = newPath
      data.icon = newIcon
      fs.writeFile(filePath, JSON.stringify(data), (err) => {
        if (newName != oldName) fs.rename(filePath, newFilePath, function(err) { closeWindow(actualPath) })
        else closeWindow(actualPath)
      })
    }
  }

  //GET FILE INFO
  function getFileInfo(filePath) {
    if (!fs.existsSync(filePath)) return
    //NAME
    let name = filePath.substring(filePath.lastIndexOf("\\")+1)
    if (name.includes('.')) name = name.substring(0, name.lastIndexOf('.'))
    //IS FOLDER OR FILE
    let isFile = false
    if (fs.statSync(filePath).isFile()) isFile = true
    if (!isFile)
      //IS FOLDER
      return {isFile, name}
    else try {
      //IS FILE
      const data = JSON.parse(fs.readFileSync(filePath))
      const path = data.path
      const icon = data.icon
      const pathInfo = getPathInfo(path)
      const pathClean = pathInfo.pathClean
      const pathCleanFix = pathInfo.pathCleanFix
      const pathArgs = pathInfo.pathArgs
      return {isFile, name, path, pathClean, pathCleanFix, pathArgs, icon}
    } catch (e) {
      //ISN'T A JSON
      return undefined
    }
  }

  function getPathInfo(path) {
    let pathClean = path
    let pathCleanFix = ''
    let pathArgs = ''
    try {
      if (path.includes('--') && path.includes(' ') && !path.endsWith('"')) {
        if (path.startsWith('"'))
          pathClean = path.substring(1, path.lastIndexOf('"'))
        else 
          pathClean = path.substring(0, path.lastIndexOf(' '))
        let args = path.substring(pathClean.length+2).trim()
        pathArgs = args.split(' ')
        pathArgs.unshift("/c", pathClean)
      }
      if (pathClean.startsWith('"') && pathClean.endsWith('"')) pathClean = pathClean.substring(1, pathClean.length-1)
      pathCleanFix = pathClean
      if (pathClean.startsWith('?:')) pathCleanFix = data.root.substring(0, 2)+pathClean.substring(2)
    } catch (e) {}
    return {pathClean, pathCleanFix, pathArgs}
  }
</script>