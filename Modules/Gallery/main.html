<div class="win-c">
  <div class="win-t">
    <div class="title">Gallery</div>

    <div style="flex-grow: 1;"></div>

    <div class="hc" style="align-items: center;">  
      <span>Status: </span>
      <div id="galleryIsLoaded" style="width: 20px; height: 20px; margin-left: 10px; border-radius: 10px; background: var(--danger);"></div>
    </div>
  </div>

  <div class="vc" style="gap: 20px;">
    <div id="albumsList" class="vc" style="gap: 20px;">

    </div>
    <o-button id="albumsAdd" text="Add album" lefticon="Modules/Gallery/Icons/add.svg"></o-button>
  </div>
</div>





<script>
   /*$    /$$
  | $$   | $$
  | $$   | $$ /$$$$$$   /$$$$$$   /$$$$$$$
  |  $$ / $$/|____  $$ /$$__  $$ /$$_____/
   \  $$ $$/  /$$$$$$$| $$  \__/|  $$$$$$
    \  $$$/  /$$__  $$| $$       \____  $$
     \  $/  |  $$$$$$$| $$       /$$$$$$$/
      \_/    \_______/|__/      |______*/

  //Get albums paths
  var paths = settings.get('paths')
  if (!Array.isArray(paths)) {
    paths = [
      {
        images: '',
        metadata: ''
      }
    ]
    settings.set('paths', paths)
  }

  //Create albums HTML elements
  var albumsList = document.getElementById('albumsList')
  createAlbumsList()


   /*$$$$$$$                              /$$     /$$
  | $$_____/                             | $$    |__/
  | $$    /$$   /$$ /$$$$$$$   /$$$$$$$ /$$$$$$   /$$  /$$$$$$  /$$$$$$$   /$$$$$$$
  | $$$$$| $$  | $$| $$__  $$ /$$_____/|_  $$_/  | $$ /$$__  $$| $$__  $$ /$$_____/
  | $$__/| $$  | $$| $$  \ $$| $$        | $$    | $$| $$  \ $$| $$  \ $$|  $$$$$$
  | $$   | $$  | $$| $$  | $$| $$        | $$ /$$| $$| $$  | $$| $$  | $$ \____  $$
  | $$   |  $$$$$$/| $$  | $$|  $$$$$$$  |  $$$$/| $$|  $$$$$$/| $$  | $$ /$$$$$$$/
  |__/    \______/ |__/  |__/ \_______/   \___/  |__/ \______/ |__/  |__/|______*/
  
  function createAlbumsList() {
    //Crear list & add new elements
    albumsHTML = ''
    for (let i = 0; i < paths.length; i++) {
      //Get index & album
      const index = i
      const album = paths[index]
      
      //Add HTML
      const albumHTML = `
        <div class="vc" style="gap: 10px;">
          <div class="hc" style="gap: 10px; align-items: center;">
            <o-button id="album${index}-delete" lefticon="Modules/Gallery/Icons/trash.svg"></o-button>
            <span>Album ${index}</span>
          </div>
          <div class="hc" style="width: 100%; gap: 10px;">
            <o-button id="album${index}-images-container" size="big" text nofilter righticon="Modules/Gallery/Icons/folder.svg" style="width: 100%;">
              <o-input id="album${index}-images" hint="Images folder path" label="Images" transparent style="flex-grow: 1;" value="${album.images}"></o-input>
            </o-button>
            <o-button id="album${index}-metadata-container" size="big" text nofilter righticon="Modules/Gallery/Icons/folder.svg" style="width: 100%;">
              <o-input id="album${index}-metadata" hint="Metadata file path (JSON)" label="Metadata" transparent style="flex-grow: 1;" value="${album.metadata}"></o-input>
            </o-button>
          </div>
        </div>
      `
      albumsHTML += albumHTML
    }
    albumsList.innerHTML = albumsHTML

    //Add listeners
    for (let i = 0; i < paths.length; i++) {
      //Get index & album
      const index = i
      const album = paths[index]
      
      //Add listeners
      clickListener(`album${index}-delete`, (event) => {
        paths.splice(index, 1)
        settings.set('paths', paths)
        createAlbumsList()
      })
      inputListener(`album${index}-images`, (event) => {
        album.images = event.target.value
        settings.set('paths', paths)
      })
      clickListener(`righticon-album${index}-images-container`, (event) => {
        event.stopPropagation()
        getFolder((event, folder, id) => {
          //Invalid folder
          if (!folder) return 

          //Save folder
          document.getElementById(`album${index}-images`).value = folder
          album.images = folder
          settings.set('paths', paths)

        }, 'Choose an album images folder')
      })
      inputListener(`album${index}-metadata`, (event) => {
        album.metadata = event.target.value
        settings.set('paths', paths)
      })
      clickListener(`righticon-album${index}-metadata-container`, (event) => {
        event.stopPropagation()
        getFile((event, file, id) => {
          //Invalid file
          if (!file) return 
          if (!file.toLowerCase().endsWith('.json')) {
            createNoti('Gallery', 'File must be a JSON')
            return 
          }

          //Save file
          document.getElementById(`album${index}-metadata`).value = file
          album.metadata = file
          settings.set('paths', paths)

        }, 'Choose a metadata file')
      })
    }
  }
  
  function loadAlbums() {
    //Require path for joining folders with files
    const path = require('path')

    //Clear albums
    gallery.app.albums = []
    const extensions = ['png', 'jpg', 'jpeg', 'webp']

    //Read albums files
    for (let i = 0; i < paths.length; i++) {
      //Get album & paths
      const album = paths[i]
      const images = album.images
      const metadata = album.metadata
      
      //Check if images folder exists
      if (!fs.existsSync(images) || !fs.lstatSync(images).isDirectory()) {
        console.log('Album ' + i + ' images folder does not exist')
        return
      }

      //Read folders & sort files
      files = fs.readdirSync(images)
        //Filter images only
        .filter(fileName => fileName.includes('.') && extensions.includes(fileName.substring(fileName.lastIndexOf('.') + 1).toLowerCase()))
        //Sort by last modified
        .map(fileName => ({
          name: fileName,
          time: fs.statSync(path.join(images, fileName)).mtime.getTime(),
        }))
        .sort((a, b) => b.time - a.time) //Reverse so that last modified image is first
        .map(file => file.name)
      
      //Save files
      gallery.app.albums.push(files)
    }
  }

  function backupAlbums() {
    //Start backup
    if (gallery.app.backing) return
    gallery.app.backing = true

    //Load albums just in case
    loadAlbums()

    //Different albums size -> End backup
    if (gallery.app.albums.length != gallery.client.albums.length) {
      console.log('Albums are not the same size')
      gallery.app.backing = false
      return
    }

    //Require path for joining folders with files
    const path = require('path')
    
    //Clear missing files
    gallery.app.missing = []

    //Check albums
    for (let i = 0; i < paths.length; i++) {
      //Get app images folder
      const imagesFolder = paths[i].images
      if (!fs.existsSync(imagesFolder) || !fs.lstatSync(imagesFolder).isDirectory()) {
        console.log('Album ' + i + ' images folder does not exist')
        continue
      }

      //Get both albums
      const appAlbum = gallery.app.albums[i]
      const clientAlbum = gallery.client.albums[i]

      //Check for images to delete
      for (let j = appAlbum.length - 1; j >= 0; j--) {
        const imageName = appAlbum[j]
        if (clientAlbum.includes(imageName)) continue
        
        //Delete file
        console.log('Deleted file found: ' + imageName)
        fs.unlinkSync(path.join(imagesFolder, imageName))
      }
      
      //Check for images that are missing
      for (let j = clientAlbum.length - 1; j >= 0; j--) {
        const imageName = clientAlbum[j]
        if (appAlbum.includes(imageName)) continue

        //Add to missing files
        console.log('Missing file found: ' + imageName)
        gallery.app.missing.push({
          albumIndex: i,
          imageIndex: j,
        })
      }
    }

    //Request missing files
    requestNextMissingFile()
  }
  
  function requestNextMissingFile() {
    //Get next index
    const nextIndex = gallery.app.missing.length - 1

    //No missing files -> Finish backup
    if (nextIndex < 0) {
      console.log('Finished backup')
      gallery.app.backing = false
      return
    }

    //Request next
    const next = gallery.app.missing[nextIndex]
    galleryRequestImage(next.albumIndex, next.imageIndex, (data) => {
      //Require path for joining folders with files
      const path = require('path')
      
      //Get request
      const request = gallery.app.request

      //Image data received -> Parse info & save file
      const fileName = gallery.client.albums[request.albumIndex][request.imageIndex]
      const filePath = path.join(paths[request.albumIndex].images, fileName)
      const lastModified = new Date(request.lastModified)

      //Save file
      fs.writeFileSync(filePath, data)
      fs.utimesSync(filePath, lastModified, lastModified)
      console.log("Image received: " + fileName)

      //Remove element
      gallery.app.missing.splice(nextIndex, 1)

      //Call next
      requestNextMissingFile()
    })
  }


   /*$       /$$             /$$                                                      
  | $$      |__/            | $$                                                      
  | $$       /$$  /$$$$$$$ /$$$$$$    /$$$$$$  /$$$$$$$   /$$$$$$   /$$$$$$   /$$$$$$$
  | $$      | $$ /$$_____/|_  $$_/   /$$__  $$| $$__  $$ /$$__  $$ /$$__  $$ /$$_____/
  | $$      | $$|  $$$$$$   | $$    | $$$$$$$$| $$  \ $$| $$$$$$$$| $$  \__/|  $$$$$$ 
  | $$      | $$ \____  $$  | $$ /$$| $$_____/| $$  | $$| $$_____/| $$       \____  $$
  | $$$$$$$$| $$ /$$$$$$$/  |  $$$$/|  $$$$$$$| $$  | $$|  $$$$$$$| $$       /$$$$$$$/
  |________/|__/|_______/    \___/   \_______/|__/  |__/ \_______/|__/      |______*/ 

  clickListener('albumsAdd', (event) => {
    //Add new empty album
    paths.push({
      images: '',
      metadata: ''
    })
    settings.set('paths', paths)

    //Reload list
    createAlbumsList()
  })


    /*$$$$$                  /$$          
   /$$__  $$                | $$          
  | $$  \__/  /$$$$$$   /$$$$$$$  /$$$$$$ 
  | $$       /$$__  $$ /$$__  $$ /$$__  $$
  | $$      | $$  \ $$| $$  | $$| $$$$$$$$
  | $$    $$| $$  | $$| $$  | $$| $$_____/
  |  $$$$$$/|  $$$$$$/|  $$$$$$$|  $$$$$$$
   \______/  \______/  \_______/ \______*/

  galleryUpdateIsLoaded()
</script>